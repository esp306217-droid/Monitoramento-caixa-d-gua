<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-adapter-date-fns/dist/chartjs-plugin-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.min.js"></script>

<script>
// URL base do seu Firebase
const firebaseURL = 'https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/leituras.json';

// Função principal que carrega os dados históricos
async function carregarHistorico() {
    try {
        // 1. Calcula o timestamp de 2 dias atrás
        const doisDiasAtras = Date.now() - (2 * 24 * 60 * 60 * 1000);

        // 2. Monta a URL com orderBy e startAt
        const queryURL = `${firebaseURL}?orderBy=%22timestamp%22&startAt=${doisDiasAtras}`;
        const response = await fetch(queryURL);

        if (!response.ok) {
            console.error("Erro ao buscar dados do Firebase.");
            return;
        }

        const leituras = await response.json();

        // Limpa os dados antigos do gráfico
        chart.data.labels = [];
        chart.data.datasets[0].data = [];

        if (leituras && Object.keys(leituras).length > 0) {
            let ultimaLeitura = null;

            // 3. Adiciona cada leitura ao gráfico
            Object.values(leituras).forEach(leitura => {
                chart.data.labels.push(new Date(leitura.timestamp));
                chart.data.datasets[0].data.push(leitura.nivel);
                ultimaLeitura = leitura;
            });

            // 4. Atualiza a parte visual com a última leitura
            if (ultimaLeitura) {
                atualizarVisualizacao(ultimaLeitura.nivel, ultimaLeitura.altura);
            }

            chart.update('none');
        } else {
            console.warn("Nenhum dado encontrado no período consultado.");
        }

    } catch (e) {
        console.error("Erro ao processar dados: ", e);
    }
}

// Função para atualizar a parte visual
function atualizarVisualizacao(nivel, altura) {
    const nivelElem = document.getElementById('nivel');
    const alturaElem = document.getElementById('altura');
    const aguaDiv = document.getElementById('agua');

    if (!nivelElem || !alturaElem || !aguaDiv) return;

    nivelElem.innerText = nivel ?? 0;
    alturaElem.innerText = (altura ?? 0).toFixed(1);

    aguaDiv.style.height = `${nivel}%`;
    aguaDiv.innerText = `${nivel}%`;

    if (nivel > 60) {
        aguaDiv.style.background = 'linear-gradient(to top, #00ffcc, #1e90ff)';
        aguaDiv.style.color = 'white';
    } else if (nivel > 20) {
        aguaDiv.style.background = 'linear-gradient(to top, #ffff66, #ffcc00)';
        aguaDiv.style.color = 'black';
    } else {
        aguaDiv.style.background = 'linear-gradient(to top, #ff3333, #990000)';
        aguaDiv.style.color = 'white';
    }
}

// Configuração do gráfico
const ctx = document.getElementById('grafico').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Nível da água (%)',
            data: [],
            backgroundColor: 'rgba(0,255,255,0.2)',
            borderColor: 'rgba(0,255,255,1)',
            borderWidth: 1.5,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
        }]
    },
    options: {
        responsive: true,
        scales: {  
            y: { 
                min: 0, 
                max: 100, 
                title: { display: true, text: '% Nível' }, 
                ticks: { color: '#000' } 
            },
            x: { 
                type: 'time',
                time: {
                    unit: 'hour',
                    displayFormats: { hour: 'HH:mm' },
                    tooltipFormat: 'dd/MM/yyyy HH:mm:ss'
                },
                ticks: { color: '#000' } 
            }
        },
        plugins: {
            legend: { labels: { color: '#000' } },
            zoom: {
                pan: { enabled: true, mode: 'x' },
                zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
            }
        }
    }
});

// Atualiza o histórico a cada 30 segundos
setInterval(carregarHistorico, 30000); 
// Carrega o histórico na abertura da página
carregarHistorico();
</script>

