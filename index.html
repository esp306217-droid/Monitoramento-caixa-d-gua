<script>
const firebaseURL = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7.json";

let historicoNiveis = [];
let historicoLabels = [];

async function atualizar() {
    try {
        const r = await fetch(firebaseURL);
        const j = await r.json();
        const nivel = j.nivel_pct || 0;
        const altura = j.altura_cm || 0;

        document.getElementById('nivel').innerText = nivel;
        document.getElementById('altura').innerText = altura.toFixed(1);

        const aguaDiv = document.getElementById('agua');
        aguaDiv.style.height = nivel + '%';
        aguaDiv.innerText = nivel + '%';

        if(nivel>60) {aguaDiv.style.background='linear-gradient(to top, #00ffcc, #1e90ff)'; aguaDiv.style.color='white';}
        else if(nivel>20) {aguaDiv.style.background='linear-gradient(to top, #ffff66, #ffcc00)'; aguaDiv.style.color='black';}
        else {aguaDiv.style.background='linear-gradient(to top, #ff3333, #990000)'; aguaDiv.style.color='white';}

        const verde=document.getElementById('ledVerde');
        const amarelo=document.getElementById('ledAmarelo');
        const vermelho=document.getElementById('ledVermelho');
        verde.classList.remove('acesso'); amarelo.classList.remove('acesso'); vermelho.classList.remove('acesso');
        if(nivel>60) verde.classList.add('acesso'); 
        else if(nivel>20) amarelo.classList.add('acesso');
        else vermelho.classList.add('acesso');

        // Atualiza histórico para o gráfico
        if(historicoNiveis.length >= 50){ 
            historicoNiveis.shift(); 
            historicoLabels.shift();
        }
        historicoNiveis.push(nivel);
        historicoLabels.push(new Date().toLocaleTimeString());

        chart.data.labels = historicoLabels;
        chart.data.datasets[0].data = historicoNiveis;
        chart.update();

    } catch(e){ console.error(e); }
}

setInterval(atualizar,5000);
atualizar();

const ctx = document.getElementById('grafico').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Nível da água (%)',
            data: [],
            backgroundColor: 'rgba(0,255,255,0.2)',
            borderColor: 'rgba(0,255,255,1)',
            borderWidth: 2,
            fill: true,
            tension:0.4,
            pointRadius: 4,
            pointBackgroundColor: 'cyan'
        }]
    },
    options: {
        responsive:true,
        animation: {duration:300},
        scales: { 
            y: { min:0, max:100, title: {display:true, text:'% Nível', color:'#000'}, ticks: {color:'#000'} },
            x: { ticks: {color:'#000'} }
        },
        plugins: {
            legend: { labels: {color:'#000'} }
        }
    }
});
</script>



