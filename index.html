<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<title>Monitoramento Via Cristais - Central</title>

<!-- Fontes e Ícones -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* --- ESTILO GERAL DO DASHBOARD --- */
:root {
    --bg-body: #f0f2f5;
    --text-main: #1e293b;
    --text-sec: #64748b;
    --card-bg: rgba(255, 255, 255, 0.95);
    --card-border: rgba(226, 232, 240, 0.8);
    --accent: #06b6d4; 
    --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    
    --level-ok: #10b981;
    --level-warn: #f59e0b;
    --level-danger: #ef4444;
    --level-offline: #94a3b8;
}

[data-theme="dark"] {
    --bg-body: #0f172a;
    --text-main: #f1f5f9;
    --text-sec: #94a3b8;
    --card-bg: rgba(30, 41, 59, 0.85);
    --card-border: rgba(255, 255, 255, 0.1);
    --accent: #22d3ee;
    --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-body);
    background-image: radial-gradient(at 0% 0%, hsla(192,70%,80%,0.05) 0, transparent 50%), radial-gradient(at 100% 100%, hsla(200,80%,80%,0.05) 0, transparent 50%);
    color: var(--text-main);
    margin: 0; padding: 20px;
    transition: background-color 0.3s ease;
}

/* Header */
.header { text-align: center; margin-bottom: 40px; position: relative; }
.logo { width: 160px; mix-blend-mode: multiply; margin-bottom: 10px; }
[data-theme="dark"] .logo { filter: invert(1) hue-rotate(180deg) brightness(2) contrast(1.2); mix-blend-mode: screen; }
h1 { font-size: 1.2rem; color: var(--text-sec); margin: 0; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

/* Botão Tema Dashboard */
.theme-toggle {
    position: absolute; top: 0; right: 0;
    background: var(--card-bg); border: 1px solid var(--card-border);
    color: var(--text-main); width: 40px; height: 40px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
    cursor: pointer; box-shadow: var(--shadow-card);
}

/* Grid */
.section-title {
    font-size: 1.1rem; font-weight: 700; color: var(--text-main);
    margin: 30px 0 15px 5px; border-left: 5px solid var(--accent); padding-left: 10px;
}
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    max-width: 1200px; margin: 0 auto;
}

/* Card */
.card {
    background: var(--card-bg); border: 1px solid var(--card-border);
    border-radius: 16px; padding: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: var(--shadow-card); cursor: pointer;
    text-decoration: none; position: relative; overflow: hidden;
    transition: transform 0.2s; min-height: 150px;
}
.card:active { transform: scale(0.96); }
.card.inactive { opacity: 0.6; filter: grayscale(1); cursor: default; pointer-events: none; }

/* Fundo Animado de Água */
.card-water-bg {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
    background: linear-gradient(to top, rgba(6,182,212,0.2), rgba(6,182,212,0.5));
    transition: height 0.5s ease-out; z-index: 0;
}

/* Conteúdo do Card */
.card-content {
    position: relative; z-index: 1; padding: 20px 15px;
    width: 100%; display: flex; flex-direction: column; align-items: center;
}

/* Barra Lateral Status */
.card::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
    background: var(--level-offline); transition: background 0.3s; z-index: 2;
}
.card[data-status="ok"]::before { background: var(--level-ok); }
.card[data-status="warn"]::before { background: var(--level-warn); }
.card[data-status="danger"]::before { background: var(--level-danger); }
.card[data-status="simulated"]::before { background: #d97706; } /* Cor Laranja Escuro para Estimado */

/* Ícone e Texto */
.card-icon { font-size: 2rem; color: var(--text-sec); margin-bottom: 10px; }
.card-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 5px; }
.card-level { font-size: 1.5rem; font-weight: 800; color: var(--text-sec); }
.card-status { font-size: 0.75rem; color: var(--text-sec); margin-top: 5px; }

/* Indicador de Leitura Estimada no Card */
.simulated-badge {
    position: absolute; top: 10px; left: 10px; 
    background: #d97706; color: white; border-radius: 50%; width: 22px; height: 22px;
    font-size: 14px; display: none; align-items: center; justify-content: center; font-weight: bold; z-index: 2;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.card[data-status="simulated"] .simulated-badge { display: flex; }

/* Animação Online */
.live-dot {
    position: absolute; top: 10px; right: 10px; width: 10px; height: 10px;
    background: var(--level-ok); border-radius: 50%; box-shadow: 0 0 5px var(--level-ok);
    display: none; animation: pulse 2s infinite; z-index: 2;
}
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

/* --- IFRAME FULLSCREEN --- */
#app-overlay {
    display: none;
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 9999;
}
#app-overlay.active { display: block; }
#app-frame { width: 100%; height: 100%; border: none; }

/* --- ESTILO ADICIONADO: POPUP DE MANUTENÇÃO --- */
#maintenance-popup {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center; z-index: 30000;
}
.m-box {
    background: var(--card-bg); border: 4px solid #d4af37; border-radius: 24px;
    padding: 40px 30px; max-width: 500px; width: 90%; text-align: center;
    box-shadow: 0 0 30px rgba(212, 175, 55, 0.4); animation: m-fade-in 0.5s ease;
}
@keyframes m-fade-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.m-icon-anim {
    font-size: 4rem; color: #d4af37; margin-bottom: 20px;
    display: inline-block; animation: m-gear 3s infinite linear;
}
@keyframes m-gear { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.m-title { font-weight: 700; font-size: 1.5rem; margin-bottom: 15px; color: var(--text-main); }
.m-desc { color: var(--text-sec); line-height: 1.6; margin-bottom: 20px; font-size: 1.05rem; }
.m-warning { color: var(--text-main); font-size: 0.95rem; border-top: 1px solid rgba(212, 175, 55, 0.3); padding-top: 15px; }
.m-btn {
    margin-top: 25px; background: #d4af37; color: #fff; border: none;
    padding: 12px 40px; border-radius: 50px; font-weight: 700; cursor: pointer;
    transition: all 0.3s; font-family: 'Poppins', sans-serif;
}
.m-btn:hover { background: #b8952e; transform: translateY(-2px); }
</style>
</head>
<body>

<!-- POP-UP DE MANUTENÇÃO -->
<div id="maintenance-popup">
    <div class="m-box">
        <div class="m-icon-anim"><i class="fas fa-cog"></i></div>
        <div class="m-title">Aplicativo em manutenção</div>
        <p class="m-desc">Estamos implantando as demais caixas d'água para melhorar nosso monitoramento.</p>
        <div class="m-warning">
            <strong>FAVOR DESCONSIDERAR POSSÍVEIS ALARMES E ENVIOS DE EMAILS COM 0%.</strong>
        </div>
        <button class="m-btn" onclick="document.getElementById('maintenance-popup').style.display='none'">Entendido</button>
    </div>
</div>

<!-- DASHBOARD VISÍVEL INICIALMENTE -->
<div id="dashboard-container">
    <div class="header">
        <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
        <img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
        <h1>Central de Monitoramento</h1>
    </div>

    <div class="section-title">Praças de Pedágio</div>
    <div class="grid" id="grid-pp"></div>

    <div class="section-title">Bases SAU</div>
    <div class="grid" id="grid-sau"></div>
</div>

<!-- OVERLAY PARA EXIBIR OS APPS ORIGINAIS -->
<div id="app-overlay">
    <iframe id="app-frame" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
</div>

<!-- ========================================================================= -->
<!-- TEMPLATE UNIVERSAL ÚNICO (Para TODAS as Caixas)                            -->
<!-- Este código é injetado no iframe, substituindo as variáveis __VARS__       -->
<!-- ========================================================================= -->
<textarea id="app-template" style="display:none;">
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<title>__APP_TITLE__</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js">
function gerarLabels24h() {
    const labels = [];
    for (let h = 0; h < 24; h++) {
        labels.push(String(h).padStart(2, '0') + ':00');
    }
    return labels;
}

const CAPACIDADE_TOTAL = 8000; // litros
const LITROS_POR_PORCENTO = CAPACIDADE_TOTAL / 100;

function calcularConsumoPercentual(nivelAnterior, nivelAtual) {
    if (nivelAnterior === null || nivelAtual === null) return 0;
    const diffPct = nivelAnterior - nivelAtual;
    if (diffPct <= 0) return 0;
    return Math.round(diffPct * LITROS_POR_PORCENTO);
}

function filtrarAbastecimentosPorPeriodo(abastecimentos, inicio, fim) {
    return abastecimentos.filter(a => a.timestamp >= inicio && a.timestamp <= fim);
}

async function salvarAbastecimento(litros) {
    const payload = {
        litros: Number(litros),
        timestamp: Date.now()
    };

    await fetch(`${FIREBASE_BASE}/abastecimentos.json`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
        },
        body: JSON.stringify(payload)
    });
}

</script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js">
function gerarLabels24h() {
    const labels = [];
    for (let h = 0; h < 24; h++) {
        labels.push(String(h).padStart(2, '0') + ':00');
    }
    return labels;
}

const CAPACIDADE_TOTAL = 8000; // litros
const LITROS_POR_PORCENTO = CAPACIDADE_TOTAL / 100;

function calcularConsumoPercentual(nivelAnterior, nivelAtual) {
    if (nivelAnterior === null || nivelAtual === null) return 0;
    const diffPct = nivelAnterior - nivelAtual;
    if (diffPct <= 0) return 0;
    return Math.round(diffPct * LITROS_POR_PORCENTO);
}

function filtrarAbastecimentosPorPeriodo(abastecimentos, inicio, fim) {
    return abastecimentos.filter(a => a.timestamp >= inicio && a.timestamp <= fim);
}

async function salvarAbastecimento(litros) {
    const payload = {
        litros: Number(litros),
        timestamp: Date.now()
    };

    await fetch(`${FIREBASE_BASE}/abastecimentos.json`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
        },
        body: JSON.stringify(payload)
    });
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js">
function gerarLabels24h() {
    const labels = [];
    for (let h = 0; h < 24; h++) {
        labels.push(String(h).padStart(2, '0') + ':00');
    }
    return labels;
}

const CAPACIDADE_TOTAL = 8000; // litros
const LITROS_POR_PORCENTO = CAPACIDADE_TOTAL / 100;

function calcularConsumoPercentual(nivelAnterior, nivelAtual) {
    if (nivelAnterior === null || nivelAtual === null) return 0;
    const diffPct = nivelAnterior - nivelAtual;
    if (diffPct <= 0) return 0;
    return Math.round(diffPct * LITROS_POR_PORCENTO);
}

function filtrarAbastecimentosPorPeriodo(abastecimentos, inicio, fim) {
    return abastecimentos.filter(a => a.timestamp >= inicio && a.timestamp <= fim);
}

async function salvarAbastecimento(litros) {
    const payload = {
        litros: Number(litros),
        timestamp: Date.now()
    };

    await fetch(`${FIREBASE_BASE}/abastecimentos.json`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
        },
        body: JSON.stringify(payload)
    });
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js">
function gerarLabels24h() {
    const labels = [];
    for (let h = 0; h < 24; h++) {
        labels.push(String(h).padStart(2, '0') + ':00');
    }
    return labels;
}

const CAPACIDADE_TOTAL = 8000; // litros
const LITROS_POR_PORCENTO = CAPACIDADE_TOTAL / 100;

function calcularConsumoPercentual(nivelAnterior, nivelAtual) {
    if (nivelAnterior === null || nivelAtual === null) return 0;
    const diffPct = nivelAnterior - nivelAtual;
    if (diffPct <= 0) return 0;
    return Math.round(diffPct * LITROS_POR_PORCENTO);
}

function filtrarAbastecimentosPorPeriodo(abastecimentos, inicio, fim) {
    return abastecimentos.filter(a => a.timestamp >= inicio && a.timestamp <= fim);
}

async function salvarAbastecimento(litros) {
    const payload = {
        litros: Number(litros),
        timestamp: Date.now()
    };

    await fetch(`${FIREBASE_BASE}/abastecimentos.json`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
        },
        body: JSON.stringify(payload)
    });
}

</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js">
function gerarLabels24h() {
    const labels = [];
    for (let h = 0; h < 24; h++) {
        labels.push(String(h).padStart(2, '0') + ':00');
    }
    return labels;
}

const CAPACIDADE_TOTAL = 8000; // litros
const LITROS_POR_PORCENTO = CAPACIDADE_TOTAL / 100;

function calcularConsumoPercentual(nivelAnterior, nivelAtual) {
    if (nivelAnterior === null || nivelAtual === null) return 0;
    const diffPct = nivelAnterior - nivelAtual;
    if (diffPct <= 0) return 0;
    return Math.round(diffPct * LITROS_POR_PORCENTO);
}

function filtrarAbastecimentosPorPeriodo(abastecimentos, inicio, fim) {
    return abastecimentos.filter(a => a.timestamp >= inicio && a.timestamp <= fim);
}

async function salvarAbastecimento(litros) {
    const payload = {
        litros: Number(litros),
        timestamp: Date.now()
    };

    await fetch(`${FIREBASE_BASE}/abastecimentos.json`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
        },
        body: JSON.stringify(payload)
    });
}

</script>
<style>
/* CSS do App Interno */
:root { --bg-body: #f0f2f5; --text-main: #1e293b; --text-sec: #64748b; --card-bg: rgba(255, 255, 255, 0.95); --card-border: rgba(226, 232, 240, 0.8); --header-bg: rgba(255, 255, 255, 0.98); --accent: #06b6d4; --accent-hover: #0891b2; --input-bg: #f8fafc; --input-border: #cbd5e1; --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); --level-ok: #10b981; --level-warn: #f59e0b; --level-danger: #ef4444; }
[data-theme="dark"] { --bg-body: #0f172a; --text-main: #f1f5f9; --text-sec: #94a3b8; --card-bg: rgba(30, 41, 59, 0.85); --card-border: rgba(255, 255, 255, 0.1); --header-bg: rgba(15, 23, 42, 0.95); --accent: #22d3ee; --accent-hover: #67e8f9; --input-bg: #1e293b; --input-border: #334155; --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; margin: 0; padding: 0; }
body { font-family: 'Poppins', sans-serif; text-align: center; background: var(--bg-body); background-image: radial-gradient(at 0% 0%, hsla(192,70%,80%,0.05) 0, transparent 50%), radial-gradient(at 100% 100%, hsla(200,80%,80%,0.05) 0, transparent 50%); color: var(--text-main); overflow-x: hidden; padding-bottom: 0; transition: background-color 0.3s ease, color 0.3s ease; }
::-webkit-scrollbar { display: none; }
* { -ms-overflow-style: none; scrollbar-width: none; }
.glass-panel { background: var(--card-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid var(--card-border); box-shadow: var(--shadow-card); border-radius: 16px; }

/* Botões da Barra de Tarefas (Nav Group) SEM Sombra */
.nav-button-icon-only { width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--card-border); background: var(--card-bg); color: var(--text-sec); cursor: pointer; transition: all 0.2s; box-shadow: none; }
.nav-button-icon-only:active { background: var(--accent); color: white; transform: translateY(2px); }

/* Ajuste da Barra de Tarefas para o Topo (Sem margem) */
.main-header { width: 100%; padding: 10px 5px; background-color: var(--header-bg); backdrop-filter: blur(10px); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); display: flex; justify-content: center; align-items: center; position: sticky; top: 0; z-index: 1000; transition: background-color 0.3s ease; flex-wrap: wrap; gap: 8px; padding-left: 0; margin-top: 0; } 
.nav-group { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 0; justify-content: center; align-items: center; }

/* Indicador Live no Quadro Branco */
.status-indicator-box { position: absolute; top: 10px; right: 10px; }
.live-indicator { width: 10px; height: 10px; border-radius: 50%; background-color: #64748b; transition: background-color 0.3s; display: inline-block; }
.live-indicator.online { background-color: var(--level-ok); box-shadow: 0 0 8px var(--level-ok); animation: pulse-green 2s infinite; }
.live-indicator.offline { background-color: var(--level-danger); }
@keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { transform: scale(1.0); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

#caixa-view, #grafico-container, #config-view, #abastecimento-view, #consumo-view { width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 0.5rem; overflow-y: auto; min-height: calc(100vh - 70px); }
.logo { width: 140px; margin-bottom: 5px; opacity: 0.95; display: block; margin-left: auto; margin-right: auto; mix-blend-mode: multiply; transition: all 0.3s ease; }
[data-theme="dark"] .logo { filter: invert(1) hue-rotate(180deg) brightness(2) contrast(1.2); mix-blend-mode: screen; opacity: 1; margin-bottom: 10px; }
#emergency-badge { position: fixed; top: 80px; right: 20px; width: 50px; height: 50px; background-color: var(--level-danger); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.6); z-index: 1500; animation: pulse-red 1.5s infinite; cursor: help; }
@keyframes pulse-red { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

#status-display { width: 100%; max-width: 360px; padding: 15px; margin: 0 auto 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; position: relative; z-index: 10; margin-top: 10px; }
.status-item { display: flex; flex-direction: column; text-align: center; }
.status-item.item-time { grid-column: 1 / 3; border-top: 1px solid rgba(150,150,150,0.2); padding-top: 5px; margin-top: 2px; }
.status-label { font-size: 0.7rem; font-weight: 600; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1px; }
.status-value { font-size: 1.8rem; font-weight: 700; line-height: 1.1; color: var(--accent); transition: color 0.3s ease; }
#status-litros { font-size: 1.5rem; display: flex; justify-content: center; align-items: baseline; gap: 5px; }
#status-litros small { font-size: 0.85rem; font-weight: 400; color: var(--text-sec); }
#status-time { font-size: 1rem; color: var(--text-main); }
.reservatorio-wrapper { width: 280px; height: 460px; position: relative; margin: -40px auto 0 auto; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1)); transform-origin: top center; transform: scale(0.9); }
.modern-button { background: var(--accent); border: none; color: #fff; font-weight: 600; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.95rem; box-shadow: 0 4px 10px rgba(6,182,212,0.2); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
.modern-button:hover { background: var(--accent-hover); transform: translateY(-2px); }
.modern-button:active { transform: translateY(0); }
.modern-button.btn-success { background-color: var(--level-ok) !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); pointer-events: none; }
input, select { background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-main); padding: 12px; border-radius: 8px; font-family: 'Poppins', sans-serif; outline: none; width: 100%; text-align: center; }
input:focus, select:focus { border-color: var(--accent); }
header h1 { margin: 0; font-size: 1.5rem; color: var(--text-main); font-weight: 700; display: flex; align-items: center; gap: 10px;}
.nav-button { padding: 10px 15px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; font-family: 'Poppins', sans-serif; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; border-radius: 10px; display: flex; align-items: center; gap: 6px; box-shadow: none; }
.nav-button.active { background: var(--accent); color: #fff; box-shadow: 0 4px 12px rgba(6,182,212,0.2); }
.nav-button:hover:not(.active) { background: rgba(150,150,150,0.1); color: var(--text-main); }
.header-right { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; justify-content: center; width: 100%; }
.view-selector { display: flex; gap: 5px; background: var(--input-bg); padding: 4px; border-radius: 10px; }
.view-btn { padding: 8px 16px; border: none; border-radius: 8px; background: transparent; color: var(--text-sec); font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; display: flex; align-items: center; justify-content: center; }
.view-btn.active { background: var(--card-bg); color: var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.board { width: 100%; padding: 0; background: transparent; box-shadow: none; border: none; }
.charts { display: grid; grid-template-columns: 1fr; gap: 25px; }
.chart-card { padding: 20px; }
.chart-card strong { color: var(--text-main); display: block; margin-bottom: 15px; }
canvas { width: 100%!important; height: 320px!important; }
ul { list-style: none; padding: 0; }
li { background: var(--input-bg); padding: 12px 15px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--input-border); color: var(--text-main); }
.delete-abastecimento-btn { background: #fee2e2; color: #ef4444; border: none; width: 32px; height: 32px; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.delete-abastecimento-btn:hover { background: #ef4444; color: white; }
#alert-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.modal-content { background: var(--card-bg); padding: 0; border-radius: 20px; width: 90%; max-width: 400px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid var(--card-border); }
.modal-header { background: var(--level-danger); color: white; padding: 20px; font-weight: 700; font-size: 1.2rem; }
.modal-body { padding: 25px; color: var(--text-main); font-size: 1rem; }
.modal-footer { padding: 15px 20px; background: rgba(0,0,0,0.05); text-align: right; }
.config-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; width: 100%; max-width: 900px; padding: 0 5px; }
.config-card, #abastecimento-form { text-align: center; display: flex; flex-direction: column; align-items: center; padding: 15px; } 
.config-card h2, #abastecimento-form h2 { width: 100%; font-size: 1rem; margin: 0 0 10px 0; }
.config-card .form-group, #abastecimento-form .form-group { display: flex; flex-direction: column; gap: 10px; align-items: center; justify-content: center; width: 100%; }
.config-card .form-group input, .config-card .form-group select, #abastecimento-form .form-group input { width: 100%; min-width: 0; text-align: center; padding: 8px; font-size: 0.95rem; }
.config-card .form-group button, #abastecimento-form .form-group button { width: 100%; padding: 8px; min-width: 0; margin-top: 0; font-size: 0.9rem; }
.config-card:last-child { grid-column: 1 / -1; }
@media (max-width: 800px) { .main-header { overflow-x: hidden; justify-content: center; padding-left: 0; } .nav-group { width: 100%; justify-content: center; overflow-x: auto; } .nav-button span { display: none; } .nav-button i { font-size: 1.3rem; } .nav-button { padding: 10px 15px; } .reservatorio-wrapper { transform: scale(0.8); margin: -50px auto 0 auto; transform-origin: top center; } canvas { height: 260px !important; } }
@media (max-height: 700px) { .reservatorio-wrapper { transform: scale(0.7); margin-top: -60px; } }
#reservatorio-svg .estrutura-solida { fill: url(#grad-metal); stroke: #475569; stroke-width: 2.5; opacity: 0.8; }
#reservatorio-svg .base-concreto { fill: #cbd5e1; stroke: #475569; stroke-width: 2; opacity: 0.9; }
#reservatorio-svg .suportes-base { fill: #94a3b8; stroke: #475569; stroke-width: 2; opacity: 0.9; }
#reservatorio-svg .faixa-metalica { stroke: #475569; stroke-width: 2; opacity: 0.4; fill: none; }
#reservatorio-svg .taca-solida { fill: url(#grad-metal); stroke: #1e293b; stroke-width: 2.5; opacity: 0.3; }
#reservatorio-svg .guarda-corpo { fill: none; stroke: #1e293b; stroke-width: 2.5; opacity: 0.5; }
@keyframes pisca { 0% { opacity: 1; filter: drop-shadow(0 0 8px currentColor); } 50% { opacity: 0.4; filter: drop-shadow(0 0 2px currentColor); } 100% { opacity: 1; filter: drop-shadow(0 0 8px currentColor); } }
.led-base { stroke: #222; stroke-width: 1; transition: all 0.3s ease; fill: #333; }
.led-base.aceso.vermelho { fill: #ff0000; color: #ff0000; animation: pisca 0.8s infinite; }
.led-base.aceso.amarelo { fill: #ffdd00; color: #ffdd00; animation: pisca 0.8s infinite; }
.led-base.aceso.verde { fill: #00ff00; color: #00ff00; animation: pisca 0.8s infinite; }
.agua-wrapper { width: 100%; height: 100%; position: relative; overflow: hidden; }
.agua { position: absolute; bottom: 0; width: 100%; height: 0%; background: linear-gradient(to top, #06b6d4, #3b82f6); transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1); overflow: visible; color: white; font-weight: 800; text-align: center; font-size: 1.3rem; display: flex; align-items: center; justify-content: center; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.agua::before, .agua::after { content: ""; position: absolute; width: 200%; height: 20px; top: -15px; left: 0; background-repeat: repeat-x; border-radius: 45%; background: rgba(255,255,255,0.3); }
.agua::before { transform: translateX(-50%); animation: onda1 4s linear infinite; }
.agua::after { top: -12px; transform: translateX(-50%); background: rgba(255,255,255,0.15); animation: onda2 6s linear infinite; }
@keyframes onda1 { 0% { transform: translateX(0) translateY(0) scaleY(1); } 50% { transform: translateX(-25%) translateY(2px) scaleY(0.9); } 100% { transform: translateX(-50%) translateY(0) scaleY(1); } }
@keyframes onda2 { 0% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-25%) translateY(2px); } 100% { transform: translateX(0) translateY(0); } }
</style>
</head>
<body>
<div id="emergency-badge" title="Sem Sinal">!</div>

<div class="main-header glass-panel" style="border-radius: 0 0 20px 20px; border-top: none;">
<div class="nav-group">
<!-- Botão Voltar (Movido para cá) -->
<button class="nav-button-icon-only" onclick="window.parent.fecharApp()" title="Voltar"><i class="fas fa-arrow-left"></i></button>
<!-- Botões de Tema e Atualizar -->
<button class="nav-button-icon-only" onclick="window.toggleTheme()" title="Alternar Tema"><i class="fas fa-moon"></i></button>
<button class="nav-button-icon-only" onclick="window.location.reload(true)" title="Atualizar"><i class="fas fa-sync-alt"></i></button>
<!-- Botões de Navegação -->
<button id="btn-view-caixa" class="nav-button active"><i class="fas fa-water"></i> <span>Caixa D'água</span></button>
<button id="btn-view-grafico" class="nav-button"><i class="fas fa-chart-line"></i> <span>Histórico</span></button>
<button id="btn-view-abastecimento" class="nav-button"><i class="fas fa-truck-droplet"></i> <span>Abastecimento</span></button>
<button id="btn-view-consumo" class="nav-button"><i class="fas fa-chart-bar"></i> <span>Consumo</span></button>
<button id="btn-view-config" class="nav-button"><i class="fas fa-cog"></i> <span>Config</span></button>
</div>
</div>
<div id="caixa-view">
<img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">

<!-- Título Específico da Caixa -->
<h2 style="font-size: 1rem; color: var(--text-sec); margin: 5px 0 10px 0; font-weight: 600; text-align: center;">__APP_TITLE__</h2>

<div id="status-display" class="glass-panel">
<!-- Indicador LED dentro do quadro branco -->
<div class="status-indicator-box">
<div id="live-indicator" class="live-indicator offline" title="Status Conexão"></div>
</div>

<div class="status-item item-level">
<span class="status-label">Nível Atual</span>
<div style="display:flex; justify-content:center; align-items:center;">
<span class="status-value skeleton-text" id="status-level">--%</span>
<span id="simulated-indicator" style="display:none; background:#f59e0b; color:white; border-radius:50%; width:20px; height:20px; font-size:12px; align-items:center; justify-content:center; margin-left:8px; vertical-align:middle; cursor:help; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.2);" title="Leitura Estimada (Sem Sinal)">?</span>
</div>
</div>
<div class="status-item item-litros">
<span class="status-label">Volume</span>
<span class="status-value skeleton-text" id="status-litros">---- <small>L</small></span>
</div>
<div class="status-item item-time">
<span class="status-label">Hora</span>
<span class="status-value skeleton-text" id="status-time" style="font-size: 1.2rem;">--:--</span>
</div>
</div>
<div class="reservatorio-wrapper" id="caixa-container">
<svg id="reservatorio-svg" viewBox="0 0 400 1000" preserveAspectRatio="xMidYMin meet">
<defs>
<linearGradient id="grad-metal" x1="0%" y1="0%" x2="100%" y2="0%">
<stop offset="0%" stop-color="#e2e8f0"/><stop offset="50%" stop-color="#f1f5f9"/><stop offset="100%" stop-color="#cbd5e1"/>
</linearGradient>
<clipPath id="mascara-agua">
<path d="M 105 220 L 295 220 L 295 440 L 265 500 L 135 500 L 105 440 Z"/>
</clipPath>
</defs>
<foreignObject x="105" y="220" width="190" height="280" clip-path="url(#mascara-agua)">
<div xmlns="http://www.w3.org/1999/xhtml" class="agua-wrapper">
<div class="agua" id="agua">0%</div>
</div>
</foreignObject>
<g id="estrutura-reservatorio">
<g id="base"><path class="base-concreto" d="M 80 950 L 320 950 L 310 930 L 90 930 Z"/><path class="suportes-base" d="M 130 930 L 120 940 L 140 940 Z M 170 930 L 160 940 L 180 940 Z M 210 930 L 200 940 L 220 940 Z M 250 930 L 240 940 L 260 940 Z M 290 930 L 280 940 L 300 940 Z"/></g>
<g id="coluna"><path class="estrutura-solida" d="M 135 930 L 135 500 L 265 500 L 265 930 Z"/><path class="faixa-metalica" d="M 135 620 L 265 620 M 135 770 L 265 770"/></g>
<g id="taca-solida"><path class="taca-solida" d="M 100 440 L 100 220 L 300 220 L 300 440 L 265 500 L 135 500 Z"/><path class="guarda-corpo" d="M 100 220 A 100 25 0 0 1 300 220"/></g>
<g id="leds-base"><circle id="led-verde" class="led-base verde" cx="160" cy="975" r="12" /><circle id="led-amarelo" class="led-base amarelo" cx="200" cy="975" r="12" /><circle id="led-vermelho" class="led-base vermelho" cx="240" cy="975" r="12" /></g>
</g>
</svg>
</div>
</div>
<div id="grafico-container" style="display:none;">
<img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
<header>
<h1><i class="fas fa-chart-line" style="color: var(--accent);"></i> Histórico de Nível</h1>
</header>
<div class="controls" style="display:flex; align-items: center; justify-content:center; gap:10px; margin-bottom: 15px;">
<div id="diario-picker"><input type="date" id="dataEscolhida"></div>
<div id="mensal-picker" style="display:none;"><input type="month" id="mesEscolhido"></div>
<div id="intervalo-picker" style="display:none;"><input type="date" id="dataInicio"><span>até</span><input type="date" id="dataFim"></div>
<button id="btnAtualizar" class="modern-button" style="padding:10px 15px;"><i class="fas fa-sync-alt"></i></button>
</div>
<div class="board">
<div class="charts">
<div class="chart-card glass-panel"><strong>Variação de Nível (%)</strong><canvas id="chartLinha"></canvas></div>
<div class="chart-card glass-panel"><strong>Nível Médio por Hora (%)</strong><canvas id="chartBlocos"></canvas></div>
</div>
</div>
</div>
<div id="abastecimento-view" style="display:none;">
<img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
<header>
<h1><i class="fas fa-truck-droplet" style="color: var(--accent);"></i> Abastecimento</h1>
</header>
<div class="board" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
<div id="abastecimento-form" class="config-card glass-panel" style="margin: 0; width: 100%; max-width: 500px;">
<h2>Registrar Entrada</h2>
<div class="form-group">
<input type="number" id="litros-abastecidos" placeholder="Qtd. Litros (ex: 5000)" min="1">
<button id="btn-salvar-abastecimento" class="modern-button"><i class="fas fa-save"></i> Salvar</button>
</div>
<div id="status-abastecimento" class="small" style="font-weight:bold; margin: -10px 0 0 0;"></div>
</div>
<div id="abastecimento-historico-card" class="glass-panel" style="width: 100%; max-width: 500px; padding: 20px;">
<h3 style="margin: 0 0 15px 0; color: var(--text-main); font-size: 1.1rem; text-align: left; border-bottom: 1px solid var(--text-sec); padding-bottom: 8px;">Histórico Recente</h3>
<ul id="lista-abastecimentos"></ul>
</div>
<div class="controls" style="display:flex; align-items: center; justify-content:center; gap:10px; margin-bottom: 5px; flex-wrap:wrap;">
<input type="month" id="mesAbastecimento">
<select id="filtroSemana" style="padding: 10px; border-radius: 8px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-main); font-family: 'Poppins', sans-serif;">
<option value="todas">Visão Mensal</option>
<option value="1">Semana 1 (1-7)</option>
<option value="2">Semana 2 (8-14)</option>
<option value="3">Semana 3 (15-21)</option>
<option value="4">Semana 4 (22+)</option>
</select>
<button id="btnAtualizarAbastecimento" class="modern-button" style="padding:10px 15px;"><i class="fas fa-sync-alt"></i></button>
</div>
<div class="chart-card glass-panel" style="width: 100%; max-width: 600px;">
<strong id="tituloGraficoAbastecimento">Comparativo Semanal (Litros)</strong>
<canvas id="chartAbastecimento"></canvas>
</div>
</div>
</div>
<div id="consumo-view" style="display:none;">
<img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
<header>
<h1><i class="fas fa-chart-bar" style="color: var(--accent);"></i> Consumo Diário</h1>
</header>
<div class="controls" style="display:flex; align-items: center; justify-content:center; gap:10px; margin-bottom: 15px;">
<input type="date" id="dataEscolhidaConsumo" onchange="document.getElementById('dataEscolhida').value=this.value; document.getElementById('btnAtualizar').click();">
<button onclick="document.getElementById('btnAtualizar').click()" class="modern-button" style="padding:10px 15px;"><i class="fas fa-sync-alt"></i></button>
</div>
<div class="board">
<div class="charts">
<div class="chart-card glass-panel" id="consumo-chart-card-bloco">
<strong>Consumo Estimado (Litros)</strong>
<canvas id="chartConsumoBloco"></canvas>
<div id="consumo-info-texto" style="margin-top: 15px; font-weight: 700; color: var(--accent); font-size: 1.1rem;"></div>
</div>
<div class="chart-card glass-panel" id="consumo-chart-card-linha">
<strong>Curva de Consumo</strong>
<canvas id="chartConsumoLinha"></canvas>
</div>
</div>
</div>
</div>
<div id="config-view" style="display:none;">
<img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
<h1><i class="fas fa-cog" style="color: var(--accent);"></i> Configurações</h1>
<div class="config-board">
<div class="config-card glass-panel">
<h2>Capacidade (L)</h2>
<div class="form-group">
<input type="number" id="capacidade-total-valor" placeholder="Ex: 8000" min="1000">
<button id="btn-salvar-capacidade" class="modern-button"><i class="fas fa-check"></i></button>
</div>
<div id="status-capacidade" class="small" style="font-weight:bold;"></div>
</div>
<div class="config-card glass-panel">
<h2>Altura (cm)</h2>
<div class="form-group">
<input type="number" id="altura-caixa-valor" placeholder="Ex: 200" min="1">
<button id="btn-salvar-altura" class="modern-button"><i class="fas fa-check"></i></button>
</div>
<div id="status-altura" class="small" style="font-weight:bold;"></div>
</div>
<div class="config-card glass-panel">
<h2>Novo Contato</h2>
<div class="form-group">
<input type="text" id="contato-valor" placeholder="Email ou Telegram">
<select id="contato-tipo">
<option value="email">Email</option>
<option value="telegram">Telegram</option>
</select>
<button id="btn-add-contato" class="modern-button"><i class="fas fa-plus"></i></button>
</div>
<div id="status-contato" class="small" style="font-weight:bold; margin-top: 10px;"></div>
</div>
<div class="config-card glass-panel">
<h2>Nível Alerta (%)</h2>
<div class="form-group">
<input type="number" id="nivel-alerta-valor" placeholder="Ex: 30" min="1" max="99">
<button id="btn-salvar-nivel-alerta" class="modern-button"><i class="fas fa-check"></i></button>
</div>
<div id="status-alerta" class="small" style="font-weight:bold;"></div>
</div>
<div class="config-card glass-panel" style="grid-column: 1 / -1;">
<h2>Contatos Cadastrados</h2>
<ul id="lista-contatos"></ul>
<div id="status-lista-contatos" class="small" style="font-weight:bold; margin-top: 10px;"></div>
</div>
</div>
</div>
<div id="alert-modal">
<div class="modal-content">
<div class="modal-header">
<i class="fas fa-exclamation-triangle"></i> ALERTA DE NÍVEL BAIXO
</div>
<div class="modal-body">
Atenção: Solicitar abastecimento ao CCO. (Nível Crítico)
</div>
<div class="modal-footer">
<button id="modal-close-btn" class="modern-button">Entendido</button>
</div>
</div>
</div>
<div class="header-right" id="date-controls" style="display: none;">
<div class="view-selector">
<button id="btn-view-diario" class="view-btn active" data-view="diario">Hoje</button>
<button id="btn-view-semanal" class="view-btn" data-view="semanal" style="display:none;">Semanal</button>
<button id="btn-view-mensal" class="view-btn" data-view="mensal">Mês</button>
<button id="btn-view-intervalo" class="view-btn" data-view="intervalo">Período</button>
</div>
</div>
<script>
const API_KEY = ""; 
const DATABASE_URL = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";
// VARIAVEIS INJETADAS PELO DASHBOARD
const PATH_TEMPO_REAL = `${DATABASE_URL}__FIREBASE_DATA_PATH__`; 
const PATH_CONFIG_BASE = `${DATABASE_URL}__FIREBASE_CONFIG_PATH__`; // Base path for config (e.g., /SAU13_config)
const PATH_HISTORICO = `${DATABASE_URL}__FIREBASE_HIST_PATH__`; // Base path for historic (e.g., /SAU13_historico)
const PATH_ABASTECIMENTO = `${PATH_CONFIG_BASE}/abastecimentos.json`;
// CONTAS DE EMAIL ROTATIVAS
const CONTAS_EMAIL = [ { id: 0, service: "service_lubx0i8", template: "template_ll79qy1", key: "I1HnvhgWehPP7EXxX", quota_inicial: 0, dia_reinicio: 18, mes_reinicio: 11 }, { id: 1, service: "service_n365um4", template: "template_fjhnurn", key: "ivGT9BYMpO_IMpcJI", quota_inicial: 75, dia_reinicio: 25, mes_reinicio: 11 }, { id: 2, service: "service_txwft9l", template: "template_c5l1j8r", key: "xwk898VhH0VS-PSg9", quota_inicial: 6, dia_reinicio: 30, mes_reinicio: 11 } ];
let isDarkMode = false;
// TORNAR GLOBAL PARA SER ACESSADA PELO ONCLICK
window.toggleTheme = function(e) { 
    if(e) { e.preventDefault(); e.stopPropagation(); } 
    isDarkMode = !isDarkMode; 
    applyTheme(); 
};
function checkAutoTheme() { try { const savedTheme = localStorage.getItem('theme'); if (savedTheme) { isDarkMode = (savedTheme === 'dark'); applyTheme(); return; } } catch (e) {} const hora = new Date().getHours(); isDarkMode = (hora >= 18 || hora < 6); applyTheme(); }
function applyTheme() { const body = document.body; const icon = document.querySelector('.nav-button-icon-only[title="Alternar Tema"] i'); if (isDarkMode) { body.setAttribute('data-theme', 'dark'); if(icon) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); } try { localStorage.setItem('theme', 'dark'); } catch(e){} } else { body.removeAttribute('data-theme'); body.style.display='none'; body.offsetHeight; body.style.display=''; if(icon) { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); } try { localStorage.setItem('theme', 'light'); } catch(e){} } criarGraficos();
    // Garantir que a tela inicial seja a Caixa D'água
    try { switchView('caixa'); } catch(e) {} if(activeTab === 'grafico' || activeTab === 'consumo') carregarHistoricoEConsumo(); if(activeTab === 'abastecimento') carregarHistoricoAbastecimento(); }

try { const savedTheme = localStorage.getItem('theme'); if (savedTheme === 'dark') { isDarkMode = true; document.body.setAttribute('data-theme', 'dark'); } } catch (e) {}
let chartLinha, chartBlocos, chartConsumoBloco, chartConsumoLinha, chartAbastecimento; 
let historicoNiveis = [], historicoLabels = [];
let currentView = 'diario'; let activeTab = 'caixa'; 
let nivelAtual = 0; let nivelAlertaConfigurado = 30; let capacidadeTotal = 8000; let alturaCaixa = 0; 
let alertaModalMostrado = false; let verificacaoInicialConcluida = false;
let emailEnviadoNessaSessao = false; let alertaConfirmadoPeloUsuario = false; 
let ultimoHorarioSalvo = -1; let ultimoTempoSalvo = 0; 
let audioContext, oscillator, gainNode, lfo, lfoGain, isAlarmPlaying = false;
let snoozeCount = 0, snoozeUntil = 0; 
const SNOOZE_DURATION_MINUTES = 10; const AUTO_SNOOZE_SECONDS = 30; 
let ultimoNivelValidoLatch = null; let timestampLatch = null; 
let historicoLeiturasValidas = []; let loopInterval = null;
let lastUpdateTimestamp = 0; let contadorZerosConsecutivos = 0; 
let bufferLeituras = []; let contadorLeiturasFantasmas = 0; let ultimoNivelExibido = -1; 
function calcularVolumeLitros(nivelPercentual) { if (nivelPercentual <= 0) return 0; if (nivelPercentual > 100) nivelPercentual = 100; return Math.floor((nivelPercentual / 100) * capacidadeTotal); }
function getLocalISODate(dateObj) { const d = dateObj || new Date(); const offset = d.getTimezoneOffset() * 60000; const localDate = new Date(d.getTime() - offset); return localDate.toISOString().split('T')[0]; }
function getNoCacheUrl(url) { const separator = url.includes('?') ? '&' : '?'; return `${url}${separator}nocache=${Date.now()}_${Math.floor(Math.random() * 99999)}`; }
async function safeFetch(url, options = {}) { const finalOptions = { ...options, cache: 'no-store' }; try { const response = await fetch(getNoCacheUrl(url), finalOptions); if (!response.ok) throw new Error(response.statusText); return response; } catch(e) { console.warn("Fetch falhou:", url); return null; } }
async function enviarEmailAlerta(nivel) { const urlTimestamp = `${PATH_CONFIG_BASE}/controle_email/ultimo_disparo_timestamp.json`; if (emailEnviadoNessaSessao) return false; try { const rTime = await safeFetch(urlTimestamp); if (rTime) { const ultimoDisparo = await rTime.json(); const agora = Date.now(); if (ultimoDisparo) { const diferenca = agora - ultimoDisparo; const horas12 = 12 * 60 * 60 * 1000; if (diferenca < horas12) return false; } } } catch (e) {} let contatos = {}; try { const r = await safeFetch(`${PATH_CONFIG_BASE}/contatos.json`); if (r) contatos = await r.json(); if (!contatos) return false; } catch (e) { return false; } const emailsParaEnviar = Object.values(contatos).filter(c => c.tipo === 'email' && c.valor).map(c => c.valor); if (emailsParaEnviar.length === 0) return false; let credenciais = null; const hoje = new Date(); for (let conta of CONTAS_EMAIL) { let dataReinicio = new Date(hoje.getFullYear(), conta.mes_reinicio, conta.dia_reinicio); if (hoje >= dataReinicio && conta.quota_inicial < 200) { conta.quota_inicial = 200; } if (conta.quota_inicial >= emailsParaEnviar.length) { credenciais = conta; break; } } if (!credenciais) { console.warn("Sem cota de email."); return false; } let todosEnviadosComSucesso = true; for (const email of emailsParaEnviar) { const templateParams = { "%": nivel, "email": email }; try { await emailjs.send(credenciais.service, credenciais.template, templateParams, credenciais.key); } catch (err) { console.error("Erro envio", err); todosEnviadosComSucesso = false; } } if (todosEnviadosComSucesso) { emailEnviadoNessaSessao = true; const agoraMs = Date.now(); try { await fetch(urlTimestamp, { method: 'PUT', body: JSON.stringify(agoraMs) }); } catch(e) {} } return todosEnviadosComSucesso; }
function mostrarAlertaModal() { document.getElementById('alert-modal').style.display = 'flex'; }
function fecharAlertaModal() { document.getElementById('alert-modal').style.display = 'none'; }
function confirmarAlerta() { fecharAlertaModal(); controlarAlarme(false); alertaModalMostrado = false; alertaConfirmadoPeloUsuario = true; }
function iniciarSoneca() { fecharAlertaModal(); controlarAlarme(false); alertaModalMostrado = false; snoozeCount++; if (snoozeCount < 3) { const snoozeMs = SNOOZE_DURATION_MINUTES * 60 * 1000; snoozeUntil = Date.now() + snoozeMs; } }
function setupAudio() { try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); oscillator = audioContext.createOscillator(); gainNode = audioContext.createGain(); lfo = audioContext.createOscillator(); lfoGain = audioContext.createGain(); lfo.type = 'sine'; lfo.frequency.setValueAtTime(2, audioContext.currentTime); lfoGain.gain.setValueAtTime(400, audioContext.currentTime); oscillator.type = 'square'; oscillator.frequency.setValueAtTime(800, audioContext.currentTime); lfo.connect(lfoGain); lfoGain.connect(oscillator.frequency); oscillator.connect(gainNode); gainNode.connect(audioContext.destination); gainNode.gain.setValueAtTime(0, audioContext.currentTime); lfo.start(); oscillator.start(); } catch (e) {} }
\1

function forcarAlertaNaAberturaSeNecessario(nivelExibido) {
    try {
        // Sempre que abrir a página, se estiver abaixo do nível de alerta, mostrar popup e tocar alarme
        if (typeof nivelExibido === 'number' && nivelExibido > 0 && nivelExibido <= nivelAlertaConfigurado) {
            // reseta bloqueios de sessão para garantir alerta ao abrir
            alertaModalMostrado = false;
            alertaConfirmadoPeloUsuario = false;
            snoozeCount = 0;
            snoozeUntil = 0;
            emailEnviadoNessaSessao = false;

            mostrarAlertaModal();
            controlarAlarme(true);
        }
    } catch(e) {}
}

// Nova Função para buscar dados históricos caso o realtime esteja 0/offline
async function buscarBackupHistorico() {
    try {
        const today = new Date().toISOString().split('T')[0];
        // Busca a última entrada do dia
        const r = await fetch(`${PATH_HISTORICO}/${today}.json?orderBy="$key"&limitToLast=1`);
        const d = await r.json();
        if(d) {
            const keys = Object.keys(d);
            if(keys.length > 0) {
                const lastEntry = d[keys[0]];
                return {
                    pct: lastEntry.nivel_pct || lastEntry.nivel || 0,
                    time: lastEntry.timestamp || 0
                };
            }
        }
    } catch(e) { console.log('Erro ao buscar backup historico', e); }
    return null;
}

async function loopDeAtualizacao() { 
    const liveIndicator = document.getElementById('live-indicator'); 
    try { 
        if (!verificacaoInicialConcluida) return; 
        lastUpdateTimestamp = Date.now(); 
        let j = {}; 
        let fetchSuccess = false; 
        try { 
            const r = await safeFetch(PATH_TEMPO_REAL); 
            if (r) { j = await r.json(); fetchSuccess = true; } 
        } catch (err) {} 
        
        if(liveIndicator) { 
            if (fetchSuccess) { 
                liveIndicator.classList.remove('offline'); 
                liveIndicator.classList.add('online'); 
                liveIndicator.style.opacity = (liveIndicator.style.opacity === '0.5' ? '1' : '0.5'); 
            } else { 
                liveIndicator.classList.remove('online'); 
                liveIndicator.classList.add('offline'); 
                liveIndicator.style.opacity = '1'; 
            } 
        } 
        
        let nivelRecebidoRaw = 0; 
        if (j && j.nivel_pct !== undefined) nivelRecebidoRaw = j.nivel_pct; 
        else if (j && j.percentual_atual !== undefined) nivelRecebidoRaw = j.percentual_atual; 
        let nivelRecebido = Number(nivelRecebidoRaw); 
        let tipoDado = 'real'; 
        let statusSensor = j && j.status_leitura ? j.status_leitura : "OFFLINE"; 
        
        if (nivelRecebido > 0 && statusSensor !== "ERRO_SENSOR") { 
            if (bufferLeituras.length === 0) { for(let i=0; i<9; i++) bufferLeituras.push(nivelRecebido); } 
            else { bufferLeituras.push(nivelRecebido); if (bufferLeituras.length > 9) bufferLeituras.shift(); } 
            let nivelEstavel = obterMediana(bufferLeituras); 
            if (ultimoNivelValidoLatch !== null && Math.abs(nivelEstavel - ultimoNivelValidoLatch) > 5) { 
                contadorLeiturasFantasmas++; 
                if (contadorLeiturasFantasmas < 5) { nivelEstavel = ultimoNivelValidoLatch; } 
                else { contadorLeiturasFantasmas = 0; } 
            } else { contadorLeiturasFantasmas = 0; } 
            
            nivelAtual = nivelEstavel; 
            tipoDado = 'real'; 
            ultimoNivelValidoLatch = nivelEstavel; 
            timestampLatch = Date.now(); 
            localStorage.setItem('__STORAGE_KEY_PREFIX___last_level', nivelEstavel); 
            localStorage.setItem('__STORAGE_KEY_PREFIX___last_time', timestampLatch); 
            document.getElementById('emergency-badge').style.display = 'none'; 
            document.getElementById('simulated-indicator').style.display = 'none'; 
        } else { 
            let backupUsado = false; 
            let pctBackup = 0;
            let timeBackup = 0;

            // Prioridade 1: Dados do JSON em tempo real (se tiver ultima valida)
            if (j && j.ultima_valida_pct > 0 && j.ultima_valida_time > 0) { 
                pctBackup = j.ultima_valida_pct;
                timeBackup = j.ultima_valida_time;
            } 
            // Prioridade 2: Memória Local (Latch)
            else if (ultimoNivelValidoLatch !== null && timestampLatch !== null) { 
                pctBackup = ultimoNivelValidoLatch;
                timeBackup = timestampLatch;
            } 
            // Prioridade 3: LocalStorage persistente
            else { 
                const savedLvl = localStorage.getItem('__STORAGE_KEY_PREFIX___last_level'); 
                const savedTime = localStorage.getItem('__STORAGE_KEY_PREFIX___last_time'); 
                if(savedLvl && savedTime) { 
                    pctBackup = Number(savedLvl);
                    timeBackup = Number(savedTime);
                } else {
                    // Prioridade 4: Busca forçada no histórico (última chance antes de mostrar 0%)
                    const histData = await buscarBackupHistorico();
                    if (histData) {
                        pctBackup = histData.pct;
                        timeBackup = histData.time;
                        // Salva para o próximo ciclo não precisar buscar
                        ultimoNivelValidoLatch = pctBackup;
                        timestampLatch = timeBackup;
                    }
                }
            } 

            if (pctBackup > 0) {
                nivelAtual = calcularNivelSimuladoLatch(pctBackup, timeBackup);
                backupUsado = true;
            } else {
                nivelAtual = 0;
            }

            document.getElementById('emergency-badge').style.display = 'flex'; 
            if (backupUsado) { 
                document.getElementById('simulated-indicator').style.display = 'flex'; 
                tipoDado = 'estimado'; 
            } else { 
                tipoDado = 'real'; 
            } 
        } 
        
        const statusDisplay = document.getElementById('status-display'); 
        if(statusDisplay) { 
            statusDisplay.classList.remove('level-ok', 'level-warn', 'level-danger'); 
            if (nivelAtual <= nivelAlertaConfigurado) { 
                statusDisplay.classList.add('level-danger'); 
                if (!alertaConfirmadoPeloUsuario && snoozeCount < 3) { controlarAlarme(true); } 
                if (!alertaConfirmadoPeloUsuario && !alertaModalMostrado && snoozeCount < 3) { 
                    enviarEmailAlerta(nivelAtual); mostrarAlertaModal(); alertaModalMostrado = true; 
                    setTimeout(() => { if (alertaModalMostrado) iniciarSoneca(); }, AUTO_SNOOZE_SECONDS * 1000); 
                } else { enviarEmailAlerta(nivelAtual); } 
            } else { 
                if (nivelAtual > 50) { 
                    if (alertaConfirmadoPeloUsuario) alertaConfirmadoPeloUsuario = false; 
                    if (emailEnviadoNessaSessao) emailEnviadoNessaSessao = false; 
                } 
                if (nivelAtual <= 60) statusDisplay.classList.add('level-warn'); 
                else statusDisplay.classList.add('level-ok'); 
                if (alertaModalMostrado) { fecharAlertaModal(); alertaModalMostrado = false; } 
                controlarAlarme(false); snoozeCount = 0; snoozeUntil = 0; 
            } 
        } 
        atualizarCaixaDOM(nivelAtual); 
        const agora = new Date(); 
        const horaAtual = agora.getHours(); 
        const agoraMs = agora.getTime(); 
        if ((horaAtual !== ultimoHorarioSalvo || (agoraMs - ultimoTempoSalvo > 300000)) && nivelAtual > 0) { 
            await salvarLeituraNoFirebase(Number(nivelAtual), agoraMs, tipoDado); 
            ultimoHorarioSalvo = horaAtual; 
            ultimoTempoSalvo = agoraMs; 
            if (currentView === 'diario' && (activeTab === 'grafico' || activeTab === 'consumo')) carregarHistoricoEConsumo(); 
        } 
    } catch(e) { 
        if(liveIndicator) { 
            liveIndicator.classList.remove('online'); 
            liveIndicator.classList.add('offline'); 
        } 
    } 
}
window.onload = function() { checkAutoTheme(); const views = { caixa: document.getElementById('caixa-view'), grafico: document.getElementById('grafico-container'), abastecimento: document.getElementById('abastecimento-view'), consumo: document.getElementById('consumo-view'), config: document.getElementById('config-view') }; const btns = { caixa: document.getElementById('btn-view-caixa'), grafico: document.getElementById('btn-view-grafico'), abastecimento: document.getElementById('btn-view-abastecimento'), consumo: document.getElementById('btn-view-consumo'), config: document.getElementById('btn-view-config') }; const dateControls = document.getElementById('date-controls'); const hoje = new Date(); const mesAtual = getLocalISODate(hoje).substring(0, 7); const elMesAbast = document.getElementById('mesAbastecimento'); if(elMesAbast) { elMesAbast.value = mesAtual; } const btnAtAbast = document.getElementById('btnAtualizarAbastecimento'); if(btnAtAbast) { btnAtAbast.onclick = carregarHistoricoAbastecimento; } setupAudio(); function despertarAudio() { if (audioContext && audioContext.state === 'suspended') audioContext.resume(); } document.body.addEventListener('click', despertarAudio, { once: true }); document.body.addEventListener('touchstart', despertarAudio, { once: true }); verificacaoInicialConcluida = true; function switchView(viewName) { activeTab = viewName; for (const key in views) { if(views[key]) views[key].style.display = 'none'; } if (views[viewName]) { views[viewName].style.display = 'flex'; } document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active')); if (btns[viewName]) { btns[viewName].classList.add('active'); } if(dateControls) dateControls.style.display = 'none'; if (viewName === 'grafico' || viewName === 'consumo') { carregarHistoricoEConsumo(); } if (viewName === 'caixa') carregarHistoricoAbastecimento(); else if (viewName === 'grafico') { if(chartLinha) chartLinha.resize(); if(chartBlocos) chartBlocos.resize(); } else if (viewName === 'consumo') { if(chartConsumoBloco) chartConsumoBloco.resize(); if(chartConsumoLinha) chartConsumoLinha.resize(); } else if (viewName === 'abastecimento') { carregarHistoricoAbastecimento(); if(chartAbastecimento) chartAbastecimento.resize(); } else if (viewName === 'config') { carregarContatos(); carregarConfiguracoesGerais(); } } if(btns.caixa) btns.caixa.addEventListener('click', () => switchView('caixa')); if(btns.grafico) btns.grafico.addEventListener('click', () => switchView('grafico')); if(btns.abastecimento) btns.abastecimento.addEventListener('click', () => switchView('abastecimento')); if(btns.consumo) btns.consumo.addEventListener('click', () => switchView('consumo')); if(btns.config) btns.config.addEventListener('click', () => switchView('config')); document.getElementById('modal-close-btn').addEventListener('click', confirmarAlerta); document.getElementById('btn-salvar-abastecimento').addEventListener('click', () => salvarAbastecimento(document.getElementById('litros-abastecidos').value)); document.getElementById('btn-salvar-capacidade').addEventListener('click', () => salvarCapacidade(parseInt(document.getElementById('capacidade-total-valor').value))); document.getElementById('btn-salvar-altura').addEventListener('click', () => salvarAltura(parseInt(document.getElementById('altura-caixa-valor').value))); document.getElementById('btn-add-contato').addEventListener('click', () => adicionarContato(document.getElementById('contato-valor').value, document.getElementById('contato-tipo').value)); document.getElementById('btn-salvar-nivel-alerta').addEventListener('click', () => salvarNivelAlerta(parseInt(document.getElementById('nivel-alerta-valor').value))); document.getElementById('lista-contatos').addEventListener('click', (e) => { if (e.target.closest('button')) { const btn = e.target.closest('button'); const id = btn.dataset.id; if (btn.dataset.confirming) { removerContato(id); btn.dataset.confirming = ''; } else { btn.dataset.confirming = 'true'; btn.innerHTML = '<i class="fas fa-check"></i>'; setTimeout(() => { btn.dataset.confirming = ''; btn.innerHTML = '<i class="fas fa-trash"></i>'; }, 2000); } } }); document.getElementById('lista-abastecimentos').addEventListener('click', (e) => { if (e.target.closest('button')) { const btn = e.target.closest('button'); const id = btn.dataset.id; if (btn.dataset.confirming) { removerAbastecimento(id); btn.dataset.confirming = ''; } else { btn.dataset.confirming = 'true'; btn.innerHTML = '<i class="fas fa-check"></i>'; setTimeout(() => { btn.dataset.confirming = ''; btn.innerHTML = '<i class="fas fa-times"></i>'; }, 2000); } } }); criarGraficos(); const dataFim = getLocalISODate(hoje); const mesFim = dataFim.substring(0, 7); hoje.setDate(hoje.getDate() - 59); const dataIni = getLocalISODate(hoje); const elDataEsc = document.getElementById('dataEscolhida'); if(elDataEsc) elDataEsc.value = dataFim; const elDataEscConsumo = document.getElementById('dataEscolhidaConsumo'); if(elDataEscConsumo) elDataEscConsumo.value = dataFim; const elMesEsc = document.getElementById('mesEscolhido'); if(elMesEsc) elMesEsc.value = mesFim; const elDataIni = document.getElementById('dataInicio'); if(elDataIni) elDataIni.value = dataIni; const elDataFim = document.getElementById('dataFim'); if(elDataFim) elDataFim.value = dataFim; switchView('caixa'); const btnAt = document.getElementById('btnAtualizar'); if(btnAt) btnAt.onclick = () => { if (activeTab === 'grafico' || activeTab === 'consumo') carregarHistoricoEConsumo(); }; carregarConfiguracoesGerais(); carregarHistoricoEConsumo(); loopDeAtualizacao(); loopInterval = setInterval(loopDeAtualizacao, 2500); setInterval(() => { const now = Date.now(); if (now - lastUpdateTimestamp > 10000) { console.log("Watchdog: Reiniciando loop travado..."); loopDeAtualizacao(); } }, 5000); document.addEventListener("visibilitychange", () => { if (document.visibilityState === 'visible') { console.log("App visível novamente. Forçando atualização..."); loopDeAtualizacao(); carregarHistoricoEConsumo(); clearInterval(loopInterval); loopInterval = setInterval(loopDeAtualizacao, 2500); } }); document.querySelectorAll('.view-selector .view-btn').forEach(btn => { btn.addEventListener('click', (e) => { const parent = e.target.parentElement; parent.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); if (e.target.dataset.view) { currentView = e.target.dataset.view; const pickers = { diario: 'diario-picker', mensal: 'mensal-picker', intervalo: 'intervalo-picker' }; for(const k in pickers) document.getElementById(pickers[k]).style.display = 'none'; if (pickers[currentView]) document.getElementById(pickers[currentView]).style.display = 'flex'; if(btnAt) btnAt.click(); } }); }); };

function gerarLabels24h() {
    const labels = [];
    for (let h = 0; h < 24; h++) {
        labels.push(String(h).padStart(2, '0') + ':00');
    }
    return labels;
}

const CAPACIDADE_TOTAL = 8000; // litros
const LITROS_POR_PORCENTO = CAPACIDADE_TOTAL / 100;

function calcularConsumoPercentual(nivelAnterior, nivelAtual) {
    if (nivelAnterior === null || nivelAtual === null) return 0;
    const diffPct = nivelAnterior - nivelAtual;
    if (diffPct <= 0) return 0;
    return Math.round(diffPct * LITROS_POR_PORCENTO);
}

function filtrarAbastecimentosPorPeriodo(abastecimentos, inicio, fim) {
    return abastecimentos.filter(a => a.timestamp >= inicio && a.timestamp <= fim);
}

async function salvarAbastecimento(litros) {
    const payload = {
        litros: Number(litros),
        timestamp: Date.now()
    };

    await fetch(`${FIREBASE_BASE}/abastecimentos.json`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
        },
        body: JSON.stringify(payload)
    });
}

</script>
</body>
</html>
</textarea>

<!-- ========================================================================= -->
<!-- SCRIPT DO DASHBOARD PRINCIPAL (E LÓGICA DE ABERTURA DOS APPS)             -->
<!-- ========================================================================= -->
<script>
// --- CONFIGURAÇÃO ---
const DB_BASE = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";

// Lista de Praças (PP)
const listPP = [
    { id: 'pp1', name: 'PP 01', active: true, firebaseDataPath: '/PP1.json', firebaseConfigPath: '/PP1_config', firebaseHistPath: '/PP1_historico', title: 'Praça de Pedágio 01' },
    { id: 'pp2', name: 'PP 02', active: true, firebaseDataPath: '/PP2.json', firebaseConfigPath: '/PP2_config', firebaseHistPath: '/PP2_historico', title: 'Praça de Pedágio 02' },
    { id: 'pp3', name: 'PP 03', active: true, firebaseDataPath: '/PP3.json', firebaseConfigPath: '/PP3_config', firebaseHistPath: '/PP3_historico', title: 'Praça de Pedágio 03' },
    { id: 'pp4', name: 'PP 04', active: true, firebaseDataPath: '/PP4.json', firebaseConfigPath: '/PP4_config', firebaseHistPath: '/PP4_historico', title: 'Praça de Pedágio 04' },
    { id: 'pp5', name: 'PP 05', active: true, firebaseDataPath: '/PP5.json', firebaseConfigPath: '/PP5_config', firebaseHistPath: '/PP5_historico', title: 'Praça de Pedágio 05' },
    { id: 'pp6', name: 'PP 06', active: true, firebaseDataPath: '/PP6.json', firebaseConfigPath: '/PP6_config', firebaseHistPath: '/PP6_historico', title: 'Praça de Pedágio 06' },
    { 
        id: 'pp7', 
        name: 'PP 07', 
        active: true, 
        firebaseDataPath: '/PP7.json',
        firebaseConfigPath: '/PP7_config',
        firebaseHistPath: '/PP7_config/historico', // Mantido para compatibilidade do PP7
        title: 'Praça de Pedágio 07 - Capim Branco/MG'
    }
];

// Lista de SAUs
const listSAU = [
    { id: 'sau01', name: 'SAU 01', active: true, firebaseDataPath: '/SAU01.json', firebaseConfigPath: '/SAU01_config', firebaseHistPath: '/SAU01_historico', title: 'SAU 01' },
    { id: 'sau02', name: 'SAU 02', active: true, firebaseDataPath: '/SAU02.json', firebaseConfigPath: '/SAU02_config', firebaseHistPath: '/SAU02_historico', title: 'SAU 02' },
    { id: 'sau03', name: 'SAU 03', active: true, firebaseDataPath: '/SAU03.json', firebaseConfigPath: '/SAU03_config', firebaseHistPath: '/SAU03_historico', title: 'SAU 03' },
    { id: 'sau04', name: 'SAU 04', active: true, firebaseDataPath: '/SAU04.json', firebaseConfigPath: '/SAU04_config', firebaseHistPath: '/SAU04_historico', title: 'SAU 04' },
    { id: 'sau05', name: 'SAU 05', active: true, firebaseDataPath: '/SAU05.json', firebaseConfigPath: '/SAU05_config', firebaseHistPath: '/SAU05_historico', title: 'SAU 05' },
    { id: 'sau06', name: 'SAU 06', active: true, firebaseDataPath: '/SAU06.json', firebaseConfigPath: '/SAU06_config', firebaseHistPath: '/SAU06_historico', title: 'SAU 06' },
    { id: 'sau07', name: 'SAU 07', active: true, firebaseDataPath: '/SAU07.json', firebaseConfigPath: '/SAU07_config', firebaseHistPath: '/SAU07_historico', title: 'SAU 07' },
    { id: 'sau08', name: 'SAU 08', active: true, firebaseDataPath: '/SAU08.json', firebaseConfigPath: '/SAU08_config', firebaseHistPath: '/SAU08_historico', title: 'SAU 08' },
    { id: 'sau09', name: 'SAU 09', active: true, firebaseDataPath: '/SAU09.json', firebaseConfigPath: '/SAU09_config', firebaseHistPath: '/SAU09_historico', title: 'SAU 09' },
    { id: 'sau10', name: 'SAU 10', active: true, firebaseDataPath: '/SAU10.json', firebaseConfigPath: '/SAU10_config', firebaseHistPath: '/SAU10_historico', title: 'SAU 10' },
    { id: 'sau11', name: 'SAU 11', active: true, firebaseDataPath: '/SAU11.json', firebaseConfigPath: '/SAU11_config', firebaseHistPath: '/SAU11_historico', title: 'SAU 11' },
    { id: 'sau12', name: 'SAU 12', active: true, firebaseDataPath: '/SAU12.json', firebaseConfigPath: '/SAU12_config', firebaseHistPath: '/SAU12_historico', title: 'SAU 12' },
    { 
        id: 'sau13', 
        name: 'SAU 13', 
        active: true, 
        firebaseDataPath: '/SAU13.json',
        firebaseConfigPath: '/SAU13_config',
        firebaseHistPath: '/SAU13_historico',
        title: 'SAU 13 - Capim Branco/MG'
    },
    { id: 'sau14', name: 'SAU 14', active: true, firebaseDataPath: '/SAU14.json', firebaseConfigPath: '/SAU14_config', firebaseHistPath: '/SAU14_historico', title: 'SAU 14' }
];

// --- RENDERIZAR CARDS NO DASHBOARD ---
function renderGrid(containerId, list, iconClass) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    list.forEach(item => {
        const cls = item.active ? '' : 'inactive';
        const action = item.active 
            ? `onclick="prepararAbertura('${item.id}')"` 
            : '';
        
        container.innerHTML += `
            <div class="card ${cls}" id="card-${item.id}" ${action}>
                <div class="card-water-bg" id="bg-${item.id}"></div>
                <div class="card-content">
                    <div class="live-dot"></div>
                    <div class="simulated-badge" title="Valor Estimado">!</div>
                    <i class="${iconClass} card-icon"></i>
                    <div class="card-title">${item.name}</div>
                    <div class="card-level" id="lvl-${item.id}">--%</div>
                    <div class="card-status">${item.active ? 'Clique para abrir' : 'Offline'}</div>
                </div>
            </div>
        `;
    });
}

function findItemById(id) {
    let item = listPP.find(i => i.id === id);
    if(!item) item = listSAU.find(i => i.id === id);
    return item;
}

// --- LÓGICA DE ABERTURA DE APPS ---
let dashboardInterval = null;

function prepararAbertura(id) {
    const item = findItemById(id);
    if (!item) return;

    let rawHTML = document.getElementById('app-template').value;

    rawHTML = rawHTML.replace(/__APP_TITLE__/g, item.title);
    rawHTML = rawHTML.replace('__FIREBASE_DATA_PATH__', item.firebaseDataPath);
    rawHTML = rawHTML.replace('__FIREBASE_CONFIG_PATH__', item.firebaseConfigPath);
    rawHTML = rawHTML.replace('__FIREBASE_HIST_PATH__', item.firebaseHistPath);
    rawHTML = rawHTML.replace(/__STORAGE_KEY_PREFIX__/g, item.id); 

    abrirApp(rawHTML);
}

function abrirApp(htmlContent) {
    const overlay = document.getElementById('app-overlay');
    const iframe = document.getElementById('app-frame');
    iframe.srcdoc = htmlContent;
    overlay.classList.add('active');
    if(dashboardInterval) clearInterval(dashboardInterval);
}

function fecharApp() {
    const overlay = document.getElementById('app-overlay');
    const iframe = document.getElementById('app-frame');
    iframe.srcdoc = "";
    overlay.classList.remove('active');
    updateDashboardData();
    dashboardInterval = setInterval(updateDashboardData, 5000);

// ===== AUTO-ABRIR APP (MIT APP INVENTOR / WEBVIEW) =====
function getQueryParam(name) {
    try { return new URLSearchParams(window.location.search).get(name); }
    catch(e) { return null; }
}
const IS_WEBVIEW = /wv|Android/i.test(navigator.userAgent);

window.addEventListener('load', () => {
    const openId = (getQueryParam('open') || '').toLowerCase();
    const targetId = openId || (IS_WEBVIEW ? 'pp7' : '');
    if (targetId) {
        const item = [...listPP, ...listSAU].find(x => x.id === targetId);
        if (item) abrirApp(item);
    }
});

}

function calcularNivelSimuladoLatch(nivelInicial, timestampInicial) {
    const agora = Date.now();
    let horasPassadas = (agora - timestampInicial) / (1000 * 60 * 60);
    let nivelSimulado = nivelInicial;
    let quedasAplicadas = 0;

    while (horasPassadas > 0 && nivelSimulado > 0) {
        let duracaoBloco = 2;
        quedasAplicadas++;
        if (quedasAplicadas <= 4) { duracaoBloco = 8; }
        else if (quedasAplicadas <= 6) { duracaoBloco = 6; }
        else if (quedasAplicadas <= 8) { duracaoBloco = 4; }
        else { duracaoBloco = 2; }

        if (horasPassadas >= duracaoBloco) {
            nivelSimulado -= 5;
            horasPassadas -= duracaoBloco;
        } else {
            break;
        }
    }
    if (nivelSimulado < 0) nivelSimulado = 0;
    return nivelSimulado;
}

async function fetchLastValidFromHistory(histPath) {
    try {
        const today = new Date().toISOString().split('T')[0];
        const r = await fetch(`${DB_BASE}${histPath}/${today}.json?orderBy="$key"&limitToLast=1`);
        const d = await r.json();
        if(d) {
            const keys = Object.keys(d);
            if(keys.length > 0) {
                const lastEntry = d[keys[0]];
                return {
                    pct: lastEntry.nivel_pct || lastEntry.nivel || 0,
                    time: lastEntry.timestamp || 0
                };
            }
        }
    } catch(e) { console.log('Erro ao buscar historico backup', e); }
    return null;
}

async function updateDashboardData() {
    const activeItems = [...listPP, ...listSAU].filter(i => i.active);
    
    for (const item of activeItems) {
        try {
            const r = await fetch(`${DB_BASE}${item.firebaseDataPath}?nocache=${Date.now()}`);
            const d = await r.json();
            
            let lvl = 0;
            let isSimulated = false;
            let rawLvl = 0;

            if(d) {
                if(d.nivel_pct !== undefined) rawLvl = Number(d.nivel_pct);
                else if(d.nivel !== undefined) rawLvl = Number(d.nivel);
                else if(d.percentual_atual !== undefined) rawLvl = Number(d.percentual_atual);
            }
            
            if (rawLvl > 0) {
                lvl = rawLvl;
                isSimulated = false;
            } else {
                let lastValidPct = 0;
                let lastValidTime = 0;

                if (d && d.ultima_valida_pct > 0 && d.ultima_valida_time > 0) {
                     lastValidPct = d.ultima_valida_pct;
                     lastValidTime = d.ultima_valida_time;
                } else {
                    const histData = await fetchLastValidFromHistory(item.firebaseHistPath);
                    if(histData) {
                        lastValidPct = histData.pct;
                        lastValidTime = histData.time;
                    }
                }

                if (lastValidPct > 0) {
                    lvl = calcularNivelSimuladoLatch(lastValidPct, lastValidTime);
                    isSimulated = true;
                } else {
                    lvl = 0; 
                }
            }
            
            const card = document.getElementById(`card-${item.id}`);
            const elLvl = document.getElementById(`lvl-${item.id}`);
            const elBg = document.getElementById(`bg-${item.id}`);
            
            if(card && elLvl) {
                elLvl.innerText = `${lvl}%`;
                if(elBg) elBg.style.height = `${lvl}%`;

                const dot = card.querySelector('.live-dot');
                const badge = card.querySelector('.simulated-badge');
                
                if (rawLvl > 0) {
                    dot.style.display = 'block';
                    badge.style.display = 'none';
                } else {
                    dot.style.display = 'none';
                    if (isSimulated && lvl > 0) badge.style.display = 'flex';
                    else badge.style.display = 'none';
                }
                
                card.removeAttribute('data-status');
                
                if (isSimulated && lvl > 0) {
                    card.setAttribute('data-status', 'simulated');
                    elLvl.style.color = '#d97706';
                } else {
                    if(lvl > 60) {
                        card.setAttribute('data-status', 'ok');
                        elLvl.style.color = 'var(--level-ok)';
                    } else if (lvl > 30) {
                        card.setAttribute('data-status', 'warn');
                        elLvl.style.color = 'var(--level-warn)';
                    } else {
                        card.setAttribute('data-status', 'danger');
                        elLvl.style.color = 'var(--level-danger)';
                    }
                }
            }
        } catch(e) { console.log(e); }
    }
}

let isDark = false;
function toggleTheme() {
    isDark = !isDark;
    if(isDark) {
        document.body.setAttribute('data-theme', 'dark');
        document.querySelector('.theme-toggle i').classList.replace('fa-moon', 'fa-sun');
    } else {
        document.body.removeAttribute('data-theme');
        document.querySelector('.theme-toggle i').classList.replace('fa-sun', 'fa-moon');
    }
}

window.onload = () => {
    renderGrid('grid-pp', listPP, 'fas fa-road'); 
    renderGrid('grid-sau', listSAU, 'fas fa-home'); 
    updateDashboardData();
    dashboardInterval = setInterval(updateDashboardData, 5000); 
};

function gerarLabels24h() {
    const labels = [];
    for (let h = 0; h < 24; h++) {
        labels.push(String(h).padStart(2, '0') + ':00');
    }
    return labels;
}

const CAPACIDADE_TOTAL = 8000; // litros
const LITROS_POR_PORCENTO = CAPACIDADE_TOTAL / 100;

function calcularConsumoPercentual(nivelAnterior, nivelAtual) {
    if (nivelAnterior === null || nivelAtual === null) return 0;
    const diffPct = nivelAnterior - nivelAtual;
    if (diffPct <= 0) return 0;
    return Math.round(diffPct * LITROS_POR_PORCENTO);
}

function filtrarAbastecimentosPorPeriodo(abastecimentos, inicio, fim) {
    return abastecimentos.filter(a => a.timestamp >= inicio && a.timestamp <= fim);
}

async function salvarAbastecimento(litros) {
    const payload = {
        litros: Number(litros),
        timestamp: Date.now()
    };

    await fetch(`${FIREBASE_BASE}/abastecimentos.json`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
        },
        body: JSON.stringify(payload)
    });
}

</script>
</body>
</html>
