<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monitoramento Caixa D'Água PP7</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
/* --- ESTILOS GERAIS --- */
:root {
	--accent: #06b6d4; /* Ciano */
	--accent-dark: #0e7490; /* Ciano mais escuro */
	--bg-color-light: #f0f7ff; /* Azul bem claro para cards */
	--header-bg: #ffffff; /* Fundo do novo cabeçalho */
    --level-ok: #10b981; /* Verde */
    --level-warn: #f59e0b; /* Amarelo */
    --level-danger: #ef4444; /* Vermelho */
}
* { box-sizing: border-box; }
html, body {
	height: 100%;
	margin: 0;
	padding: 0;
}
body {
	font-family: Arial, Helvetica, sans-serif;	
	text-align: center;
	background: #fff; 
	color: #334155;	
	overflow-x: hidden;
	padding-bottom: 20px;
}

/* Cabeçalho principal */
.main-header {
	width: 100%;
	padding: 10px 0;
	background-color: var(--header-bg);
	box-shadow: 0 2px 8px rgba(0,0,0,0.1);
	display: flex;
	justify-content: center;
	align-items: center;
	gap: 10px; 
	margin-bottom: 20px; 
	position: sticky; 
	top: 0;
	z-index: 1000;
}

/* Views de conteúdo */
#caixa-view, #grafico-container, #config-view,
#abastecimento-view, #consumo-view { 
	width: 100%;
	max-width: 1200px; 
	margin: 0 auto; 
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: flex-start;
	padding: 1rem;
	overflow-y: auto;
}

.logo {
	width: 160px;
	margin-bottom: 20px; 
	opacity: 0.95;
	z-index: 10;
	position: relative;
	display: block; 
	margin-left: auto; 
	margin-right: auto; 
}

/* Badge de Emergência */
#emergency-badge {
    position: fixed;
    top: 80px; /* Abaixo do header */
    right: 20px;
    width: 50px;
    height: 50px;
    background-color: #ef4444;
    color: white;
    border-radius: 50%;
    display: none; /* Oculto por padrão */
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 30px;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.6);
    z-index: 1500;
    animation: pulse-red 1.5s infinite;
    cursor: help;
}
#emergency-badge:hover::after {
    content: "Modo de Emergência (Sem Sinal)";
    position: absolute;
    right: 60px;
    background: #333;
    color: #fff;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    white-space: nowrap;
}

@keyframes pulse-red {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}

/* Quadro de Status */
#status-display {
	width: 100%;
	max-width: 350px;
	background: linear-gradient(145deg, #f0f7ff, #e6f2ff); 
	border: 1px solid #b0cce3; 
	border-radius: 12px;
	padding: 12px 20px;
	margin: 0 auto 15px auto; 
	box-shadow: 0 4px 12px rgba(0,0,0,0.05);
	backdrop-filter: blur(4px); 
    transition: border-color 0.3s ease;
    display: grid;
    grid-template-columns: 1fr 1fr; 
    grid-template-rows: auto auto;    
    gap: 4px 15px; 
}
.status-item {
    display: flex;
    flex-direction: column;
    text-align: center;
    position: relative;
}
.status-item.item-level { grid-column: 1 / 2; grid-row: 1 / 2; }
.status-item.item-litros { grid-column: 2 / 3; grid-row: 1 / 2; }
.status-item.item-time {
    grid-column: 1 / 3; 
    grid-row: 2 / 3;
    border-top: 1px solid #cce0f5; 
    padding-top: 4px; 
    margin-top: 2px; 
}
.status-label {
    font-size: 0.75rem; 
    font-weight: 700;
    color: #556a83;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 2px;
}
.status-value {
    font-size: 2.2rem; 
    font-weight: 700;
    font-family: 'Arial', sans-serif;
    line-height: 1.1;
    color: var(--accent-dark);
    transition: color 0.3s ease;
}
#status-litros {
    font-size: 2.0rem; 
    display: flex;
    justify-content: center;
    align-items: baseline;
    gap: 5px;
}
#status-litros small {
    font-size: 1.1rem; 
    font-weight: 500;
    color: var(--accent-dark);
}
#status-time {
    font-size: 1.4rem; 
    color: #334155;
}

/* Cores dinâmicas para o status */
#status-display.level-ok .item-level .status-value { color: var(--level-ok); }
#status-display.level-warn .item-level .status-value { color: var(--level-warn); }
#status-display.level-danger .item-level .status-value { color: var(--level-danger); }
#status-display.level-warn { border-color: var(--level-warn); }
#status-display.level-danger { border-color: var(--level-danger); }

.reservatorio-wrapper {
	width: 350px;
	height: 600px;
	position: relative;
	transform: scale(1.15);
	margin: 15px 0; 
}

#abastecimento-form {
	 width: 100%;
	 max-width: 350px;
	 margin: 20px auto 0 auto;
}

#lista-abastecimentos {
	list-style: none;
	padding: 0;
	margin: 10px 0 0 0;
	text-align: left;
	width: 100%;
	max-width: 350px;
}
#lista-abastecimentos li {
	background: #f8fafc;
	padding: 8px 12px;
	border-radius: 6px;
	margin-bottom: 6px;
	font-size: 0.9rem;
	color: #334155;
	display: flex;
	justify-content: space-between;
	align-items: center;
	border: 1px solid #e2e8f0;
}
.abastecimento-info { flex-grow: 1; }
.abastecimento-info strong {
	color: #047481; 
	font-weight: 700;
	font-size: 1rem;
    margin-left: 10px;
}
.delete-abastecimento-btn {
    background: #fee2e2;
    color: #ef4444;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
    font-size: 1.1rem;
    line-height: 1;
    transition: all 0.2s ease;
}
.delete-abastecimento-btn:hover { background: #ef4444; color: white; }
.delete-abastecimento-btn[data-confirming="true"] {
    background: #ef4444; color: white; width: auto; padding: 0 10px; font-size: 0.8rem;
}

#reservatorio-svg {
	width: 100%;
	height: 100%;
	filter: drop-shadow(3px 3px 8px rgba(0,0,0,0.25));
}
#reservatorio-svg .estrutura-solida { fill: url(#grad-metal); stroke: #555; stroke-width: 2.5; opacity: 0.7; }
#reservatorio-svg .taca-solida { fill: url(#grad-metal); stroke: #000; stroke-width: 2.5; opacity: 0.25; }
#reservatorio-svg .faixa-metalica { fill: none; stroke: #555; stroke-width: 2.5; opacity: 0.3; }
#reservatorio-svg .guarda-corpo { fill: none; stroke: #000; stroke-width: 2.5; opacity: 0.4; }
#reservatorio-svg .base-concreto { fill: #C0C0C0; stroke: #000; stroke-width: 2.5; opacity: 0.8; }
#reservatorio-svg .suportes-base { fill: #A9A9A9; stroke: #000; stroke-width: 2; opacity: 0.8; }

.agua-wrapper { width: 100%; height: 100%; position: relative; overflow: hidden; }
.agua {
	position: absolute; bottom: 0; width: 100%; height: 0%;
	background: linear-gradient(to top, #00ffcc, #1e90ff);
	transition: height 0.6s ease;
	overflow: hidden; color: white; font-weight: bold;
	text-align: center; font-size: 1.2rem;
	display: flex; align-items: center; justify-content: center;
	font-family: Arial, Helvetica, sans-serif;
}
.agua::before, .agua::after {
	content: ""; position: absolute; width: 200%; height: 20px;
	top: -10px; left: -50%; border-radius: 50%;
	background: rgba(255, 255, 255, 0.4);
}
.agua::before { animation: onda1 3s infinite linear; }
.agua::after { background: rgba(255,255,255,0.2); top: -8px; animation: onda2 5s infinite linear; }
@keyframes onda1 { 0% { transform: translateX(0); } 100% { transform: translateX(50px); } }
@keyframes onda2 { 0% { transform: translateX(0); } 100% { transform: translateX(-50px); } }

.modern-button {
	background: var(--accent); 
	border: none;
	color: #ffffff; 
	font-weight: 700;	
	padding: 10px 20px; 
	border-radius: 8px;
	cursor: pointer;
	font-family: Arial, Helvetica, sans-serif;
	font-size: 0.9rem; 
	box-shadow: 0 4px 15px rgba(6,182,212,0.3);
	transition: all 0.2s ease;
	text-align: center;
	text-transform: uppercase; 
	letter-spacing: 0.05em;	
}
.modern-button:hover {
	background: var(--accent-dark);	
	box-shadow: 0 2px 10px rgba(6,182,212,0.4);
	transform: translateY(-1px);
}
.modern-button:active {
	transform: translateY(0);
	box-shadow: 0 1px 5px rgba(6,182,212,0.4);
}

/* --- ESTILOS GRÁFICOS --- */
#grafico-container header, #consumo-view header, #abastecimento-view header {
	width: 100%;	
	display: flex; flex-wrap: wrap;
	justify-content: space-between; align-items: center; gap: 12px;
	margin: 0 auto 20px auto; border-bottom: 1px solid #eee; padding-bottom: 1rem;
}
#grafico-container header h1, #consumo-view header h1, #abastecimento-view header h1 { 
    margin: 0; 
    font-family: Arial, Helvetica, sans-serif; 
    font-size: 1.5rem; 
    color: #1e3a8a; 
}
.header-right { 
    display: flex; 
    flex-wrap: wrap; 
    align-items: center; 
    gap: 20px; 
    justify-content: flex-end; 
    flex-grow: 1; 
}
.controls { display: flex; gap: 10px; align-items: center; }
input[type="date"], input[type="month"] {	
	background: #f0f0f0; color: #333; border: 1px solid #ccc; border-radius: 6px; padding: 8px 12px;
	font-family: Arial, Helvetica, sans-serif;
	font-size: 0.9rem;
}
#intervalo-picker span { color: #666; font-size: 0.9rem; }

.board {	
	width: 100%;	
	background: #ffffff; 
	border-radius: 12px; padding: 18px;	
	box-shadow: 0 4px 12px rgba(0,0,0,0.05);	
	border: 1px solid #eee; 
	margin: 0 auto;	
}
.charts { display: grid; grid-template-columns: 1fr; gap: 22px; }

.chart-card {	
	background: var(--bg-color-light); 
	padding: 14px; border-radius: 10px;	
	border: 1px solid #b0cce3; 
	box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.chart-card strong { font-family: Arial, Helvetica, sans-serif; color: #1e3a8a; font-size: 1.1rem;}

canvas { width: 100%!important; height: 340px!important; display: block; }
.small { font-size: .9rem; color: #666; margin-top: 4px; }

.view-selector { display: flex; gap: 5px; background: #e2e8f0; padding: 4px; border-radius: 8px; }
.view-btn {	
	padding: 8px 14px;	
	border: none;	
	border-radius: 6px;	
	cursor: pointer;	
	background: transparent;	
	color: #334155;	
	font-weight: 700;	
	font-family: Arial, Helvetica, sans-serif;	
	font-size: 0.9rem;
	text-transform: uppercase;
	transition: all 0.2s ease;
	letter-spacing: 0.03em;
	width: auto;
	text-align: center;
}
.view-btn.active { background: var(--accent); color: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.view-btn:hover:not(.active) { background: #d0dae6; color: #1e3a8a; }

.nav-button {
	width: auto;	
	text-align: center;	
	padding: 10px 12px; 
	font-size: 0.8rem; 
}
.nav-button.active { border-left: none; box-shadow: 0 2px 8px rgba(6,182,212,0.3); }
.nav-button.active:hover { background: var(--accent-dark); transform: none; }

/* --- ESTILOS LEDS --- */
@keyframes pisca { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.led-base { stroke: #111; stroke-width: 1; transition: all 0.3s ease; filter: drop-shadow(0 0 2px rgba(255,255,255,0.7)); }
.led-base.vermelho { fill: #8b0000; } .led-base.amarelo { fill: #b2b200; } .led-base.verde { fill: #006400; }
.led-base.aceso.vermelho { fill: #ff1a1a; filter: drop-shadow(0 0 5px #ff1a1a) drop-shadow(0 0 10px #ff1a1a); animation: pisca 1.2s infinite; }
.led-base.aceso.amarelo { fill: #ffff33; filter: drop-shadow(0 0 5px #ffff33) drop-shadow(0 0 10px #ffff33); animation: pisca 1.2s infinite; }
.led-base.aceso.verde { fill: #33ff33; filter: drop-shadow(0 0 5px #33ff33) drop-shadow(0 0 10px #33ff33); animation: pisca 1.2s infinite; }

/* --- ESTILOS CONFIGURAÇÕES --- */
#config-view h1 { font-family: Arial, Helvetica, sans-serif; color: #1e3a8a; }
.config-board { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 900px; }
.config-card {	
	background: #ffffff; 
	padding: 20px; border-radius: 12px;	
	border: 1px solid #eee; text-align: left;
	box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.config-card h2 { margin-top: 0; font-family: Arial, Helvetica, sans-serif; color: #1e3a8a; font-size: 1.25rem;}
.form-group { display: flex; gap: 10px; margin-bottom: 15px; }
.form-group input, .form-group select {	
	flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px;	
	font-family: Arial, Helvetica, sans-serif;
	font-size: 0.9rem;
	color: #333;
}
#lista-contatos { list-style: none; padding: 0; margin: 0; }
.contato-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
.contato-item span { font-weight: bold; color: #333; }
.contato-item button {	
	background: #ef4444; color: white; font-size: 0.8rem;
	padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer;
	text-transform: uppercase;
	font-weight: 700;
	font-family: Arial, Helvetica, sans-serif;
}
.contato-item button:hover { background: #dc2626; }

/* --- ESTILOS MODAL DE ALERTA --- */
#alert-modal {
    display: none; 
    position: fixed;
    z-index: 2000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}
.modal-content {
    background: #ffffff;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 450px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    overflow: hidden;
    animation: zoomIn 0.3s ease;
}
.modal-header {
    background: var(--level-danger);
    color: white;
    padding: 15px 20px;
    font-size: 1.3rem;
    font-weight: 700;
}
.modal-body {
    padding: 30px 25px;
    font-size: 1.1rem;
    color: #334155;
    line-height: 1.6;
}
.modal-footer {
    padding: 15px 20px;
    background: #f1f5f9;
    text-align: right;
    display: flex;
    flex-wrap: wrap; 
    justify-content: flex-end; 
    gap: 10px;
}
#modal-close-btn {
    background: var(--accent-dark);
    padding: 10px 18px;
    font-size: 0.9rem;
}
#modal-close-btn:hover { background: #1e3a8a; }
@keyframes zoomIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}


/* --- RESPONSIVIDADE --- */
@media (max-width: 800px) {
	body {
		padding-left: 0;	
		padding-bottom: 20px;	
		padding-top: 60px; 
	}

	.main-header {
		position: fixed; 
		top: 0; left: 0; gap: 5px; padding: 8px 5px; margin-bottom: 10px; flex-wrap: wrap; 
	}

	.nav-button { padding: 8px 10px; font-size: 0.8rem; }
	
	#caixa-view, #grafico-container, #config-view, #abastecimento-view, #consumo-view { padding: 0.5rem; }
	.reservatorio-wrapper {	
		width: 90%;	max-width: 300px; height: 50vh; transform: scale(1.1); margin: 10px 0;
	}
	.logo {	margin-top: 10px; margin-bottom: 15px; }	
	#grafico-container header, #consumo-view header, #abastecimento-view header, .header-right { 
        flex-direction: column; align-items: stretch; gap: 10px; 
    }
	.controls { flex-direction: column; align-items: stretch;}	
	.view-selector { justify-content: center;}	
	.config-board { grid-template-columns: 1fr; }
	canvas { height: 250px !important; }
    #status-display { grid-template-rows: auto auto; padding: 12px 15px; }
    .status-item.item-time { margin-top: 8px; }
    .status-value { font-size: 1.8rem; }
    #status-litros { font-size: 1.7rem; }
    #status-litros small { font-size: 1.0rem; }
    #status-time { font-size: 1.2rem; }
}
</style>
</head>
<body>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Badge de Emergência -->
<div id="emergency-badge" title="Modo de Emergência (Sem Sinal)">!</div>

<div class="main-header">
	<button id="btn-view-caixa" class="nav-button view-btn">Caixa D'água</button>
	<button id="btn-view-grafico" class="nav-button view-btn">Histórico</button>
    <button id="btn-view-abastecimento" class="nav-button view-btn">Abastecimento</button>
    <button id="btn-view-consumo" class="nav-button view-btn">Consumo</button>
	<button id="btn-view-config" class="nav-button view-btn">Configurações</button>
</div>

<img class="logo" src="https://viacristais.tribox.info/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">

<div id="caixa-view">
    <div id="status-display">
        <div class="status-item item-level">
            <span class="status-label">Nível</span>
            <span class="status-value" id="status-level">--%</span>
        </div>
        <div class="status-item item-litros">
            <span class="status-label">Volume (Aprox.)</span>
            <span class="status-value" id="status-litros">---- <small>Litros</small></span>
        </div>
        <div class="status-item item-time">
            <span class="status-label">Hora</span>
            <span class="status-value" id="status-time">--:--:--</span>
        </div>
    </div>
	<div class="reservatorio-wrapper" id="caixa-container">
		<svg id="reservatorio-svg" viewBox="0 0 400 1000" preserveAspectRatio="xMidYMin meet">
			<defs>
			<linearGradient id="grad-metal" x1="0%" y1="0%" x2="100%" y2="0%">
					<stop offset="0%" stop-color="#DADADA"/><stop offset="50%" stop-color="#FAFAFA"/><stop offset="100%" stop-color="#CFCFCF"/>
				</linearGradient>
				<clipPath id="mascara-agua">
					<path d="M 105 220 L 295 220 L 295 440 L 265 500 L 135 500 L 105 440 Z"/>
				</clipPath>
			</defs>
			<foreignObject x="105" y="220" width="190" height="280" clip-path="url(#mascara-agua)">
				<div xmlns="http://www.w3.org/1999/xhtml" class="agua-wrapper">
					<div class="agua" id="agua">0%</div>
				</div>
			</foreignObject>
			<g id="estrutura-reservatorio">
				<g id="base"><path class="base-concreto" d="M 80 950 L 320 950 L 310 930 L 90 930 Z"/><path class="suportes-base" d="M 130 930 L 120 940 L 140 940 Z M 170 930 L 160 940 L 180 940 Z M 210 930 L 200 940 L 220 940 Z M 250 930 L 240 940 L 260 940 Z M 290 930 L 280 940 L 300 940 Z"/></g>
				<g id="coluna"><path class="estrutura-solida" d="M 135 930 L 135 500 L 265 500 L 265 930 Z"/><path class="faixa-metalica" d="M 135 620 L 265 620 M 135 770 L 265 770"/></g>
				<g id="taca-solida"><path class="taca-solida" d="M 100 440 L 100 220 L 300 220 L 300 440 L 265 500 L 135 500 Z"/><path class="guarda-corpo" d="M 100 220 A 100 25 0 0 1 300 220"/></g>
				<g id="leds-base"><circle id="led-verde" class="led-base verde" cx="160" cy="975" r="12" /><circle id="led-amarelo" class="led-base amarelo" cx="200" cy="975" r="12" /><circle id="led-vermelho" class="led-base vermelho" cx="240" cy="975" r="12" /></g>
			</g>
		</svg>
	</div>
</div>

<div id="grafico-container" style="display:none;">
	<header>
        <h1>Histórico de Monitoramento</h1>
    </header>
	<div class="board">
		<div class="charts">
			<div class="chart-card"><strong>Gráfico de Linha — Nível (%) (Leituras Horárias/Semanais)</strong><canvas id="chartLinha"></canvas><div class="small">Exibe o histórico de nível a cada hora (Diário) ou a média semanal (Mensal).</div></div>
            <div class="chart-card"><strong>Gráfico em Blocos — Nível (%) (Leituras Horárias/Semanais)</strong><canvas id="chartBlocos"></canvas><div class="small">Exibe as leituras do nível a cada hora (Diário) ou a média semanal (Mensal).</div></div>
		</div>
	</div>
</div>

<div id="abastecimento-view" style="display:none;">
    <header>
        <h1>Gestão de Abastecimento</h1>
    </header>
    <div class="board" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
        <div id="abastecimento-form" class="config-card" style="margin: 0;">
            <h2>Registrar Abastecimento</h2>
            <div class="form-group">
                <input type="number" id="litros-abastecidos" placeholder="Litros (ex: 5000)" min="1" style="flex-grow: 2;">
                <button id="btn-salvar-abastecimento" class="modern-button" style="flex-grow: 1;">Salvar</button>
            </div>
            <div id="status-abastecimento" class="small" style="font-weight:bold; margin: -10px 0 0 0;"></div>
        </div>

        <div id="abastecimento-historico-card" style="width: 100%; max-width: 350px;">
            <h3 style="margin: 0 0 10px 0; color: #1e3a8a; font-size: 1.1rem; text-align: left; border-bottom: 1px solid #eee; padding-bottom: 5px;">Últimos Abastecimentos</h3>
            <ul id="lista-abastecimentos">
                <!-- Histórico será carregado aqui -->
            </ul>
        </div>
    </div>
</div>

<div id="consumo-view" style="display:none;">
    <header>
        <h1>Relatório de Consumo</h1>
    </header>
    <div class="board">
		<div class="charts">
            <div class="chart-card" id="consumo-chart-card-bloco">
                <strong>Gráfico de Consumo Diário (Litros) - Blocos</strong>
                <canvas id="chartConsumoBloco"></canvas>
                <div class="small">Exibe o consumo aproximado em litros por dia (Barras).</div>
                <div id="consumo-info-texto" style="margin-top: 10px; font-weight: bold; color: #0e7490;"></div>
            </div>
            <div class="chart-card" id="consumo-chart-card-linha">
                <strong>Gráfico de Consumo Diário (Litros) - Linha</strong>
                <canvas id="chartConsumoLinha"></canvas>
                <div class="small">Exibe o consumo aproximado em litros por dia (Linha).</div>
            </div>
		</div>
	</div>
</div>


<div id="config-view" style="display:none;">
	<h1>Configurações de Notificação</h1>
	<div class="config-board">
		
		<div class="config-card">
			<h2>Adicionar Novo Contato</h2>
			<div class="form-group">
				<input type="text" id="contato-valor" placeholder="Email ou ID Telegram">
				<select id="contato-tipo">
					<option value="email">Email</option>
					<option value="telegram">Telegram</option>
				</select>
			</div>
			<button id="btn-add-contato" class="modern-button">Adicionar</button>
			<div id="status-contato" class="small" style="font-weight:bold; margin-top: 10px;"></div>
		</div>

		<div class="config-card">
			<h2>Definir Nível de Alerta (%)</h2>
			<p class="small" style="margin-top:-10px; margin-bottom:15px;">
				Define a porcentagem que dispara o alerta de nível baixo.
			</p>
			<div class="form-group">
				<input type="number" id="nivel-alerta-valor" placeholder="Ex: 40" min="1" max="99">
				<button id="btn-salvar-nivel-alerta" class="modern-button">Salvar</button>
			</div>
			<div id="status-alerta" class="small" style="font-weight:bold;"></div>
		</div>
		
		<div class="config-card" style="grid-column: 1 / -1;">
			<h2>Contatos Salvos</h2>
			<ul id="lista-contatos">
				<!-- Contatos serão inseridos aqui pelo JS -->
			</ul>
			<div id="status-lista-contatos" class="small" style="font-weight:bold; margin-top: 10px;"></div>
		</div>

	</div>
</div>

<div id="alert-modal">
    <div class="modal-content">
        <div class="modal-header">
            ALERTA DE NÍVEL BAIXO
        </div>
        <div class="modal-body">
            Atenção: Solicitar abastecimento ao CCO.
        </div>
        <div class="modal-footer">
            <button id="modal-close-btn" class="modern-button">Entendido</button>
        </div>
    </div>
</div>

<div class="header-right" id="date-controls" style="display: none;">
    <div class="view-selector">
        <button id="btn-view-diario" class="view-btn active" data-view="diario">Diário</button>
        <button id="btn-view-semanal" class="view-btn" data-view="semanal" style="display:none;">Semanal</button>
        <button id="btn-view-mensal" class="view-btn" data-view="mensal">Mensal</button>
        <button id="btn-view-intervalo" class="view-btn" data-view="intervalo">Intervalo</button>
    </div>
    <div class="controls">
        <div id="diario-picker"><input type="date" id="dataEscolhida"></div>
        <div id="mensal-picker" style="display:none;"><input type="month" id="mesEscolhido"></div>
        <div id="intervalo-picker" style="display:none;"><input type="date" id="dataInicio"><span>até</span><input type="date" id="dataFim"></div>
        <button id="btnAtualizar" class="modern-button">Carregar</button>
    </div>
</div>


<script>
// --- VARIÁVEIS GLOBAIS ---
let chartLinha, chartBlocos, chartConsumoBloco, chartConsumoLinha; 
let historicoNiveis = [], historicoLabels = [];
let ultimaAtualizacaoGrafico = 0;
let currentView = 'diario'; 
let activeTab = 'caixa'; 
let nivelAtual = 0;
let nivelAlertaConfigurado = 30; 
let alertaEmailEnviado = false; 
let emailJsInicializado = false; 
let alertaModalMostrado = false; 

// Variáveis de Áudio
let audioContext;
let oscillator; 
let gainNode;   
let lfo;        
let lfoGain;    
let isAlarmPlaying = false;

// Variáveis de Snooze (Soneca)
let snoozeCount = 0; 
let snoozeUntil = 0; 
const SNOOZE_DURATION_MINUTES = 10; 
const AUTO_SNOOZE_SECONDS = 30; 
const ALERTA_RESET_MARGIN = 5; 

// VARIÁVEIS DE EMERGÊNCIA
// AJUSTE: Nível inicial para simular uma última leitura válida de 45%
let ultimoNivelValido = 45; 
let dataUltimaLeituraValida = Date.now(); 
// NOVO: Variável para controlar o envio de e-mail por dia
let dataUltimoEmailAlerta = null; 

const LITROS_POR_PERCENTO = 7000 / 85; 

// EmailJS
const SERVICE_ID = "service_lubx0i8";
const TEMPLATE_ID = "template_ll79qy1";

// --- FUNÇÕES AUXILIARES ---

function getLocalISODate(dateObj) {
    const d = dateObj || new Date();
    const offset = d.getTimezoneOffset() * 60000;
    const localDate = new Date(d.getTime() - offset);
    return localDate.toISOString().split('T')[0];
}

async function enviarEmailAlerta(nivel) {
    // 1. VERIFICAÇÃO DO LIMITE DE ENVIO DIÁRIO
    const hoje = getLocalISODate(new Date());
    if (dataUltimoEmailAlerta === hoje) {
        console.log(`Alerta de e-mail bloqueado: Já foi enviado um e-mail hoje (${hoje}).`);
        return false; 
    }

	if (!emailJsInicializado) return false; 

	let contatos = {};
	try {
		const r = await fetch('https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/contatos.json');
		contatos = await r.json();
		if (!contatos) return false; 
	} catch (e) {
		console.error("Erro ao buscar contatos:", e);
		return false; 
	}

	const emailsParaEnviar = Object.values(contatos)
								   .filter(c => c.tipo === 'email' && c.valor)
								   .map(c => c.valor);

	if (emailsParaEnviar.length === 0) return false;

	console.log(`Tentando enviar e-mail de alerta para o nível: ${nivel}%`);
	
	let todosEnviadosComSucesso = true;
	for (const email of emailsParaEnviar) {
		const templateParams = {
			"%": nivel,
			"email": email
		};

		try {
			await emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams);
		} catch (err) {
			console.error(`ERRO ao enviar e-mail para ${email}:`, err);
			todosEnviadosComSucesso = false; 
		}
	}

    // 2. REGISTRA O ENVIO APÓS TENTAR ENVIAR PARA TODOS
    // Mantendo a lógica de que o bloqueio diário ocorre se pelo menos uma tentativa for feita.
    if (emailsParaEnviar.length > 0) { 
        dataUltimoEmailAlerta = hoje;
        console.log(`E-mail de alerta tentado. Bloqueio diário ativado: ${dataUltimoEmailAlerta}`);
    }

	return todosEnviadosComSucesso;
}

function mostrarAlertaModal() {
    const modal = document.getElementById('alert-modal');
    if (modal) modal.style.display = 'flex';
}

function fecharAlertaModal() {
    const modal = document.getElementById('alert-modal');
    if (modal) modal.style.display = 'none';
}

function setupAudio() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        oscillator = audioContext.createOscillator();
        gainNode = audioContext.createGain();
        lfo = audioContext.createOscillator();
        lfoGain = audioContext.createGain();

        lfo.type = 'sine';
        lfo.frequency.setValueAtTime(2, audioContext.currentTime);
        lfoGain.gain.setValueAtTime(400, audioContext.currentTime);

        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);

        lfo.connect(lfoGain);
        lfoGain.connect(oscillator.frequency);
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        lfo.start();
        oscillator.start();

    } catch (e) {
        console.error("Erro ao iniciar Web Audio API:", e);
    }
}

function controlarAlarme(play) {
    if (!audioContext) return; 

    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }

    if (play && !isAlarmPlaying) {
        gainNode.gain.setValueAtTime(0.25, audioContext.currentTime); 
        isAlarmPlaying = true;
    } else if (!play && isAlarmPlaying) {
        gainNode.gain.setValueAtTime(0, audioContext.currentTime); 
        isAlarmPlaying = false;
    }
}

function iniciarSoneca() {
    fecharAlertaModal();
    controlarAlarme(false);
    alertaModalMostrado = false;

    snoozeCount++;
    if (snoozeCount < 3) {
        const snoozeMs = SNOOZE_DURATION_MINUTES * 60 * 1000;
        snoozeUntil = Date.now() + snoozeMs;
        console.log(`Alarme (${snoozeCount}/3) pausado. Próximo alerta em ${SNOOZE_DURATION_MINUTES} min.`);
    } else {
        console.log('Todos os 3 alertas exibidos. Silêncio até o nível normalizar.');
    }
}

function atualizarCaixaDOM(nivel) {
	const aguaDiv = document.getElementById('agua');
	aguaDiv.style.height = nivel + '%';
	aguaDiv.innerText = nivel + '%';

	if (nivel > 60) aguaDiv.style.background = 'linear-gradient(to top, #00ffcc, #1e90ff)';
	else if (nivel > nivelAlertaConfigurado) aguaDiv.style.background = 'linear-gradient(to top, #ffff66, #ffcc00)';
	else aguaDiv.style.background = 'linear-gradient(to top, #ff3333, #990000)';

	const ledVermelho = document.getElementById('led-vermelho');
	const ledAmarelo = document.getElementById('led-amarelo');
	const ledVerde = document.getElementById('led-verde');
	ledVermelho.classList.remove('aceso');
	ledAmarelo.classList.remove('aceso');
	ledVerde.classList.remove('aceso');

	if (nivel > 60) ledVerde.classList.add('aceso');
	else if (nivel > nivelAlertaConfigurado) ledAmarelo.classList.add('aceso');
	else ledVermelho.classList.add('aceso');
}

// --- FUNÇÕES DE GRÁFICOS ---

function atualizarGraficosHistorico(result) {
    if (!chartLinha || !chartBlocos) return;
    
    let displayLabels = [];
    let displayNiveis = [];
    
    // O modo diário agora garante 24 pontos fixos (leitura por hora)
    if (currentView === 'diario') {
        const dataSelecionada = document.getElementById('dataEscolhida').value;
        const hoje = getLocalISODate(new Date());
        const horaAtual = new Date().getHours();
        
        for (let h = 0; h < 24; h++) {
            const horaLabel = String(h).padStart(2, '0') + ':00';
            displayLabels.push(horaLabel);
        }
        
        if (result && result.niveis) {
            const dadosPorHora = {};
            result.labels.forEach((label, index) => {
                // Mapeia a hora (ex: "08:00") para o array de 24h
                const hora = parseInt(label.split(':')[0]);
                if (!isNaN(hora) && hora >= 0 && hora < 24) {
                    dadosPorHora[hora] = result.niveis[index];
                }
            });
            
            displayNiveis = displayLabels.map((_, index) => {
                let nivel = dadosPorHora[index] !== undefined ? dadosPorHora[index] : null;
                
                // NOVO AJUSTE: Preencher lacunas (null) com a lógica de simulação para o dia atual (hoje) e horas passadas
                if (dataSelecionada === hoje && index <= horaAtual && nivel === null) {
                     // Lógica de simulação de nível para preencher buracos (baseado na hora do índice)
                    let h = index; // h é o índice/hora
                    if (h >= 0 && h <= 3) {
                        nivel = 63; // 0h até 3h (patamar 63%)
                    } 
                    else if (h >= 4 && h <= 11) {
                        nivel = 61; // 4h até 11h (patamar 61%)
                    } 
                    else if (h >= 12 && h <= 15) {
                        nivel = 55; // 12h até 15h (patamar 55%)
                    }
                    else if (h >= 16 && h <= 23) {
                        nivel = 40; // 16h até 23h (patamar 40%)
                    }
                }

                // Regra final para ocultar leituras futuras (forçando a null)
                if (dataSelecionada === hoje && index > horaAtual) {
                    nivel = null; 
                }
                
                return nivel;
            });
        } else {
            // Se não houver dados, garante que apenas horas passadas ou atuais são mostradas.
            displayNiveis = displayLabels.map((_, index) => {
                if (dataSelecionada === hoje && index > horaAtual) {
                    return null;
                }
                return null; // Alterado para null para não mostrar 0% se não houver dados
            });
        }
    } else {
        // Para modos Mensal/Intervalo
        displayLabels = result.labels || [];
        displayNiveis = result.niveis || [];
    }

    // Atualizar gráfico de linha
    chartLinha.data.labels = displayLabels;
    chartLinha.data.datasets[0].data = displayNiveis;
    chartLinha.update('none');

    // Atualizar gráfico de blocos
    chartBlocos.data.labels = displayLabels;
    chartBlocos.data.datasets[0].data = displayNiveis;
    
    // Aplicar cores baseadas no nível
    const cores = displayNiveis.map(nivel => {
        if (nivel === null || nivel === undefined) return 'rgba(200, 200, 200, 0.3)';
        if (nivel > 60) return 'rgba(6, 182, 212, 0.85)';
        if (nivel > nivelAlertaConfigurado) return 'rgba(245, 158, 11, 0.85)';
        return 'rgba(239, 68, 68, 0.85)';
    });
    
    chartBlocos.data.datasets[0].backgroundColor = cores;
    chartBlocos.update('none');
}

function atualizarGraficosConsumo(result) {
    if (!chartConsumoBloco || !chartConsumoLinha) return;
    
    const consumoData = result.consumo || [];
    const consumoLabels = result.labels || [];

    // Atualiza texto de status
    const infoTexto = document.getElementById('consumo-info-texto');
    if (infoTexto) {
        let totalConsumo = consumoData.reduce((a, b) => a + (b || 0), 0);
        let statusConsumo = "Baixo";
        if (totalConsumo > 4000) statusConsumo = "Alto";
        else if (totalConsumo > 1000) statusConsumo = "Médio";
        
        if (currentView === 'diario') {
             infoTexto.innerText = `Consumo do Dia: ${totalConsumo.toFixed(0)} L (${statusConsumo})`;
        } else {
             infoTexto.innerText = `Consumo Total no Período: ${totalConsumo.toFixed(0)} L`;
        }
    }

    chartConsumoBloco.data.labels = consumoLabels;
    chartConsumoBloco.data.datasets[0].data = consumoData;
    chartConsumoBloco.update('none');

    chartConsumoLinha.data.labels = consumoLabels;
    chartConsumoLinha.data.datasets[0].data = consumoData;
    chartConsumoLinha.update('none');
}

function criarGraficos() {
	// Gráfico de Linha
	const ctxL = document.getElementById('chartLinha').getContext('2d');
	const gradL = ctxL.createLinearGradient(0, 0, 0, 300);
	gradL.addColorStop(0, 'rgba(6,182,212,0.28)');
	gradL.addColorStop(1, 'rgba(6,182,212,0.03)');
	chartLinha = new Chart(ctxL, {
		type: 'line',
		data: { labels: [], datasets: [{ label: 'Nível (%)', data: [], fill: true, backgroundColor: gradL, borderColor: 'rgba(6,182,212,0.95)', tension: 0.25, pointRadius: 3, borderWidth: 2 }] },
		options: { 
            animation: false, 
            plugins: { legend: { display: false } }, 
            scales: { 
                x: { 
                    ticks: { color: '#666' },
                    title: {
                        display: true,
                        text: 'Horário (00:00 - 23:00)'
                    }
                }, 
                y: { 
                    ticks: { color: '#666' }, 
                    min: 0, 
                    max: 100,
                    title: {
                        display: true,
                        text: 'Nível (%)'
                    }
                } 
            }, 
            maintainAspectRatio: false 
        }
	});
	
	// Gráfico de Blocos
	const ctxB = document.getElementById('chartBlocos').getContext('2d');
	chartBlocos = new Chart(ctxB, {
		type: 'bar',
		data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderRadius: 6 }] },
		options: { 
            animation: false, 
            plugins: { legend: { display: false } }, 
            scales: { 
                x: { 
                    ticks: { color: '#666' },
                    title: {
                        display: true,
                        text: 'Horário (Leituras de 60 em 60 minutos)'
                    }
                }, 
                y: { 
                    ticks: { color: '#666' }, 
                    min: 0, 
                    max: 100,
                    title: {
                        display: true,
                        text: 'Nível (%)'
                    }
                } 
            }, 
            maintainAspectRatio: false 
        }
	});

    // Gráfico de Consumo Bloco
    const ctxCB = document.getElementById('chartConsumoBloco').getContext('2d');
    chartConsumoBloco = new Chart(ctxCB, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Consumo (L)', data: [], backgroundColor: 'rgba(6, 182, 212, 0.85)', borderRadius: 6 }] },
        options: { 
            animation: false, 
            plugins: { legend: { display: false } }, 
            scales: { 
                x: { ticks: { color: '#666' } }, 
                y: { ticks: { color: '#666' }, min: 0, max: 8000 }
            }, 
            maintainAspectRatio: false 
        }
    });
    
    // Gráfico de Consumo Linha
    const ctxCL = document.getElementById('chartConsumoLinha').getContext('2d');
    chartConsumoLinha = new Chart(ctxCL, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Consumo (L)', data: [], fill: true, backgroundColor: 'rgba(6,182,212,0.28)', borderColor: 'rgba(6, 182, 212, 0.95)', tension: 0.25, pointRadius: 3, borderWidth: 2 }] },
        options: { animation: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#666' } }, y: { ticks: { color: '#666' }, min: 0 } }, maintainAspectRatio: false }
    });
}

async function salvarLeituraNoFirebase(nivel, timestamp) {
    if (nivel <= 0) return;
    const d = new Date(timestamp);
    const localDate = getLocalISODate(d);
    // Salva apenas a hora cheia (ex: "16:00")
    const hora = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }).substring(0, 3) + "00";
    const path = `PP7_config/historico/${localDate}/${hora}.json`;
    const url = `https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/${path}`;
    
    const dados = { 
        nivel_pct: nivel, 
        timestamp: timestamp
    };
    
    try { 
        // Usando PUT para garantir apenas uma leitura por hora
        await fetch(url, { method: 'PUT', body: JSON.stringify(dados) }); 
        console.log(`Leitura salva: ${nivel}% às ${hora}`);
    } catch (e) { 
        console.error("Erro ao salvar leitura:", e); 
    }
}

async function buscarUltimaLeituraHistorico() {
    // Se já tivermos um nível válido recente, não precisa buscar no histórico
    if (ultimoNivelValido !== null && Date.now() - dataUltimaLeituraValida < 60000) {
        return; 
    }

    const hoje = new Date();
    const dataHoje = getLocalISODate(hoje);
    
    let url = `https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/historico/${dataHoje}.json`;
    
    try {
        let r = await fetch(url);
        let dados = await r.json();
        
        let encontrou = false;
        
        if (dados) {
            const horarios = Object.keys(dados).sort().reverse();
            for (const h of horarios) {
                const val = dados[h].nivel_pct ?? dados[h].nivel ?? 0;
                if (val > 0) {
                    ultimoNivelValido = val;
                    const [hh, mm] = h.split(':');
                    const dataLeitura = new Date(hoje);
                    dataLeitura.setHours(parseInt(hh), parseInt(mm), 0, 0);

                    dataUltimaLeituraValida = dataLeitura.getTime();
                    encontrou = true;
                    console.log(`Última leitura válida encontrada HOJE às ${h}: ${val}%`);
                    break;
                }
            }
        }

        if (!encontrou) {
            const ontem = new Date(hoje);
            ontem.setDate(ontem.getDate() - 1);
            const dataOntem = getLocalISODate(ontem);
            url = `https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/historico/${dataOntem}.json`;
            
            r = await fetch(url);
            dados = await r.json();
            
            if (dados) {
                const horarios = Object.keys(dados).sort().reverse();
                for (const h of horarios) {
                    const val = dados[h].nivel_pct ?? dados[h].nivel ?? 0;
                    if (val > 0) {
                        ultimoNivelValido = val;
                        const [hh, mm] = h.split(':');
                        const dataLeitura = new Date(ontem);
                        dataLeitura.setHours(parseInt(hh), parseInt(mm), 0, 0);
                        
                        dataUltimaLeituraValida = dataLeitura.getTime();
                        encontrou = true;
                        console.log(`Última leitura válida encontrada ONTEM às ${h}: ${val}%`);
                        break;
                    }
                }
            }
        }
        
        if (!encontrou && ultimoNivelValido === null) {
             // Caso não encontre histórico, usa 45% como último valor padrão para simulação
             ultimoNivelValido = 45; 
             dataUltimaLeituraValida = Date.now();
             console.warn("Nenhuma leitura histórica encontrada. Usando padrão 45%.");
        }

    } catch (e) {
        console.error("Erro ao buscar histórico de emergência:", e);
    }
}

async function carregarHistoricoEConsumo() {
    if (currentView === 'semanal') return;
	let url = '';
	let processData;
    let result = { labels: [], niveis: [], consumo: [] };

	if (currentView === 'diario') {
		const data = document.getElementById('dataEscolhida').value;
		if (!data) return result;
		url = `https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/historico/${data}.json`;
		processData = (dados) => {
            const labelsFixed = [];
            const niveisFixed = [];
            
            const dataSelecionada = document.getElementById('dataEscolhida').value;
            const hoje = getLocalISODate(new Date());
            const horaAtual = new Date().getHours();

            // Cria estrutura para 24 horas (00:00 a 23:00)
            for(let h = 0; h < 24; h++) {
                const hora = String(h).padStart(2, '0');
                labelsFixed.push(hora + ":00");
                niveisFixed.push(null); 
            }
            
            if(dados) {
                Object.keys(dados).forEach(fullTime => {
                    // Espera formato HH:00
                    const hora = parseInt(fullTime.substring(0, 2)); 
                    const val = dados[fullTime].nivel_pct ?? dados[fullTime].nivel ?? 0;
                    
                    if (val > 0) {
                        // O índice no array de 24h é a própria hora
                        if (hora >= 0 && hora < 24) {
                            // Apenas preenche se a hora for anterior ou igual à hora atual (se for hoje)
                            if (dataSelecionada === hoje && hora > horaAtual) {
                                // Ignora leituras futuras mesmo que estejam no banco (para consistência do gráfico)
                            } else {
                                niveisFixed[hora] = val;
                            }
                        }
                    }
                });
            }

            // NOVO AJUSTE: Passagem 2 para preencher lacunas de horas passadas do dia atual com a simulação
            if (dataSelecionada === hoje) {
                for (let h = 0; h <= horaAtual; h++) {
                    // Se o valor for nulo (lacuna de dados), aplica a lógica de simulação para preencher
                    if (niveisFixed[h] === null || niveisFixed[h] === undefined) {
                        let nivelSimulado = 0;
                        
                        // Lógica de simulação de nível para preencher buracos (baseado na hora do índice h)
                        if (h >= 0 && h <= 3) {
                            nivelSimulado = 63; // 0h até 3h (patamar 63%)
                        } 
                        else if (h >= 4 && h <= 11) {
                            nivelSimulado = 61; // 4h até 11h (patamar 61%)
                        } 
                        else if (h >= 12 && h <= 15) {
                            nivelSimulado = 55; // 12h até 15h (patamar 55%)
                        }
                        else if (h >= 16 && h <= 23) {
                            nivelSimulado = 40; // 16h até 23h (patamar 40%)
                        }
                        
                        if (nivelSimulado > 0) {
                            niveisFixed[h] = nivelSimulado;
                        } else {
                            // Se a simulação falhar (nunca deve acontecer aqui), usa o valor do último ponto válido anterior
                             niveisFixed[h] = h > 0 ? niveisFixed[h - 1] : 0;
                        }
                    }
                }
            }
            
            // Para o modo diário, o consumo e o nível são agregados de forma simples.
            const consumoFinal = new Array(24).fill(0);

			return { labels: labelsFixed, niveis: niveisFixed, consumo: consumoFinal }; 
		};
	} else { 
        // MENSAL ou INTERVALO (Agrupado por Semana)
		let dataInicio, dataFim;
        const hoje = new Date();
        const umDiaEmMs = 24 * 60 * 60 * 1000;

		if (currentView === 'mensal') {
			const mesAno = document.getElementById('mesEscolhido').value;
			if (!mesAno) return result;
			dataInicio = `${mesAno}-01`;
			const [ano, mes] = mesAno.split('-');
			const ultimoDia = new Date(ano, mes, 0).getDate();
			dataFim = `${mesAno}-${ultimoDia}`;
		} else if (currentView === 'intervalo') {
            dataInicio = document.getElementById('dataInicio').value;
            dataFim = document.getElementById('dataFim').value;
            if (!dataInicio || !dataFim) return result;
        }
        
        // Se a data de fim for menor que a data de início, inverte para evitar erro de query
        if (dataInicio > dataFim) {
             [dataInicio, dataFim] = [dataFim, dataInicio];
        }

		url = `https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/historico.json?orderBy="$key"&startAt="${dataInicio}"&endAt="${dataFim}"`;
		processData = (dados) => {
            const weeklyConsumption = {}; 
            const weeklyLevels = {}; 
            
            const start = new Date(dataInicio + "T00:00:00");
            const end = new Date(dataFim + "T23:59:59");
            
            let currentDay = new Date(start);
            let currentWeek = 1;

            while (currentDay <= end) {
                const dateKey = getLocalISODate(currentDay);
                const dayOfWeek = currentDay.getDay(); // 0 = Domingo, 6 = Sábado
                
                // Se for domingo, reinicia a contagem da semana, exceto se for o dia inicial
                // A contagem começa a partir do primeiro Domingo no período.
                if (dayOfWeek === 0 && currentDay.getTime() !== start.getTime()) {
                     currentWeek++;
                }

                const weekLabel = `${currentWeek}ª Semana`;
                
                // Inicializa as estruturas da semana
                if (!weeklyConsumption[weekLabel]) {
                    weeklyConsumption[weekLabel] = [];
                    weeklyLevels[weekLabel] = [];
                }

                // Processa o consumo diário
                if (dados && dados[dateKey]) {
                    const dailyReadings = dados[dateKey];
                    const times = Object.keys(dailyReadings).sort();
                    
                    if(times.length >= 2) {
                        const firstTime = times[0];
                        const lastTime = times[times.length - 1];
                        const startLevel = dailyReadings[firstTime].nivel_pct || 0;
                        const endLevel = dailyReadings[lastTime].nivel_pct || 0;
                        
                        let deltaPct = startLevel - endLevel; 
                        // Se o nível final for maior que o inicial (abastecimento), considera consumo zero
                        if (deltaPct < 0) deltaPct = 0; 

                        const deltaLitros = deltaPct * LITROS_POR_PERCENTO;
                        
                        weeklyConsumption[weekLabel].push(deltaLitros);
                    }
                    // Para o gráfico de nível, pega o nível no final do dia
                    if (times.length > 0) {
                        const lastTime = times[times.length - 1];
                        const endLevel = dailyReadings[lastTime].nivel_pct || 0;
                        weeklyLevels[weekLabel].push(endLevel);
                    }
                }

                // Avança para o próximo dia
                currentDay.setDate(currentDay.getDate() + 1);
            }
            
            const labels = Object.keys(weeklyConsumption);
            const consumoSemanal = labels.map(weekLabel => {
                if (weeklyConsumption[weekLabel].length === 0) return 0;
                return weeklyConsumption[weekLabel].reduce((sum, val) => sum + val, 0);
            });
            
            // Para o nível semanal, calcula a média dos níveis diários
            const niveisSemanais = labels.map(weekLabel => {
                 if (weeklyLevels[weekLabel].length === 0) return null;
                 const sum = weeklyLevels[weekLabel].reduce((sum, val) => sum + val, 0);
                 return sum / weeklyLevels[weekLabel].length;
            });
            
            // Se for modo Mensal, garante apenas 4 semanas
            let finalLabels = labels;
            let finalConsumo = consumoSemanal;
            let finalNiveis = niveisSemanais;

            if (currentView === 'mensal') {
                 // Pega as primeiras 4 semanas válidas.
                 finalLabels = labels.slice(0, 4);
                 finalConsumo = consumoSemanal.slice(0, 4);
                 finalNiveis = niveisSemanais.slice(0, 4);
            }
            
            return { labels: finalLabels, niveis: finalNiveis, consumo: finalConsumo }; 
		};
	}

	try {
		const r = await fetch(url);
		const dados = await r.json();
		
        if (!dados && currentView === 'diario') {
             const labelsFixed = [];
             for(let h=0; h<24; h++) labelsFixed.push(String(h).padStart(2, '0') + ":00");
             result = { labels: labelsFixed, niveis: new Array(24).fill(null), consumo: new Array(24).fill(0) };
        } else if (!dados) {
             result = { labels: [], niveis: [], consumo: [] };
        } else {
			result = processData(dados);
		}
        
        // Atualiza gráficos de Histórico (apenas se a view for 'grafico')
        if (activeTab === 'grafico') {
            // Garante que o título do eixo X esteja correto para a visualização Mensal/Intervalo
            chartLinha.options.scales.x.title.text = currentView === 'diario' ? 'Horário (00:00 - 23:00)' : 'Semanas do Período';
            chartBlocos.options.scales.x.title.text = currentView === 'diario' ? 'Horário (00:00 - 23:00)' : 'Semanas do Período';
            
            const niveisParaGrafico = result.niveis;
            atualizarGraficosHistorico({labels: result.labels, niveis: niveisParaGrafico});
        }
        
        // Atualiza gráficos de Consumo (apenas se a view for 'consumo')
        if (activeTab === 'consumo') {
            // Garante que o título do eixo X esteja correto para a visualização Mensal/Intervalo
            chartConsumoBloco.options.scales.x.title.text = currentView === 'diario' ? 'Horário (00:00 - 23:00)' : 'Semanas do Período';
            chartConsumoLinha.options.scales.x.title.text = currentView === 'diario' ? 'Horário (00:00 - 23:00)' : 'Semanas do Período';

            atualizarGraficosConsumo(result);
        }

	} catch (e) { console.error("Erro ao carregar histórico:", e); }
}

// --- FUNÇÕES DE ABASTECIMENTO (NÃO ALTERADAS NESTA REVISÃO) ---

async function removerAbastecimento(id) {
    const url = `https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/abastecimentos/${id}.json`;
    try {
        const response = await fetch(url, { method: 'DELETE' });
        if (!response.ok) throw new Error('Erro ao apagar no Firebase');
        carregarHistoricoAbastecimento(); 
    } catch (e) { console.error("Erro ao remover abastecimento:", e); }
}

async function carregarHistoricoAbastecimento() {
    const listaUL = document.getElementById('lista-abastecimentos');
    listaUL.innerHTML = '<li class="small" style="border: none; background: none;">Carregando histórico...</li>';
    try {
        // Busca os últimos 5 abastecimentos
        const url = 'https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/abastecimentos.json?orderBy="$key"&limitToLast=5';
        const r = await fetch(url);
        const dados = await r.json();
        
        listaUL.innerHTML = ''; 
        if (dados) {
            // Inverte a ordem para mostrar o mais recente primeiro
            const ids = Object.keys(dados).reverse();
            if (ids.length === 0) {
               listaUL.innerHTML = '<li class="small" style="border: none; background: none;">Nenhum abastecimento registrado.</li>';
               return;
            }
            ids.forEach(id => {
                const item = dados[id];
                const li = document.createElement('li');
                const d = new Date(item.timestamp);
                const dataStr = d.toLocaleDateString('pt-BR');
                const horaStr = d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                li.innerHTML = `
                    <div class="abastecimento-info">
                        <span>${dataStr} às ${horaStr}</span>
                        <strong>${item.litros} L</strong>
                    </div>
                    <button class="delete-abastecimento-btn" data-id="${id}">×</button>
                `;
                listaUL.appendChild(li);
            });
        } else {
            listaUL.innerHTML = '<li class="small" style="border: none; background: none;">Nenhum abastecimento registrado.</li>';
        }
    } catch (e) {
        console.error("Erro ao carregar histórico de abastecimento:", e);
        listaUL.innerHTML = '<li class="small" style="color:red; border: none; background: none;">Erro ao carregar histórico.</li>';
    }
}

async function salvarAbastecimento(litros) {
    const statusDiv = document.getElementById('status-abastecimento');
    const litrosNum = Number(litros);
    if (!litrosNum || litrosNum <= 0) {
        statusDiv.style.color = 'red'; statusDiv.innerText = 'Insira um valor de litros válido.';
        setTimeout(() => { statusDiv.innerText = ''; }, 3000);
        return;
    }
    statusDiv.style.color = '#eab308'; statusDiv.innerText = 'Salvando...';
    const agora = new Date();
    const dados = { litros: litrosNum, timestamp: agora.getTime(), data_legivel: agora.toISOString() };
    const url = 'https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/abastecimentos.json';
    try {
        const response = await fetch(url, { method: 'POST', body: JSON.stringify(dados) });
        if (!response.ok) throw new Error('Erro no Firebase');
        statusDiv.style.color = 'green'; statusDiv.innerText = 'Abastecimento salvo!';
        document.getElementById('litros-abastecidos').value = ''; 
        carregarHistoricoAbastecimento(); 
    } catch (e) {
        console.error("Erro ao salvar abastecimento:", e);
        statusDiv.style.color = 'red'; statusDiv.innerText = 'Erro ao salvar.';
    } finally { setTimeout(() => { statusDiv.innerText = ''; }, 3000); }
}

// --- FUNÇÕES DE CONFIGURAÇÃO (NÃO ALTERADAS NESTA REVISÃO) ---

async function salvarNivelAlerta(nivel) {
	const statusDiv = document.getElementById('status-alerta');
	statusDiv.style.color = '#eab308'; statusDiv.innerText = 'Salvando...';
	try {
		await fetch('https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/nivel_alerta.json', {
			method: 'PUT', body: JSON.stringify(nivel)
		});
		nivelAlertaConfigurado = nivel; 
		statusDiv.style.color = 'green'; statusDiv.innerText = `Nível de alerta salvo em ${nivel}%.`;
		document.getElementById('nivel-alerta-valor').value = nivel; 
	} catch (e) {
		console.error("Erro ao salvar nível:", e);
		statusDiv.style.color = 'red'; statusDiv.innerText = 'Erro ao salvar.';
	} finally { setTimeout(() => { statusDiv.innerText = ''; }, 3000); }
}

async function carregarNivelAlertaAtual() {
	try {
		const r = await fetch('https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/nivel_alerta.json');
		const nivelSalvo = await r.json();
		if (nivelSalvo) {
			document.getElementById('nivel-alerta-valor').value = nivelSalvo;
			nivelAlertaConfigurado = parseInt(nivelSalvo);
		} else { document.getElementById('nivel-alerta-valor').value = nivelAlertaConfigurado; }
	} catch (e) { console.error("Erro ao carregar nível de alerta:", e); }
}

async function adicionarContato(valor, tipo) {
	const statusDiv = document.getElementById('status-contato'); 
	statusDiv.innerText = ''; 
	if (!valor || (tipo === 'email' && !valor.includes('@'))) {
		statusDiv.style.color = 'red'; statusDiv.innerText = 'Por favor, insira um valor válido.';
		setTimeout(() => { statusDiv.innerText = ''; }, 3000);
		return;
	}
	statusDiv.style.color = '#eab308'; statusDiv.innerText = 'Salvando contato...';
	const novoContato = { valor, tipo };
	try {
		const response = await fetch('https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/contatos.json', { method: 'POST', body: JSON.stringify(novoContato) });
		if (!response.ok) { throw new Error(`Erro no Firebase: ${response.statusText}`); }
		document.getElementById('contato-valor').value = ''; 
		statusDiv.style.color = 'green'; statusDiv.innerText = 'Contato salvo com sucesso!';
		carregarContatos(); 
	} catch (e) {
		console.error("Erro ao adicionar contato:", e);
		statusDiv.style.color = 'red'; statusDiv.innerText = 'Erro ao salvar contato.';
	} finally { setTimeout(() => { statusDiv.innerText = ''; }, 3000); }
}

async function removerContato(id) {
	const statusDiv = document.getElementById('status-lista-contatos'); 
	statusDiv.innerText = 'Removendo...'; statusDiv.style.color = '#eab308';
	try {
		const response = await fetch(`https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/contatos/${id}.json`, { method: 'DELETE' });
		if (!response.ok) { throw new Error(`Erro no Firebase: ${response.statusText}`); }
		statusDiv.innerText = 'Contato removido.'; statusDiv.style.color = 'green';
		carregarContatos(); 
	} catch (e) {
		console.error("Erro ao remover contato:", e);
		statusDiv.innerText = 'Erro ao remover contato.'; statusDiv.style.color = 'red';
	} finally { setTimeout(() => { statusDiv.innerText = ''; }, 3000); }
}

async function carregarContatos() {
	const listaUL = document.getElementById('lista-contatos');
	listaUL.innerHTML = '<li>Carregando...</li>';
	try {
		const r = await fetch('https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/contatos.json');
		const contatos = await r.json();
		listaUL.innerHTML = ''; 
		if (contatos) {
			Object.keys(contatos).forEach(id => {
				const c = contatos[id];
				if (c && c.tipo && c.valor) {
					const li = document.createElement('li');
					li.className = 'contato-item';
					li.innerHTML = `<span>[${c.tipo.toUpperCase()}] ${c.valor}</span><button data-id="${id}">Remover</button>`;
					listaUL.appendChild(li);
				}
			});
			if (listaUL.innerHTML === '') { 
                listaUL.innerHTML = '<li class="small" style="text-align:center;">Nenhum contato salvo.</li>'; 
            }
		} else {
            listaUL.innerHTML = '<li class="small" style="text-align:center;">Nenhum contato salvo.</li>';
        }
	} catch (e) {
		console.error("Erro ao carregar contatos:", e);
		listaUL.innerHTML = '<li class="small" style="text-align:center; color:red;">Erro ao carregar contatos.</li>';
	}
}

// --- LOOP PRINCIPAL ---
async function loopDeAtualizacao() {
	try {
		let j;
		let config;	
		const dataUrl = 'https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7.json';
		const configUrl = 'https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_config/nivel_alerta.json';
		
		// Use try-catch individual para buscar dados em tempo real
        try {
            const r = await fetch(dataUrl);
            j = await r.json();
        } catch(e) {
            console.warn("Erro ao buscar dados do PP7 em tempo real. Entrando em Modo de Emergência.");
            j = { nivel_pct: 0 }; // Simula falha do sensor
        }

        // Busca configuração do alerta
        const rConfig = await fetch(configUrl);
		config = await rConfig.json();
		
        let nivelRecebido = j.nivel_pct || j.nivel || 0;
        const agora = Date.now();
        const diffHoras = (agora - dataUltimaLeituraValida) / (1000 * 60 * 60);

        // LÓGICA DE EMERGÊNCIA
        if (nivelRecebido > 0) {
            // Se a leitura for válida
            nivelAtual = nivelRecebido;
            ultimoNivelValido = nivelRecebido;
            dataUltimaLeituraValida = agora; 
            document.getElementById('emergency-badge').style.display = 'none';
        } else {
            // Modo de Emergência (Leitura <= 0 ou falha de comunicação)
            if (ultimoNivelValido === null || dataUltimaLeituraValida === null) {
                await buscarUltimaLeituraHistorico();
            }

            document.getElementById('emergency-badge').style.display = 'flex';
            console.log(`Modo Emergência: ${diffHoras.toFixed(2)}h desde a última leitura (${ultimoNivelValido}%).`);

            // 1. Lógica para último nível acima de 60%
            if (ultimoNivelValido > 60) {
                if (diffHoras < 8) {
                    nivelAtual = ultimoNivelValido; // Mantém o último valor por 8h
                } else if (diffHoras < 16) { // 8 + 8 = 16h
                    nivelAtual = 50;
                } else if (diffHoras < 24) { // 16 + 8 = 24h
                    nivelAtual = 40;
                } else if (diffHoras < 32) { // 24 + 8 = 32h
                    nivelAtual = 30;
                } else { // 32 + 6 = 38h ou mais
                    nivelAtual = 20;
                }
            } 
            // 2. Lógica para último nível entre 41% e 60%
            else if (ultimoNivelValido > 40) { 
                if (diffHoras < 8) {
                    nivelAtual = 40; 
                } else if (diffHoras < 14) { // 8 + 6 = 14h
                    nivelAtual = 30; 
                } else { 
                    nivelAtual = 20; 
                }
            }
            // 3. Lógica para último nível entre 31% e 40%
            else if (ultimoNivelValido > 30) {
                if (diffHoras < 6) {
                    nivelAtual = 30; 
                } else {
                    nivelAtual = 20;
                }
            }
            // 4. Lógica para último nível 30% ou menos
            else {
                nivelAtual = 20;
            }
        }
		
		if (config) { nivelAlertaConfigurado = parseInt(config) || 30; }
		
        const statusDisplay = document.getElementById('status-display');
        statusDisplay.classList.remove('level-ok', 'level-warn', 'level-danger');

        // LÓGICA DE ALERTA E NOTIFICAÇÃO
		if (nivelAtual <= nivelAlertaConfigurado) {
            statusDisplay.classList.add('level-danger');

            if (Date.now() < snoozeUntil) {
                // Em snooze - não faz nada
            } 
            else if (alertaModalMostrado) {
                // Modal já está aberto - não faz nada
            }
            else if (snoozeCount >= 3) {
                // Todos os alertas já foram usados
            }
            else {
                // Verifica se o e-mail já foi enviado hoje antes de tentar enviar
                const hoje = getLocalISODate(new Date());
                if (dataUltimoEmailAlerta !== hoje) { 
                    enviarEmailAlerta(nivelAtual);
                } else {
                    console.log("Alerta de e-mail bloqueado: Limite de 1 por dia atingido.");
                }

                mostrarAlertaModal();
                alertaModalMostrado = true;
                controlarAlarme(true);

                setTimeout(() => {
                    if (alertaModalMostrado) { 
                        console.log(`Auto-Snooze ativado após ${AUTO_SNOOZE_SECONDS}s.`);
                        iniciarSoneca();
                    }
                }, AUTO_SNOOZE_SECONDS * 1000);
            }

		} else { 
            const resetLevel = nivelAlertaConfigurado + ALERTA_RESET_MARGIN;
            if (nivelAtual >= resetLevel) {
                // Reinicia as flags de alerta quando o nível está seguro
                if (alertaEmailEnviado) {
                    console.log(`Nível (${nivelAtual}%) está acima da margem de reset (${resetLevel}%). Re-armando o e-mail.`);
                    alertaEmailEnviado = false;
                    dataUltimoEmailAlerta = null; // Zera o bloqueio diário
                }
            }

            if (nivelAtual <= 60) {
                 statusDisplay.classList.add('level-warn');
            } else {
                 statusDisplay.classList.add('level-ok');
            }
            
            if (alertaModalMostrado) { fecharAlertaModal(); alertaModalMostrado = false; }
            controlarAlarme(false); 
            snoozeCount = 0; 
            snoozeUntil = 0;
		}

		atualizarCaixaDOM(nivelAtual);

        if (document.getElementById('caixa-view').style.display !== 'none') {
            document.getElementById('status-level').innerText = nivelAtual + '%';
            const litrosAprox = nivelAtual * LITROS_POR_PERCENTO;
            document.getElementById('status-litros').innerHTML = `${litrosAprox.toFixed(0)} <small>Litros</small>`;
            document.getElementById('status-time').innerText = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
		
		const intervaloGravacao = 60 * 60 * 1000; // 60 minutos
		const datePicker = document.getElementById('dataEscolhida');
		const hoje = getLocalISODate(new Date());
        const horaAtual = new Date().getHours();
        const horaAtualMinuto = new Date().getMinutes();

		// LÓGICA DE GRAVAÇÃO/SIMULAÇÃO (APENAS PARA O MODO DIÁRIO)
        // Só tenta gravar se estiver na virada da hora (minuto 0) e se a última atualização de gravação
        // foi há mais de 59 minutos para evitar gravações duplicadas.
		if (horaAtualMinuto === 0 && (agora - ultimaAtualizacaoGrafico > 59 * 60 * 1000)) {
            ultimaAtualizacaoGrafico = agora; 
			if (currentView === 'diario' && datePicker.value === hoje) {
                let nivelSimulado = nivelAtual;
                
                // Simulação da queda de nível conforme o pedido (para propósitos de demonstração em histórico)
                
                // 0h até 3h (patamar 63%)
                if (horaAtual >= 0 && horaAtual <= 3) {
                    nivelSimulado = 63;
                } 
                // 4h até 11h (patamar 61%) - Começa em 4h
                else if (horaAtual >= 4 && horaAtual <= 11) {
                    nivelSimulado = 61;
                } 
                // 12h até 15h (patamar 55%)
                else if (horaAtual >= 12 && horaAtual <= 15) {
                    nivelSimulado = 55;
                }
                // 16h até 23h (patamar 40%)
                else if (horaAtual >= 16 && horaAtual <= 23) {
                    nivelSimulado = 40; 
                }

                // Salva a leitura simulada/atual (apenas o nível) no Firebase no formato HH:00
                if (nivelSimulado > 0) {
                    salvarLeituraNoFirebase(Number(nivelSimulado), agora);
                }
			}
		}
	} catch(e) { console.error("Erro no loop de atualização:", e); }
}

// --- INICIALIZAÇÃO ---
window.onload = function() {
    const views = {
		caixa: document.getElementById('caixa-view'),
		grafico: document.getElementById('grafico-container'),
        abastecimento: document.getElementById('abastecimento-view'),
        consumo: document.getElementById('consumo-view'),
		config: document.getElementById('config-view')
	};
	const btns = {
		caixa: document.getElementById('btn-view-caixa'),
		grafico: document.getElementById('btn-view-grafico'),
        abastecimento: document.getElementById('btn-view-abastecimento'),
        consumo: document.getElementById('btn-view-consumo'),
		config: document.getElementById('btn-view-config')
	};
    
    const dateControls = document.getElementById('date-controls');
    const viewHeaders = {
        grafico: document.querySelector('#grafico-container header'),
        abastecimento: document.querySelector('#abastecimento-view header'),
        consumo: document.querySelector('#consumo-view header')
    };

    const btnDiario = document.getElementById('btn-view-diario');
    const btnSemanal = document.getElementById('btn-view-semanal');
    const btnMensal = document.getElementById('btn-view-mensal');
    const btnIntervalo = document.getElementById('btn-view-intervalo');

    // Setup Audio
    setupAudio();
    function despertarAudio() {
        if (audioContext && audioContext.state === 'suspended') {
            audioContext.resume().then(() => {
                console.log("Contexto de áudio 'acordado' pela interação do usuário.");
                document.body.removeEventListener('click', despertarAudio);
                document.body.removeEventListener('touchstart', despertarAudio);
            });
        }
    }
    document.body.addEventListener('click', despertarAudio, { once: true });
    document.body.addEventListener('touchstart', despertarAudio, { once: true });

    // EmailJS Init
	(function() {
		const PUBLIC_KEY = "I1HnvhgWehPP7EXxX";	
		if (PUBLIC_KEY === "SUA_PUBLIC_KEY_AQUI" || PUBLIC_KEY === "") {
			emailJsInicializado = false; return; 
		}
		try { emailjs.init(PUBLIC_KEY); emailJsInicializado = true; } catch(e) { emailJsInicializado = false; }
	})();
    
    const btnIntervaloElem = document.getElementById('btn-view-intervalo');
    
    function switchView(viewName) {
        activeTab = viewName; 
		for (const key in views) { views[key].style.display = 'none'; }
		if (views[viewName]) { views[viewName].style.display = 'flex'; }

		document.querySelectorAll('.main-header .nav-button').forEach(btn => btn.classList.remove('active'));
		if (btns[viewName]) { btns[viewName].classList.add('active'); }

        dateControls.style.display = 'none'; 

        if (viewName === 'grafico' || viewName === 'consumo') {
            // Move os controles de data para o header da view
            viewHeaders[viewName].appendChild(dateControls);
            dateControls.style.display = 'flex';
            btnDiario.style.display = 'flex';
            btnMensal.style.display = 'flex';
            
            // O botão de Intervalo é permitido apenas no Histórico (grafico)
            if (viewName === 'consumo') {
                btnIntervaloElem.style.display = 'none';
            } else {
                btnIntervaloElem.style.display = 'flex';
            }
            btnSemanal.style.display = 'none';
            
            // Garante que a view de Histórico/Consumo começa em Diário ou Mensal
            if (currentView === 'semanal') {
                 currentView = 'diario';
                 document.querySelector('.view-selector .view-btn.active').classList.remove('active');
                 btnDiario.classList.add('active');
                 document.getElementById('diario-picker').style.display = 'flex';
                 document.getElementById('mensal-picker').style.display = 'none';
                 document.getElementById('intervalo-picker').style.display = 'none';
            }
             document.getElementById('btnAtualizar').click(); // Carrega os dados para a view ativa
        } else if (viewName === 'abastecimento') {
            // A view de Abastecimento tem uma interface de controle diferente, mas reutiliza o 'date-controls'
            viewHeaders[viewName].appendChild(dateControls);
            dateControls.style.display = 'flex';
            btnDiario.style.display = 'none';
            btnIntervalo.style.display = 'none';
            btnSemanal.style.display = 'flex';
            btnMensal.style.display = 'flex';
            if (currentView === 'diario' || currentView === 'intervalo') {
                 currentView = 'semanal';
                 document.querySelector('.view-selector .view-btn.active').classList.remove('active');
                 btnSemanal.classList.add('active');
                 document.getElementById('diario-picker').style.display = 'none';
                 document.getElementById('mensal-picker').style.display = 'none';
                 document.getElementById('intervalo-picker').style.display = 'none';
            }
        }

        if (viewName === 'caixa') {
            // Recarrega o histórico de abastecimento ao voltar para a home
            carregarHistoricoAbastecimento();
        } else if (viewName === 'grafico') {
			if(chartLinha) chartLinha.resize();
			if(chartBlocos) chartBlocos.resize();
            // Garante que a legenda do eixo X seja atualizada
            chartLinha.options.scales.x.title.text = currentView === 'diario' ? 'Horário (00:00 - 23:00)' : 'Semanas do Período';
            chartBlocos.options.scales.x.title.text = currentView === 'diario' ? 'Horário (00:00 - 23:00)' : 'Semanas do Período';
		} else if (viewName === 'consumo') {
            if(chartConsumoBloco) chartConsumoBloco.resize();
            if(chartConsumoLinha) chartConsumoLinha.resize();
            // Garante que a legenda do eixo X seja atualizada
            chartConsumoBloco.options.scales.x.title.text = currentView === 'diario' ? 'Horário (00:00 - 23:00)' : 'Semanas do Período';
            chartConsumoLinha.options.scales.x.title.text = currentView === 'diario' ? 'Horário (00:00 - 23:00)' : 'Semanas do Período';
        } else if (viewName === 'abastecimento') {
            carregarHistoricoAbastecimento();
        } else if (viewName === 'config') {
			carregarContatos();	
			carregarNivelAlertaAtual(); 
		}
    }
    
    // Event listeners
    btns.caixa.addEventListener('click', () => switchView('caixa'));
	btns.grafico.addEventListener('click', () => switchView('grafico'));
    btns.abastecimento.addEventListener('click', () => switchView('abastecimento'));
    btns.consumo.addEventListener('click', () => switchView('consumo'));
	btns.config.addEventListener('click', () => switchView('config'));

    document.getElementById('modal-close-btn').addEventListener('click', iniciarSoneca);

    document.getElementById('btn-salvar-abastecimento').addEventListener('click', () => {
        const litros = document.getElementById('litros-abastecidos').value;
        salvarAbastecimento(litros);
    });
	
	document.getElementById('btn-add-contato').addEventListener('click', () => {
		const valor = document.getElementById('contato-valor').value;
		const tipo = document.getElementById('contato-tipo').value;
		adicionarContato(valor, tipo);
	});

	document.getElementById('btn-salvar-nivel-alerta').addEventListener('click', () => {
		const nivel = document.getElementById('nivel-alerta-valor').value;
		const statusDiv = document.getElementById('status-alerta');
		if (nivel && nivel >= 1 && nivel <= 99) {
			salvarNivelAlerta(parseInt(nivel));
		} else {
			statusDiv.style.color = 'red';
			statusDiv.innerText = 'Insira um valor válido (1-99).';
			setTimeout(() => { statusDiv.innerText = ''; }, 3000);
		}
	});

	document.getElementById('lista-contatos').addEventListener('click', (e) => {
		if (e.target.tagName === 'BUTTON') {
			const id = e.target.dataset.id;
			const btn = e.target;
			if (btn.dataset.confirming) {
				removerContato(id);
				btn.dataset.confirming = 'false';
				btn.innerText = 'Remover';
			} else {
				document.querySelectorAll('#lista-contatos button[data-confirming="true"]').forEach(b => {
					b.dataset.confirming = 'false';
					b.innerText = 'Remover';
				});
				btn.dataset.confirming = 'true';
				btn.innerText = 'Confirmar?';
				setTimeout(() => {
					if (btn.dataset.confirming === 'true') {
						 btn.dataset.confirming = 'false';
						 btn.innerText = 'Remover';
					}
				}, 3000);
			}
		}
	});

	document.getElementById('lista-abastecimentos').addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-abastecimento-btn')) {
			const id = e.target.dataset.id;
			const btn = e.target;
			if (btn.dataset.confirming) {
				removerAbastecimento(id);
			} else {
				document.querySelectorAll('#lista-abastecimentos button[data-confirming="true"]').forEach(b => {
					b.dataset.confirming = 'false';
					b.innerText = '×';
                    b.style.width = '30px';
				});
				btn.dataset.confirming = 'true';
				btn.innerText = 'Confirmar?';
                btn.style.width = 'auto'; 
				setTimeout(() => {
					if (btn.dataset.confirming === 'true') {
						 btn.dataset.confirming = 'false';
						 btn.innerText = '×';
                         btn.style.width = '30px';
					}
				}, 3000);
			}
		}
	});

	criarGraficos();
	const hoje = new Date();
	const dataFimPadrao = getLocalISODate(new Date()); // data de hoje
	const mesFimPadrao = dataFimPadrao.substring(0, 7);
    
    // Calcula a data de 60 dias atrás para o seletor de intervalo
    const dataInicioIntervalo = new Date();
	dataInicioIntervalo.setDate(dataInicioIntervalo.getDate() - 59); 
	const dataInicioPadrao = getLocalISODate(dataInicioIntervalo);
    
	document.getElementById('dataEscolhida').value = dataFimPadrao;
	document.getElementById('mesEscolhido').value = mesFimPadrao;
	document.getElementById('dataInicio').value = dataInicioPadrao;
	document.getElementById('dataFim').value = dataFimPadrao;
	
	switchView('caixa'); 
	
    document.getElementById('btnAtualizar').onclick = () => {
        if (activeTab === 'grafico' || activeTab === 'consumo') {
            carregarHistoricoEConsumo();
        }
    };
    
	carregarHistoricoEConsumo().then(() => {
		loopDeAtualizacao();
		setInterval(loopDeAtualizacao, 2000);
	});

	document.querySelectorAll('.view-selector .view-btn').forEach(btn => {
		btn.addEventListener('click', (e) => {
			const parent = e.target.parentElement;
			parent.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
			e.target.classList.add('active');
			if (e.target.dataset.view) {
				currentView = e.target.dataset.view; 
				const pickers = {
					diario: document.getElementById('diario-picker'),
					mensal: document.getElementById('mensal-picker'),
					intervalo: document.getElementById('intervalo-picker')
				};
				for(const key in pickers) { pickers[key].style.display = 'none'; }
				if (pickers[currentView]) pickers[currentView].style.display = 'flex';
                document.getElementById('btnAtualizar').click();
			}
		});
	});
};

</script>
</body>
</html>

