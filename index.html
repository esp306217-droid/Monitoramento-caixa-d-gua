<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monitoramento Caixa D'√Ågua PP7</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<style>
/* --- ESTILOS GERAIS --- */
:root {
    --accent: #06b6d4; /* Ciano */
    --accent-dark: #0e7490; /* Ciano mais escuro */
    --bg-color-light: #f0f7ff; /* Azul bem claro para cards */
    --header-bg: #ffffff; /* Fundo do novo cabe√ßalho */
}
* { box-sizing: border-box; }
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}
body {
    font-family: Arial, Helvetica, sans-serif; 
    text-align: center;
    background: #fff; /* Fundo branco */
    color: #334155; 
    overflow-x: hidden;
    padding-bottom: 20px;
}

/* NOVO: Cabe√ßalho principal com bot√µes */
.main-header {
    width: 100%;
    padding: 10px 0;
    background-color: var(--header-bg);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px; /* Espa√ßo entre bot√µes */
    margin-bottom: 20px; /* Espa√ßo antes da logo */
    position: sticky; /* Opcional: fixa o header no topo */
    top: 0;
    z-index: 1000;
}

/* Views de conte√∫do (Caixa, Gr√°fico, Config) */
#caixa-view, #grafico-container, #config-view {
    width: 100%;
    max-width: 1200px; /* Limita a largura do conte√∫do principal */
    margin: 0 auto; /* Centraliza o conte√∫do principal */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 1rem;
    overflow-y: auto;
}

.logo {
    width: 160px;
    margin-bottom: 20px; /* Ajusta espa√ßo ap√≥s a logo */
    opacity: 0.95;
    z-index: 10;
    position: relative;
    display: block; /* Garante que √© um bloco */
    margin-left: auto; /* Centraliza a logo */
    margin-right: auto; /* Centraliza a logo */
}

.reservatorio-wrapper {
    width: 350px;
    height: 600px;
    position: relative;
    transform: scale(1.0);
    margin-top: 0;
}

#reservatorio-svg {
    width: 100%;
    height: 100%;
    filter: drop-shadow(3px 3px 8px rgba(0,0,0,0.25));
}
#reservatorio-svg .estrutura-solida { fill: url(#grad-metal); stroke: #555; stroke-width: 2.5; opacity: 0.7; }
#reservatorio-svg .taca-solida { fill: url(#grad-metal); stroke: #000; stroke-width: 2.5; opacity: 0.25; }
#reservatorio-svg .faixa-metalica { fill: none; stroke: #555; stroke-width: 2.5; opacity: 0.3; }
#reservatorio-svg .guarda-corpo { fill: none; stroke: #000; stroke-width: 2.5; opacity: 0.4; }
#reservatorio-svg .base-concreto { fill: #C0C0C0; stroke: #000; stroke-width: 2.5; opacity: 0.8; }
#reservatorio-svg .suportes-base { fill: #A9A9A9; stroke: #000; stroke-width: 2; opacity: 0.8; }

.agua-wrapper { width: 100%; height: 100%; position: relative; overflow: hidden; }
.agua {
    position: absolute; bottom: 0; width: 100%; height: 0%;
    background: linear-gradient(to top, #00ffcc, #1e90ff);
    transition: height 0.6s ease;
    overflow: hidden; color: white; font-weight: bold;
    text-align: center; font-size: 1.2rem;
    display: flex; align-items: center; justify-content: center;
    font-family: Arial, Helvetica, sans-serif;
}
.agua::before, .agua::after {
    content: ""; position: absolute; width: 200%; height: 20px;
    top: -10px; left: -50%; border-radius: 50%;
    background: rgba(255, 255, 255, 0.4);
}
.agua::before { animation: onda1 3s infinite linear; }
.agua::after { background: rgba(255,255,255,0.2); top: -8px; animation: onda2 5s infinite linear; }
@keyframes onda1 { 0% { transform: translateX(0); } 100% { transform: translateX(50px); } }
@keyframes onda2 { 0% { transform: translateX(0); } 100% { transform: translateX(-50px); } }

/* Estilo de bot√£o principal (Para Carregar, Adicionar, Salvar) */
.modern-button {
    background: var(--accent); /* Ciano */
    border: none;
    color: #ffffff; /* Texto branco */
    font-weight: 700; 
    padding: 10px 20px; /* Padding ajustado */
    border-radius: 8px;
    cursor: pointer;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 0.9rem; /* Tamanho ajustado */
    box-shadow: 0 4px 15px rgba(6,182,212,0.3);
    transition: all 0.2s ease;
    text-align: center;
    text-transform: uppercase; /* CAIXA ALTA */
    letter-spacing: 0.05em; 
}
.modern-button:hover {
    background: var(--accent-dark); 
    box-shadow: 0 2px 10px rgba(6,182,212,0.4);
    transform: translateY(-1px);
}
.modern-button:active {
    transform: translateY(0);
    box-shadow: 0 1px 5px rgba(6,182,212,0.4);
}

/* --- ESTILOS GR√ÅFICOS --- */
#grafico-container header {
    width: 100%; 
    display: flex; flex-wrap: wrap;
    justify-content: space-between; align-items: center; gap: 12px;
    margin: 0 auto 20px auto; border-bottom: 1px solid #eee; padding-bottom: 1rem;
}
#grafico-container header h1 { margin: 0; font-family: Arial, Helvetica, sans-serif; font-size: 1.5rem; color: #1e3a8a; }
.header-right { display: flex; flex-wrap: wrap; align-items: center; gap: 20px; justify-content: flex-end; flex-grow: 1; }
.controls { display: flex; gap: 10px; align-items: center; }
input[type="date"], input[type="month"] { 
    background: #f0f0f0; color: #333; border: 1px solid #ccc; border-radius: 6px; padding: 8px 12px;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 0.9rem;
}
#intervalo-picker span { color: #666; font-size: 0.9rem; }

/* .board (container) */
.board { 
    width: 100%; 
    background: #ffffff; /* Fundo branco */
    border-radius: 12px; padding: 18px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
    border: 1px solid #eee; /* Borda cinza clara */
    margin: 0 auto; 
}
.charts { display: grid; grid-template-columns: 1fr; gap: 22px; }

/* .chart-card (quadros) */
.chart-card { 
    background: var(--bg-color-light); /* Fundo azul claro */
    padding: 14px; border-radius: 10px; 
    border: 1px solid #b0cce3; /* Contorno azulado */
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.chart-card strong { font-family: Arial, Helvetica, sans-serif; color: #1e3a8a; font-size: 1.1rem;}

canvas { 
    width: 100%!important; 
    height: 400px!important; /* Altura aumentada para o √∫nico gr√°fico */
    display: block; 
}
.small { font-size: .9rem; color: #666; margin-top: 4px; }

/* Bot√µes de filtro (Di√°rio, Mensal, etc) */
.view-selector { display: flex; gap: 5px; background: #e2e8f0; padding: 4px; border-radius: 8px; }
.view-btn { 
    padding: 8px 14px; 
    border: none; 
    border-radius: 6px; 
    cursor: pointer; 
    background: transparent; 
    color: #334155; 
    font-weight: 700; 
    font-family: Arial, Helvetica, sans-serif; 
    font-size: 0.9rem;
    text-transform: uppercase;
    transition: all 0.2s ease;
    letter-spacing: 0.03em;
    width: auto;
    text-align: center;
}
.view-btn.active { 
    background: var(--accent); 
    color: #ffffff; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
}
.view-btn:hover:not(.active) {
    background: #d0dae6;
    color: #1e3a8a;
}

/* APLICA O ESTILO .view-btn AOS BOT√ïES .nav-button NO HEADER */
.nav-button {
    width: auto; 
    text-align: center; 
    padding-left: 14px; /* Reset padding */
    padding-right: 14px;
    font-size: 0.9rem;
}
/* Estilo ativo espec√≠fico para bot√µes no header */
.nav-button.active {
    border-left: none; 
    box-shadow: 0 2px 8px rgba(6,182,212,0.3); /* Sombra mais pronunciada */
}
.nav-button.active:hover {
    background: var(--accent-dark);
    transform: none; /* Sem movimento no hover */
}


/* --- ESTILOS LEDS --- */
@keyframes pisca { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.led-base { stroke: #111; stroke-width: 1; transition: all 0.3s ease; filter: drop-shadow(0 0 2px rgba(255,255,255,0.7)); }
.led-base.vermelho { fill: #8b0000; } .led-base.amarelo { fill: #b2b200; } .led-base.verde { fill: #006400; }
.led-base.aceso.vermelho { fill: #ff1a1a; filter: drop-shadow(0 0 5px #ff1a1a) drop-shadow(0 0 10px #ff1a1a); animation: pisca 1.2s infinite; }
.led-base.aceso.amarelo { fill: #ffff33; filter: drop-shadow(0 0 5px #ffff33) drop-shadow(0 0 10px #ffff33); animation: pisca 1.2s infinite; }
.led-base.aceso.verde { fill: #33ff33; filter: drop-shadow(0 0 5px #33ff33) drop-shadow(0 0 10px #33ff33); animation: pisca 1.2s infinite; }

/* --- ESTILOS CONFIGURA√á√ïES --- */
#config-view h1 { font-family: Arial, Helvetica, sans-serif; color: #1e3a8a; }
.config-board { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 900px; }
.config-card { 
    background: #ffffff; /* Fundo blanco */
    padding: 20px; border-radius: 12px; 
    border: 1px solid #eee; text-align: left;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.config-card h2 { margin-top: 0; font-family: Arial, Helvetica, sans-serif; color: #1e3a8a; font-size: 1.25rem;}
.form-group { display: flex; gap: 10px; margin-bottom: 15px; }
.form-group input, .form-group select { 
    flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; 
    font-family: Arial, Helvetica, sans-serif;
    font-size: 0.9rem;
    color: #333;
}
#lista-emails { list-style: none; padding: 0; margin: 0; }
.email-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
.email-item span { font-weight: bold; color: #333; word-break: break-all; }
.email-item button { 
    background: #ef4444; color: white; font-size: 0.8rem;
    padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer;
    text-transform: uppercase;
    font-weight: 700;
    font-family: Arial, Helvetica, sans-serif;
    flex-shrink: 0; 
    margin-left: 10px;
}
.email-item button:hover { background: #dc2626; }
.card-emails {
    grid-column: 1 / -1;
}

/* --- LEITURA ATUAL --- */
.leitura-atual {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #06b6d4, #0e7490);
    color: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(6,182,212,0.3);
    min-width: 150px;
    text-align: center;
    z-index: 100;
    border: 2px solid white;
}

.leitura-atual h3 {
    margin: 0 0 10px 0;
    font-size: 1rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.leitura-valor {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.leitura-hora {
    font-size: 0.8rem;
    margin: 5px 0 0 0;
    opacity: 0.9;
}

/* --- RESPONSIVIDADE --- */
@media (max-width: 800px) {
    body {
        padding-left: 0; 
        padding-bottom: 20px; 
        padding-top: 60px; /* Adiciona espa√ßo para o header fixo */
    }

    .main-header {
        position: fixed; /* Header fixo no mobile */
        top: 0;
        left: 0;
        gap: 8px; /* Menor espa√ßo entre bot√µes */
        padding: 8px 0;
        margin-bottom: 10px;
    }

    .nav-button {
          padding: 8px 10px;
          font-size: 0.8rem;
    }
    
    #caixa-view, #grafico-container, #config-view { padding: 0.5rem; }
    .reservatorio-wrapper { 
        width: 90%; 
        max-width: 300px;
        height: 50vh; 
    }
    .logo { 
        margin-top: 10px;
        margin-bottom: 15px; 
    } 
    #grafico-container header, .header-right { flex-direction: column; align-items: stretch; gap: 10px; } 
    .controls { flex-direction: column; align-items: stretch;} 
    .view-selector { justify-content: center;} 
    .config-board { grid-template-columns: 1fr; }
    
    .chart-card {
        padding: 10px;
    }

    canvas {
        height: 300px !important; 
    }

    .leitura-atual {
        position: relative;
        right: auto;
        top: auto;
        transform: none;
        margin: 20px auto;
        width: 90%;
        max-width: 200px;
    }
}

/* Status de conex√£o */
.status-conexao {
    position: fixed;
    top: 10px;
    left: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: bold;
    z-index: 1000;
    background: #f59e0b;
    color: white;
}

.status-conexao.online {
    background: #10b981;
}

.status-conexao.offline {
    background: #ef4444;
}

.status-conexao.erro {
    background: #f59e0b;
}
</style>
</head>
<body>

<!-- Status de conex√£o -->
<div id="status-conexao" class="status-conexao">üîÑ Conectando...</div>

<div class="main-header">
    <button id="btn-view-caixa" class="nav-button view-btn">Caixa D'√°gua</button>
    <button id="btn-view-grafico" class="nav-button view-btn">Gr√°fico</button>
    <button id="btn-view-config" class="nav-button view-btn">Configura√ß√µes</button>
</div>

<img class="logo" src="https://viacristais.tribox.info/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">

<!-- Leitura Atual Fixa -->
<div class="leitura-atual" id="leitura-atual">
    <h3>Leitura Atual</h3>
    <div class="leitura-valor" id="leitura-valor">0%</div>
    <div class="leitura-hora" id="leitura-hora">--:--</div>
</div>

<div id="caixa-view">
    <div class="reservatorio-wrapper" id="caixa-container">
        <!-- SVG da caixa d'√°gua -->
        <svg id="reservatorio-svg" viewBox="0 0 400 1000" preserveAspectRatio="xMidYMin meet">
            <defs>
                <linearGradient id="grad-metal" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#DADADA"/><stop offset="50%" stop-color="#FAFAFA"/><stop offset="100%" stop-color="#CFCFCF"/>
                </linearGradient>
                <clipPath id="mascara-agua">
                    <path d="M 105 220 L 295 220 L 295 440 L 265 500 L 135 500 L 105 440 Z"/>
                </clipPath>
            </defs>
            <foreignObject x="105" y="220" width="190" height="280" clip-path="url(#mascara-agua)">
                <div xmlns="http://www.w3.org/1999/xhtml" class="agua-wrapper">
                    <div class="agua" id="agua">0%</div>
                </div>
            </foreignObject>
            <g id="estrutura-reservatorio">
                <g id="base"><path class="base-concreto" d="M 80 950 L 320 950 L 310 930 L 90 930 Z"/><path class="suportes-base" d="M 130 930 L 120 940 L 140 940 Z M 170 930 L 160 940 L 180 940 Z M 210 930 L 200 940 L 220 940 Z M 250 930 L 240 940 L 260 940 Z M 290 930 L 280 940 L 300 940 Z"/></g>
                <g id="coluna"><path class="estrutura-solida" d="M 135 930 L 135 500 L 265 500 L 265 930 Z"/><path class="faixa-metalica" d="M 135 620 L 265 620 M 135 770 L 265 770"/></g>
                <g id="taca-solida"><path class="taca-solida" d="M 100 440 L 100 220 L 300 220 L 300 440 L 265 500 L 135 500 Z"/><path class="guarda-corpo" d="M 100 220 A 100 25 0 0 1 300 220"/></g>
                <g id="leds-base"><circle id="led-verde" class="led-base verde" cx="160" cy="975" r="12" /><circle id="led-amarelo" class="led-base amarelo" cx="200" cy="975" r="12" /><circle id="led-vermelho" class="led-base vermelho" cx="240" cy="975" r="12" /></g>
            </g>
        </svg>
    </div>
    <!-- Feedback de status -->
    <div id="status-alerta-caixa" class="small" style="font-weight:bold; font-size: 1rem; margin-top: 15px; min-height: 1.2rem;"></div>
</div>

<div id="grafico-container" style="display:none;">
    <header>
        <div class="header-right">
            <h1>Hist√≥rico de Monitoramento</h1>
            <div class="view-selector">
                <button class="view-btn active" data-view="diario">Di√°rio</button>
                <button class="view-btn" data-view="mensal">Mensal</button>
                <button class="view-btn" data-view="intervalo">Intervalo</button>
            </div>
            <div class="controls">
                <div id="diario-picker"><input type="date" id="dataEscolhida"></div>
                <div id="mensal-picker" style="display:none;"><input type="month" id="mesEscolhido"></div>
                <div id="intervalo-picker" style="display:none;">
                    <input type="month" id="mesInicio" placeholder="M√™s inicial">
                    <span>at√©</span>
                    <input type="month" id="mesFim" placeholder="M√™s final">
                </div>
                <button id="btnAtualizar" class="modern-button">Carregar</button>
            </div>
        </div>
    </header>
    <div class="board">
        <div class="charts">
            <div class="chart-card">
                <strong>Gr√°fico de Linha ‚Äî N√≠vel (%)</strong>
                <canvas id="chartLinha"></canvas>
                <div class="small" id="info-linha">N√≠vel de √°gua (%) - Hist√≥rico a cada 5 minutos</div>
            </div>
            <div class="chart-card">
                <strong>Gr√°fico de Barras ‚Äî Varia√ß√£o</strong>
                <canvas id="chartVela"></canvas>
                <div class="small" id="info-vela">Mostra a varia√ß√£o do n√≠vel por per√≠odo.</div>
            </div>
        </div>
    </div>
</div>

<!-- View de Configura√ß√µes, adaptada ao seu ESP32 -->
<div id="config-view" style="display:none;">
    <h1>Configura√ß√µes de Notifica√ß√£o</h1>
    <p class="small" style="max-width: 600px; margin: -10px auto 20px auto;">
        As configura√ß√µes salvas aqui ser√£o lidas automaticamente pelo ESP32 em campo.
    </p>
    <div class="config-board">
        
        <!-- Card 1: N√≠vel de Alerta (ESP l√™ /config/nivel_minimo) -->
        <div class="config-card">
            <h2>Definir N√≠vel de Alerta (%)</h2>
            <p class="small" style="margin-top:-10px; margin-bottom:15px;">
                Define a porcentagem que dispara o alerta de n√≠vel baixo.
            </p>
            <div class="form-group">
                <input type="number" id="nivel-alerta-valor" placeholder="Ex: 30" min="1" max="99">
                <button id="btn-salvar-nivel-alerta" class="modern-button">Salvar</button>
            </div>
            <div id="status-alerta" class="small" style="font-weight:bold;"></div>
        </div>

        <!-- Card 2: ID Telegram (ESP l√™ /config/telegram) -->
        <div class="config-card">
            <h2>Definir Chat ID do Telegram</h2>
            <p class="small" style="margin-top:-10px; margin-bottom:15px;">
                ID num√©rico do usu√°rio ou grupo do Telegram.
            </p>
            <div class="form-group">
                <input type="text" id="telegram-id-valor" placeholder="Ex: -100123...">
                <button id="btn-salvar-telegram-id" class="modern-button">Salvar</button>
            </div>
            <div id="status-telegram" class="small" style="font-weight:bold;"></div>
        </div>
        
        <!-- Card 3: Lista de E-mails (ESP l√™ /config/emails) -->
        <div class="config-card card-emails">
            <h2>Gerenciar E-mails de Alerta</h2>
            <div class="form-group">
                <input type="email" id="email-valor" placeholder="novo.email@provedor.com">
                <button id="btn-add-email" class="modern-button">Adicionar</button>
            </div>
            <div id="status-email" class="small" style="font-weight:bold; margin-bottom: 15px;"></div>
            
            <h3 style="margin-bottom: 10px; color: #555;">E-mails Salvos:</h3>
            <ul id="lista-emails">
                <!-- E-mails ser√£o inseridos aqui pelo JS -->
            </ul>
        </div>

    </div>
</div>

<script>
// =============================================
// CONFIGURA√á√ïES DO FIREBASE
// =============================================
const FIREBASE_CONFIG = {
    DB_URL: "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com",
    URLS_NIVEL: [
        "/nivel_atual.json",
        "/PP7/nivel_pct.json",
        "/PP7/nivel.json",
        "/nivel.json"
    ]
};

// =============================================
// VARI√ÅVEIS GLOBAIS
// =============================================
let chartLinha, chartVela;
let nivelAtual = 25;
let nivelAlertaConfigurado = 30;
let loopIntervalo;
let usandoDadosReais = false;

// =============================================
// FUN√á√ÉO PRINCIPAL DE TESTE DE CONEX√ÉO
// =============================================
async function testarConexaoFirebase() {
    const statusDiv = document.getElementById('status-conexao');
    
    for (const urlNivel of FIREBASE_CONFIG.URLS_NIVEL) {
        const urlCompleta = FIREBASE_CONFIG.DB_URL + urlNivel + '?t=' + Date.now();
        
        try {
            const response = await fetch(urlCompleta, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                cache: 'no-cache'
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data !== null && data !== undefined && data !== 0) {
                    statusDiv.className = 'status-conexao online';
                    statusDiv.innerHTML = '‚úÖ Online';
                    statusDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                    
                    return { 
                        sucesso: true, 
                        url: urlCompleta, 
                        dados: data
                    };
                }
            }
        } catch (error) {
            console.log(`Falha na URL: ${urlCompleta}`);
        }
    }
    
    statusDiv.className = 'status-conexao offline';
    statusDiv.innerHTML = '‚ùå Offline - Modo Demo';
    statusDiv.style.display = 'block';
    
    return { 
        sucesso: false, 
        url: null, 
        dados: null
    };
}

// =============================================
// FUN√á√ÉO DE ATUALIZA√á√ÉO PRINCIPAL
// =============================================
async function atualizarDados() {
    try {
        const testeConexao = await testarConexaoFirebase();
        
        if (testeConexao.sucesso && testeConexao.dados !== null) {
            nivelAtual = Number(testeConexao.dados);
            usandoDadosReais = true;
            
            document.getElementById('status-alerta-caixa').innerHTML = 
                '‚úÖ Conectado - Dados em tempo real';
            document.getElementById('status-alerta-caixa').style.color = '#10b981';
            
        } else {
            usandoDadosReais = false;
            
            const variacao = (Math.random() - 0.5) * 10;
            nivelAtual = Math.max(1, Math.min(100, nivelAtual + variacao));
            
            document.getElementById('status-alerta-caixa').innerHTML = 
                '‚ö†Ô∏è Modo Demo - Dados simulados';
            document.getElementById('status-alerta-caixa').style.color = '#f59e0b';
        }
        
        nivelAtual = Math.max(1, Math.min(100, Math.round(nivelAtual)));
        atualizarInterface();
        
    } catch (error) {
        console.error("Erro na atualiza√ß√£o:", error);
        
        nivelAtual = Math.max(1, Math.min(100, nivelAtual + (Math.random() - 0.5) * 5));
        atualizarInterface();
        
        document.getElementById('status-alerta-caixa').innerHTML = 
            '‚ùå Erro de conex√£o';
        document.getElementById('status-alerta-caixa').style.color = '#ef4444';
    }
}

// =============================================
// FUN√á√ÉO PARA ATUALIZAR A INTERFACE
// =============================================
function atualizarInterface() {
    const aguaDiv = document.getElementById('agua');
    if (aguaDiv) {
        aguaDiv.style.height = nivelAtual + '%';
        aguaDiv.textContent = nivelAtual + '%';
        
        if (nivelAtual > 60) {
            aguaDiv.style.background = 'linear-gradient(to top, #00ffcc, #1e90ff)';
        } else if (nivelAtual > nivelAlertaConfigurado) {
            aguaDiv.style.background = 'linear-gradient(to top, #ffff66, #ffcc00)';
        } else {
            aguaDiv.style.background = 'linear-gradient(to top, #ff3333, #990000)';
        }
    }
    
    const leituraValor = document.getElementById('leitura-valor');
    const leituraHora = document.getElementById('leitura-hora');
    
    if (leituraValor) {
        leituraValor.textContent = nivelAtual + '%';
        
        if (nivelAtual > 60) {
            leituraValor.style.color = '#33ff33';
        } else if (nivelAtual > nivelAlertaConfigurado) {
            leituraValor.style.color = '#ffff33';
        } else {
            leituraValor.style.color = '#ff3333';
        }
    }
    
    if (leituraHora) {
        leituraHora.textContent = new Date().toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    
    const ledVerde = document.getElementById('led-verde');
    const ledAmarelo = document.getElementById('led-amarelo');
    const ledVermelho = document.getElementById('led-vermelho');
    
    if (ledVerde && ledAmarelo && ledVermelho) {
        ledVerde.classList.remove('aceso');
        ledAmarelo.classList.remove('aceso');
        ledVermelho.classList.remove('aceso');
        
        if (nivelAtual > 60) {
            ledVerde.classList.add('aceso');
        } else if (nivelAtual > nivelAlertaConfigurado) {
            ledAmarelo.classList.add('aceso');
        } else {
            ledVermelho.classList.add('aceso');
        }
    }
    
    salvarHistoricoLocal();
}

// =============================================
// FUN√á√ïES DOS GR√ÅFICOS - CORRIGIDAS
// =============================================
function criarGraficos() {
    // Gr√°fico de Linha
    const ctxL = document.getElementById('chartLinha').getContext('2d');
    chartLinha = new Chart(ctxL, {
        type: 'line',
        data: { 
            labels: [], 
            datasets: [{ 
                label: 'N√≠vel (%)', 
                data: [], 
                fill: true, 
                backgroundColor: 'rgba(6,182,212,0.1)', 
                borderColor: 'rgba(6,182,212,0.95)', 
                tension: 0.4, 
                pointRadius: 3, 
                borderWidth: 2,
                pointBackgroundColor: 'rgba(6,182,212,1)',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2
            }] 
        },
        options: { 
            animation: false, 
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    display: true,
                    labels: {
                        color: '#666',
                        font: { family: 'Arial, Helvetica, sans-serif', size: 12 }
                    }
                } 
            }, 
            scales: { 
                x: { 
                    ticks: { color: '#666' },
                    grid: { color: 'rgba(0,0,0,0.05)' }
                }, 
                y: { 
                    ticks: { color: '#666' }, 
                    min: 0, 
                    max: 100,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                } 
            }
        }
    });

    // Gr√°fico de Barras
    const ctxV = document.getElementById('chartVela').getContext('2d');
    chartVela = new Chart(ctxV, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'N√≠vel (%)',
                data: [],
                backgroundColor: 'rgba(6, 182, 212, 0.7)',
                borderColor: 'rgba(6, 182, 212, 1)',
                borderWidth: 1
            }]
        },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#666',
                        font: { family: 'Arial, Helvetica, sans-serif', size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `N√≠vel: ${context.parsed.y}%`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#666' },
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                y: {
                    ticks: { color: '#666' },
                    min: 0,
                    max: 100,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                }
            }
        }
    });
}

// =============================================
// FUN√á√ÉO PARA SALVAR HIST√ìRICO LOCAL
// =============================================
function salvarHistoricoLocal() {
    try {
        const agora = new Date();
        const data = agora.toISOString().split('T')[0];
        const hora = agora.toLocaleTimeString('pt-BR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const historicoLocal = JSON.parse(localStorage.getItem('historicoCaixaAgua') || '{}');
        if (!historicoLocal[data]) historicoLocal[data] = {};
        historicoLocal[data][hora] = { 
            nivel: nivelAtual, 
            timestamp: Date.now(),
            real: usandoDadosReais
        };
        
        localStorage.setItem('historicoCaixaAgua', JSON.stringify(historicoLocal));
        
    } catch (e) {
        console.error('Erro ao salvar hist√≥rico local:', e);
    }
}

// =============================================
// FUN√á√ÉO PARA CARREGAR HIST√ìRICO NOS GR√ÅFICOS
// =============================================
function carregarHistorico() {
    try {
        const historicoLocal = JSON.parse(localStorage.getItem('historicoCaixaAgua') || '{}');
        const hoje = new Date().toISOString().split('T')[0];
        
        // Dados do dia atual para exemplo
        if (historicoLocal[hoje]) {
            const dadosDoDia = historicoLocal[hoje];
            const horas = Object.keys(dadosDoDia).sort();
            const niveis = horas.map(hora => dadosDoDia[hora].nivel);
            
            // Atualiza gr√°fico de linha
            chartLinha.data.labels = horas;
            chartLinha.data.datasets[0].data = niveis;
            chartLinha.update();
            
            // Atualiza gr√°fico de barras
            chartVela.data.labels = horas;
            chartVela.data.datasets[0].data = niveis;
            chartVela.update();
        } else {
            // Dados de exemplo se n√£o houver hist√≥rico
            const horasExemplo = ['06:00', '08:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00'];
            const niveisExemplo = [30, 45, 60, 75, 80, 65, 50, 35];
            
            chartLinha.data.labels = horasExemplo;
            chartLinha.data.datasets[0].data = niveisExemplo;
            chartLinha.update();
            
            chartVela.data.labels = horasExemplo;
            chartVela.data.datasets[0].data = niveisExemplo;
            chartVela.update();
        }
    } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
    }
}

// =============================================
// INICIALIZA√á√ÉO DO SISTEMA
// =============================================
window.addEventListener('load', function() {
    console.log("üöÄ Iniciando aplica√ß√£o...");
    
    // Configura views
    const views = {
        caixa: document.getElementById('caixa-view'),
        grafico: document.getElementById('grafico-container'),
        config: document.getElementById('config-view')
    };
    
    const btns = {
        caixa: document.getElementById('btn-view-caixa'),
        grafico: document.getElementById('btn-view-grafico'),
        config: document.getElementById('btn-view-config')
    };

    function switchView(viewName) {
        for (const key in views) {
            if (views[key]) views[key].style.display = 'none';
        }
        if (views[viewName]) {
            views[viewName].style.display = 'flex';
        }

        document.querySelectorAll('.main-header .nav-button').forEach(btn => {
            if (btn) btn.classList.remove('active');
        });
        
        if (btns[viewName]) {
            btns[viewName].classList.add('active');
        }

        if (viewName === 'grafico') {
            // Carrega dados nos gr√°ficos
            setTimeout(() => {
                carregarHistorico();
                if (chartLinha) chartLinha.resize();
                if (chartVela) chartVela.resize();
            }, 100);
        }
    }

    // Event listeners para bot√µes de navega√ß√£o
    if (btns.caixa) btns.caixa.addEventListener('click', () => switchView('caixa'));
    if (btns.grafico) btns.grafico.addEventListener('click', () => switchView('grafico'));
    if (btns.config) btns.config.addEventListener('click', () => switchView('config'));
    
    // Event listener para bot√£o Carregar nos gr√°ficos
    const btnAtualizar = document.getElementById('btnAtualizar');
    if (btnAtualizar) {
        btnAtualizar.addEventListener('click', carregarHistorico);
    }
    
    // Event listeners para os bot√µes de view selector
    document.querySelectorAll('.view-selector .view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.view-selector .view-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            carregarHistorico();
        });
    });
    
    // Inicializa gr√°ficos
    criarGraficos();
    
    // Configura datas padr√£o
    const hoje = new Date();
    document.getElementById('dataEscolhida').value = hoje.toISOString().split('T')[0];
    document.getElementById('mesEscolhido').value = hoje.toISOString().substring(0, 7);
    
    const mesInicio = new Date();
    mesInicio.setMonth(mesInicio.getMonth() - 1);
    document.getElementById('mesInicio').value = mesInicio.toISOString().substring(0, 7);
    document.getElementById('mesFim').value = hoje.toISOString().substring(0, 7);
    
    // Inicializa√ß√£o
    switchView('caixa');
    
    // Inicia o loop de atualiza√ß√£o
    atualizarDados();
    loopIntervalo = setInterval(atualizarDados, 5000);
    
    console.log("‚úÖ Aplica√ß√£o iniciada com sucesso!");
});

// =============================================
// FUN√á√ïES DE CONFIGURA√á√ÉO
// =============================================
function setStatus(elementId, message, color = 'green', timeout = 3000) {
    const statusDiv = document.getElementById(elementId);
    if (statusDiv) {
        statusDiv.style.color = color;
        statusDiv.innerText = message;
        if (timeout > 0) {
            setTimeout(() => { statusDiv.innerText = ''; }, timeout);
        }
    }
}

// Event listeners para configura√ß√µes
document.addEventListener('DOMContentLoaded', function() {
    const btnSalvarNivel = document.getElementById('btn-salvar-nivel-alerta');
    if (btnSalvarNivel) {
        btnSalvarNivel.addEventListener('click', function() {
            const nivel = document.getElementById('nivel-alerta-valor').value;
            if (nivel && nivel >= 1 && nivel <= 99) {
                nivelAlertaConfigurado = parseInt(nivel);
                setStatus('status-alerta', 'N√≠vel de alerta salvo!');
            } else {
                setStatus('status-alerta', 'Valor inv√°lido (1-99).', '#ef4444');
            }
        });
    }
});
</script>
</body>
</html>
