<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Monitoramento Caixa D'Ãgua PP7</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<style>
/* SEU CSS PERMANECE INALTERADO PARA MANTER ESTILOS E RESPONSIVIDADE */
:root {
Â  Â  --accent: #06b6d4;
Â  Â  --accent-dark: #0e7490;
Â  Â  --bg-color-light: #f0f7ff;
Â  Â  --header-bg: #ffffff;
}
* {Â 
Â  Â  box-sizing: border-box;Â 
Â  Â  -webkit-tap-highlight-color: transparent;
}
html, body {
Â  Â  height: 100%;
Â  Â  margin: 0;
Â  Â  padding: 0;
Â  Â  overflow-x: hidden;
}
body {
Â  Â  font-family: Arial, Helvetica, sans-serif;Â 
Â  Â  text-align: center;
Â  Â  background: #fff;
Â  Â  color: #334155;Â 
Â  Â  padding-bottom: 20px;
Â  Â  -webkit-text-size-adjust: 100%;
}

.main-header {
Â  Â  width: 100%;
Â  Â  padding: 10px 0;
Â  Â  background-color: var(--header-bg);
Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  gap: 15px;
Â  Â  margin-bottom: 20px;
Â  Â  position: sticky;
Â  Â  top: 0;
Â  Â  z-index: 1000;
}

#caixa-view, #grafico-container, #config-view {
Â  Â  width: 100%;
Â  Â  max-width: 1200px;
Â  Â  margin: 0 auto;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  align-items: center;
Â  Â  justify-content: flex-start;
Â  Â  padding: 1rem;
Â  Â  overflow-y: auto;
}

.logo {
Â  Â  width: 160px;
Â  Â  margin-bottom: 20px;
Â  Â  opacity: 0.95;
Â  Â  z-index: 10;
Â  Â  position: relative;
Â  Â  display: block;
Â  Â  margin-left: auto;
Â  Â  margin-right: auto;
}

.reservatorio-wrapper {
Â  Â  width: 350px;
Â  Â  height: 600px;
Â  Â  position: relative;
Â  Â  transform: scale(1.0);
Â  Â  margin-top: 0;
}

#reservatorio-svg {
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  filter: drop-shadow(3px 3px 8px rgba(0,0,0,0.25));
}
#reservatorio-svg .estrutura-solida { fill: url(#grad-metal); stroke: #555; stroke-width: 2.5; opacity: 0.7; }
#reservatorio-svg .taca-solida { fill: url(#grad-metal); stroke: #000; stroke-width: 2.5; opacity: 0.25; }
#reservatorio-svg .faixa-metalica { fill: none; stroke: #555; stroke-width: 2.5; opacity: 0.3; }
#reservatorio-svg .guarda-corpo { fill: none; stroke: #000; stroke-width: 2.5; opacity: 0.4; }
#reservatorio-svg .base-concreto { fill: #C0C0C0; stroke: #000; stroke-width: 2.5; opacity: 0.8; }
#reservatorio-svg .suportes-base { fill: #A9A9A9; stroke: #000; stroke-width: 2; opacity: 0.8; }

.agua-wrapper { width: 100%; height: 100%; position: relative; overflow: hidden; }
.agua {
Â  Â  position: absolute; bottom: 0; width: 100%; height: 0%;
Â  Â  background: linear-gradient(to top, #00ffcc, #1e90ff);
Â  Â  transition: height 0.6s ease;
Â  Â  overflow: hidden; color: white; font-weight: bold;
Â  Â  text-align: center; font-size: 1.2rem;
Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  font-family: Arial, Helvetica, sans-serif;
}
.agua::before, .agua::after {
Â  Â  content: ""; position: absolute; width: 200%; height: 20px;
Â  Â  top: -10px; left: -50%; border-radius: 50%;
Â  Â  background: rgba(255, 255, 255, 0.4);
}
.agua::before { animation: onda1 3s infinite linear; }
.agua::after { background: rgba(255,255,255,0.2); top: -8px; animation: onda2 5s infinite linear; }
@keyframes onda1 { 0% { transform: translateX(0); } 100% { transform: translateX(50px); } }
@keyframes onda2 { 0% { transform: translateX(0); } 100% { transform: translateX(-50px); } }

.modern-button {
Â  Â  background: var(--accent);
Â  Â  border: none;
Â  Â  color: #ffffff;
Â  Â  font-weight: 700;Â 
Â  Â  padding: 10px 20px;
Â  Â  border-radius: 8px;
Â  Â  cursor: pointer;
Â  Â  font-family: Arial, Helvetica, sans-serif;
Â  Â  font-size: 0.9rem;
Â  Â  box-shadow: 0 4px 15px rgba(6,182,212,0.3);
Â  Â  transition: all 0.2s ease;
Â  Â  text-align: center;
Â  Â  text-transform: uppercase;
Â  Â  letter-spacing: 0.05em;Â 
Â  Â  touch-action: manipulation;
}
.modern-button:hover {
Â  Â  background: var(--accent-dark);Â 
Â  Â  box-shadow: 0 2px 10px rgba(6,182,212,0.4);
Â  Â  transform: translateY(-1px);
}
.modern-button:active {
Â  Â  transform: translateY(0);
Â  Â  box-shadow: 0 1px 5px rgba(6,182,212,0.4);
}

#grafico-container header {
Â  Â  width: 100%;Â 
Â  Â  display: flex; flex-wrap: wrap;
Â  Â  justify-content: space-between; align-items: center; gap: 12px;
Â  Â  margin: 0 auto 20px auto; border-bottom: 1px solid #eee; padding-bottom: 1rem;
}
#grafico-container header h1 {Â 
Â  Â  margin: 0;Â 
Â  Â  font-family: Arial, Helvetica, sans-serif;Â 
Â  Â  font-size: 1.5rem;Â 
Â  Â  color: #1e3a8a;Â 
Â  Â  width: 100%;
Â  Â  text-align: center;
}
.header-right {Â 
Â  Â  display: flex;Â 
Â  Â  flex-wrap: wrap;Â 
Â  Â  align-items: center;Â 
Â  Â  gap: 20px;Â 
Â  Â  justify-content: center;Â 
Â  Â  flex-grow: 1;
Â  Â  width: 100%;
}
.controls {Â 
Â  Â  display: flex;Â 
Â  Â  gap: 10px;Â 
Â  Â  align-items: center;Â 
Â  Â  flex-wrap: wrap;
Â  Â  justify-content: center;
Â  Â  width: 100%;
}
input[type="date"], input[type="month"] {Â 
Â  Â  background: #f0f0f0;Â 
Â  Â  color: #333;Â 
Â  Â  border: 1px solid #ccc;Â 
Â  Â  border-radius: 6px;Â 
Â  Â  padding: 8px 12px;
Â  Â  font-family: Arial, Helvetica, sans-serif;
Â  Â  font-size: 0.9rem;
Â  Â  min-width: 120px;
}
#intervalo-picker span { color: #666; font-size: 0.9rem; }

.board {Â 
Â  Â  width: 100%;Â 
Â  Â  background: #ffffff;
Â  Â  border-radius: 12px;Â 
Â  Â  padding: 18px;Â 
Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.05);Â 
Â  Â  border: 1px solid #eee;
Â  Â  margin: 0 auto;Â 
}
.charts {Â 
Â  Â  display: grid;Â 
Â  Â  grid-template-columns: 1fr;Â 
Â  Â  gap: 22px;Â 
Â  Â  width: 100%;
}

.chart-card {Â 
Â  Â  background: var(--bg-color-light);
Â  Â  padding: 14px;Â 
Â  Â  border-radius: 10px;Â 
Â  Â  border: 1px solid #b0cce3;
Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
Â  Â  width: 100%;
Â  Â  overflow: hidden;
}
.chart-card strong {Â 
Â  Â  font-family: Arial, Helvetica, sans-serif;Â 
Â  Â  color: #1e3a8a;Â 
Â  Â  font-size: 1.1rem;
Â  Â  display: block;
Â  Â  margin-bottom: 10px;
}

.chart-container {
Â  Â  width: 100%;
Â  Â  position: relative;
Â  Â  height: 400px;
Â  Â  min-height: 300px;
}

canvas {Â 
Â  Â  width: 100% !important;Â 
Â  Â  height: 100% !important;
Â  Â  display: block;Â 
}
.small { font-size: .9rem; color: #666; margin-top: 4px; }

.view-selector {Â 
Â  Â  display: flex;Â 
Â  Â  gap: 5px;Â 
Â  Â  background: #e2e8f0;Â 
Â  Â  padding: 4px;Â 
Â  Â  border-radius: 8px;Â 
Â  Â  flex-wrap: wrap;
Â  Â  justify-content: center;
}
.view-btn {Â 
Â  Â  padding: 8px 14px;Â 
Â  Â  border: none;Â 
Â  Â  border-radius: 6px;Â 
Â  Â  cursor: pointer;Â 
Â  Â  background: transparent;Â 
Â  Â  color: #334155;Â 
Â  Â  font-weight: 700;Â 
Â  Â  font-family: Arial, Helvetica, sans-serif;Â 
Â  Â  font-size: 0.9rem;
Â  Â  text-transform: uppercase;
Â  Â  transition: all 0.2s ease;
Â  Â  letter-spacing: 0.03em;
Â  Â  width: auto;
Â  Â  text-align: center;
Â  Â  touch-action: manipulation;
}
.view-btn.active {Â 
Â  Â  background: var(--accent);Â 
Â  Â  color: #ffffff;Â 
Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.1);Â 
}
.view-btn:hover:not(.active) {
Â  Â  background: #d0dae6;
Â  Â  color: #1e3a8a;
}

.nav-button {
Â  Â  width: auto;Â 
Â  Â  text-align: center;Â 
Â  Â  padding-left: 14px;
Â  Â  padding-right: 14px;
Â  Â  font-size: 0.9rem;
Â  Â  touch-action: manipulation;
}
.nav-button.active {
Â  Â  border-left: none;Â 
Â  Â  box-shadow: 0 2px 8px rgba(6,182,212,0.3);
}
.nav-button.active:hover {
Â  Â  background: var(--accent-dark);
Â  Â  transform: none;
}

@keyframes pisca { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.led-base { stroke: #111; stroke-width: 1; transition: all 0.3s ease; filter: drop-shadow(0 0 2px rgba(255,255,255,0.7)); }
.led-base.vermelho { fill: #8b0000; } .led-base.amarelo { fill: #b2b200; } .led-base.verde { fill: #006400; }
.led-base.aceso.vermelho { fill: #ff1a1a; filter: drop-shadow(0 0 5px #ff1a1a) drop-shadow(0 0 10px #ff1a1a); animation: pisca 1.2s infinite; }
.led-base.aceso.amarelo { fill: #ffff33; filter: drop-shadow(0 0 5px #ffff33) drop-shadow(0 0 10px #ffff33); animation: pisca 1.2s infinite; }
.led-base.aceso.verde { fill: #33ff33; filter: drop-shadow(0 0 5px #33ff33) drop-shadow(0 0 10px #33ff33); animation: pisca 1.2s infinite; }

#config-view h1 { font-family: Arial, Helvetica, sans-serif; color: #1e3a8a; }
.config-board {Â 
Â  Â  display: grid;Â 
Â  Â  grid-template-columns: 1fr;Â 
Â  Â  gap: 20px;Â 
Â  Â  width: 100%;Â 
Â  Â  max-width: 900px;Â 
}
.config-card {Â 
Â  Â  background: #ffffff;
Â  Â  padding: 20px;Â 
Â  Â  border-radius: 12px;Â 
Â  Â  border: 1px solid #eee;Â 
Â  Â  text-align: left;
Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
Â  Â  width: 100%;
}
.config-card h2 {Â 
Â  Â  margin-top: 0;Â 
Â  Â  font-family: Arial, Helvetica, sans-serif;Â 
Â  Â  color: #1e3a8a;Â 
Â  Â  font-size: 1.25rem;
}
.form-group {Â 
Â  Â  display: flex;Â 
Â  Â  gap: 10px;Â 
Â  Â  margin-bottom: 15px;Â 
Â  Â  flex-wrap: wrap;
}
.form-group input, .form-group select {Â 
Â  Â  flex-grow: 1;Â 
Â  Â  padding: 8px;Â 
Â  Â  border: 1px solid #ccc;Â 
Â  Â  border-radius: 6px;Â 
Â  Â  font-family: Arial, Helvetica, sans-serif;
Â  Â  font-size: 0.9rem;
Â  Â  color: #333;
Â  Â  min-width: 150px;
}
#lista-emails { list-style: none; padding: 0; margin: 0; }
.email-item {Â 
Â  Â  display: flex;Â 
Â  Â  justify-content: space-between;Â 
Â  Â  align-items: center;Â 
Â  Â  padding: 10px;Â 
Â  Â  border-bottom: 1px solid #eee;Â 
Â  Â  flex-wrap: wrap;
}
.email-item span {Â 
Â  Â  font-weight: bold;Â 
Â  Â  color: #333;Â 
Â  Â  word-break: break-all;Â 
Â  Â  flex: 1;
Â  Â  margin-right: 10px;
}
.email-item button {Â 
Â  Â  background: #ef4444;Â 
Â  Â  color: white;Â 
Â  Â  font-size: 0.8rem;
Â  Â  padding: 6px 10px;Â 
Â  Â  border-radius: 6px;Â 
Â  Â  border: none;Â 
Â  Â  cursor: pointer;
Â  Â  text-transform: uppercase;
Â  Â  font-weight: 700;
Â  Â  font-family: Arial, Helvetica, sans-serif;
Â  Â  flex-shrink: 0;Â 
Â  Â  margin-left: 10px;
Â  Â  touch-action: manipulation;
}
.email-item button:hover { background: #dc2626; }
.card-emails {
Â  Â  grid-column: 1 / -1;
}

.leitura-atual {
Â  Â  position: fixed;
Â  Â  right: 20px;
Â  Â  top: 50%;
Â  Â  transform: translateY(-50%);
Â  Â  background: linear-gradient(135deg, #06b6d4, #0e7490);
Â  Â  color: white;
Â  Â  padding: 20px;
Â  Â  border-radius: 12px;
Â  Â  box-shadow: 0 8px 25px rgba(6,182,212,0.3);
Â  Â  min-width: 150px;
Â  Â  text-align: center;
Â  Â  z-index: 100;
Â  Â  border: 2px solid white;
}

.leitura-atual h3 {
Â  Â  margin: 0 0 10px 0;
Â  Â  font-size: 1rem;
Â  Â  font-weight: bold;
Â  Â  text-transform: uppercase;
Â  Â  letter-spacing: 1px;
}

.leitura-valor {
Â  Â  font-size: 2.5rem;
Â  Â  font-weight: bold;
Â  Â  margin: 0;
Â  Â  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.leitura-hora {
Â  Â  font-size: 0.8rem;
Â  Â  margin: 5px 0 0 0;
Â  Â  opacity: 0.9;
}

/* --- CORREÃ‡Ã•ES PARA MOBILE --- */
@media (max-width: 800px) {
Â  Â  body {
Â  Â  Â  Â  padding-left: 0;Â 
Â  Â  Â  Â  padding-bottom: 20px;Â 
Â  Â  Â  Â  padding-top: 60px;
Â  Â  Â  Â  font-size: 14px;
Â  Â  }

Â  Â  .main-header {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  padding: 8px 0;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  width: 100%;
Â  Â  }

Â  Â  .nav-button {
Â  Â  Â  Â  padding: 8px 10px;
Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  min-width: 0;
Â  Â  }
Â  Â Â 
Â  Â  #caixa-view, #grafico-container, #config-view {Â 
Â  Â  Â  Â  padding: 0.5rem;Â 
Â  Â  Â  Â  width: 100%;
Â  Â  }
Â  Â Â 
Â  Â  .reservatorio-wrapper {Â 
Â  Â  Â  Â  width: 95%;Â 
Â  Â  Â  Â  max-width: 300px;
Â  Â  Â  Â  height: 50vh;Â 
Â  Â  Â  Â  min-height: 400px;
Â  Â  }
Â  Â Â 
Â  Â  .logo {Â 
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  margin-bottom: 15px;Â 
Â  Â  Â  Â  width: 140px;
Â  Â  }Â 
Â  Â Â 
Â  Â  #grafico-container header, .header-right {Â 
Â  Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  Â  align-items: stretch;Â 
Â  Â  Â  Â  gap: 10px;Â 
Â  Â  }Â 
Â  Â Â 
Â  Â  .controls {Â 
Â  Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  Â  align-items: stretch;
Â  Â  Â  Â  gap: 8px;
Â  Â  }Â 
Â  Â Â 
Â  Â  .view-selector {Â 
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  width: 100%;
Â  Â  }Â 
Â  Â Â 
Â  Â  .config-board {Â 
Â  Â  Â  Â  grid-template-columns: 1fr;Â 
Â  Â  Â  Â  gap: 15px;
Â  Â  }
Â  Â Â 
Â  Â  .chart-card {
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  margin: 0 5px;
Â  Â  }

Â  Â  .chart-container {
Â  Â  Â  Â  height: 300px !important;
Â  Â  Â  Â  min-height: 250px;
Â  Â  }

Â  Â  canvas {
Â  Â  Â  Â  height: 300px !important;
Â  Â  Â  Â  max-height: 300px;
Â  Â  }

Â  Â  .leitura-atual {
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  right: auto;
Â  Â  Â  Â  top: auto;
Â  Â  Â  Â  transform: none;
Â  Â  Â  Â  margin: 20px auto;
Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  max-width: 200px;
Â  Â  }

Â  Â  input[type="date"], input[type="month"] {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  font-size: 16px; /* Prevent zoom on iOS */
Â  Â  }

Â  Â  .form-group {
Â  Â  Â  Â  flex-direction: column;
Â  Â  }

Â  Â  .form-group input, .form-group select {
Â  Â  Â  Â  width: 100%;
Â  Â  }

Â  Â  #grafico-container header h1 {
Â  Â  Â  Â  font-size: 1.3rem;
Â  Â  }

Â  Â  .modern-button {
Â  Â  Â  Â  padding: 12px 16px;
Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  }
}

@media (max-width: 480px) {
Â  Â  .chart-container {
Â  Â  Â  Â  height: 250px !important;
Â  Â  Â  Â  min-height: 200px;
Â  Â  }

Â  Â  canvas {
Â  Â  Â  Â  height: 250px !important;
Â  Â  }

Â  Â  .reservatorio-wrapper {
Â  Â  Â  Â  height: 45vh;
Â  Â  Â  Â  min-height: 350px;
Â  Â  }

Â  Â  .main-header {
Â  Â  Â  Â  gap: 5px;
Â  Â  }

Â  Â  .nav-button {
Â  Â  Â  Â  padding: 6px 8px;
Â  Â  Â  Â  font-size: 0.75rem;
Â  Â  }

Â  Â  .view-btn {
Â  Â  Â  Â  padding: 6px 10px;
Â  Â  Â  Â  font-size: 0.75rem;
Â  Â  }
}

.erro-conexao {
Â  Â  background: #fee2e2;
Â  Â  border: 1px solid #fecaca;
Â  Â  color: #dc2626;
Â  Â  padding: 10px 15px;
Â  Â  border-radius: 8px;
Â  Â  margin: 10px 0;
Â  Â  font-weight: bold;
}

/* Prevenir zoom em inputs no iOS */
@media screen and (-webkit-min-device-pixel-ratio:0) {
Â  Â  select,
Â  Â  textarea,
Â  Â  input {
Â  Â  Â  Â  font-size: 16px;
Â  Â  }
}

/* Melhorar o comportamento responsivo dos grÃ¡ficos */
#grafico-container {
Â  Â  backface-visibility: hidden;
Â  Â  perspective: 1000;
}

.chart-container canvas {
Â  Â  -webkit-transform: translateZ(0);
Â  Â  transform: translateZ(0);
}

/* Garantir que os grÃ¡ficos sejam visÃ­veis no WebView */
.chart-container {
Â  Â  background: white;
}

/* ForÃ§ar hardware acceleration */
.chart-card {
Â  Â  transform: translateZ(0);
}
</style>
</head>
<body>

<div class="main-header">
Â  Â  <button id="btn-view-caixa" class="nav-button view-btn">Caixa D'Ã¡gua</button>
Â  Â  <button id="btn-view-grafico" class="nav-button view-btn">GrÃ¡fico</button>
Â  Â  <button id="btn-view-config" class="nav-button view-btn">ConfiguraÃ§Ãµes</button>
</div>

<img class="logo" src="https://viacristais.tribox.info/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">

<div class="leitura-atual" id="leitura-atual">
Â  Â  <h3>Leitura Atual</h3>
Â  Â  <div class="leitura-valor" id="leitura-valor">0%</div>
Â  Â  <div class="leitura-hora" id="leitura-hora">--:--</div>
</div>

<div id="caixa-view">
Â  Â  <div class="reservatorio-wrapper" id="caixa-container">
Â  Â  Â  Â  <svg id="reservatorio-svg" viewBox="0 0 400 1000" preserveAspectRatio="xMidYMin meet">
Â  Â  Â  Â  Â  Â  <defs>
Â  Â  Â  Â  Â  Â  Â  Â  <linearGradient id="grad-metal" x1="0%" y1="0%" x2="100%" y2="0%">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <stop offset="0%" stop-color="#DADADA"/><stop offset="50%" stop-color="#FAFAFA"/><stop offset="100%" stop-color="#CFCFCF"/>
Â  Â  Â  Â  Â  Â  Â  Â  </linearGradient>
Â  Â  Â  Â  Â  Â  Â  Â  <clipPath id="mascara-agua">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M 105 220 L 295 220 L 295 440 L 265 500 L 135 500 L 105 440 Z"/>
Â  Â  Â  Â  Â  Â  Â  Â  </clipPath>
Â  Â  Â  Â  Â  Â  </defs>
Â  Â  Â  Â  Â  Â  <foreignObject x="105" y="220" width="190" height="280" clip-path="url(#mascara-agua)">
Â  Â  Â  Â  Â  Â  Â  Â  <div xmlns="http://www.w3.org/1999/xhtml" class="agua-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="agua" id="agua">0%</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </foreignObject>
Â  Â  Â  Â  Â  Â  <g id="estrutura-reservatorio">
Â  Â  Â  Â  Â  Â  Â  Â  <g id="base"><path class="base-concreto" d="M 80 950 L 320 950 L 310 930 L 90 930 Z"/><path class="suportes-base" d="M 130 930 L 120 940 L 140 940 Z M 170 930 L 160 940 L 180 940 Z M 210 930 L 200 940 L 220 940 Z M 250 930 L 240 940 L 260 940 Z M 290 930 L 280 940 L 300 940 Z"/></g>
Â  Â  Â  Â  Â  Â  Â  Â  <g id="coluna"><path class="estrutura-solida" d="M 135 930 L 135 500 L 265 500 L 265 930 Z"/><path class="faixa-metalica" d="M 135 620 L 265 620 M 135 770 L 265 770"/></g>
Â  Â  Â  Â  Â  Â  Â  Â  <g id="taca-solida"><path class="taca-solida" d="M 100 440 L 100 220 L 300 220 L 300 440 L 265 500 L 135 500 Z"/><path class="guarda-corpo" d="M 100 220 A 100 25 0 0 1 300 220"/></g>
Â  Â  Â  Â  Â  Â  Â  Â  <g id="leds-base"><circle id="led-verde" class="led-base verde" cx="160" cy="975" r="12" /><circle id="led-amarelo" class="led-base amarelo" cx="200" cy="975" r="12" /><circle id="led-vermelho" class="led-base vermelho" cx="240" cy="975" r="12" /></g>
Â  Â  Â  Â  Â  Â  </g>
Â  Â  Â  Â  </svg>
Â  Â  </div>
Â  Â  <div id="status-alerta-caixa" class="small" style="font-weight:bold; font-size: 1rem; margin-top: 15px; min-height: 1.2rem;"></div>
</div>

<div id="grafico-container" style="display:none;">
Â  Â  <header>
Â  Â  Â  Â  <div class="header-right">
Â  Â  Â  Â  Â  Â  <h1>HistÃ³rico de Monitoramento</h1>
Â  Â  Â  Â  Â  Â  <div class="view-selector">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="view-btn active" data-view="diario">DiÃ¡rio</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="view-btn" data-view="mensal">Mensal</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="view-btn" data-view="intervalo">Intervalo</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="diario-picker"><input type="date" id="dataEscolhida"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="mensal-picker" style="display:none;"><input type="month" id="mesEscolhido"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="intervalo-picker" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="month" id="mesInicio" placeholder="MÃªs inicial">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>atÃ©</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="month" id="mesFim" placeholder="MÃªs final">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnAtualizar" class="modern-button">Carregar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </header>
Â  Â  <div class="board">
Â  Â  Â  Â  <div class="charts">
Â  Â  Â  Â  Â  Â  <div class="chart-card">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>GrÃ¡fico de Linha â€” NÃ­vel (%)</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="chartLinha"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="small" id="info-linha">Exibe o histÃ³rico de nÃ­vel ao longo do perÃ­odo selecionado.</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="chart-card">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>GrÃ¡fico de Barras â€” VariaÃ§Ã£o</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="chartVela"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="small" id="info-vela">Mostra a variaÃ§Ã£o do nÃ­vel por perÃ­odo.</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="config-view" style="display:none;">
Â  Â  <h1>ConfiguraÃ§Ãµes de NotificaÃ§Ã£o</h1>
Â  Â  <p class="small" style="max-width: 600px; margin: -10px auto 20px auto;">
Â  Â  Â  Â  As configuraÃ§Ãµes salvas aqui serÃ£o lidas automaticamente pelo ESP32 em campo.
Â  Â  </p>
Â  Â  <div class="config-board">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="config-card">
Â  Â  Â  Â  Â  Â  <h2>Definir NÃ­vel de Alerta (%)</h2>
Â  Â  Â  Â  Â  Â  <p class="small" style="margin-top:-10px; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Define a porcentagem que dispara o alerta de nÃ­vel baixo.
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="nivel-alerta-valor" placeholder="Ex: 30" min="1" max="99">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-salvar-nivel-alerta" class="modern-button">Salvar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="status-alerta" class="small" style="font-weight:bold;"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="config-card">
Â  Â  Â  Â  Â  Â  <h2>Definir Chat ID do Telegram</h2>
Â  Â  Â  Â  Â  Â  <p class="small" style="margin-top:-10px; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  ID numÃ©rico do usuÃ¡rio ou grupo do Telegram.
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="telegram-id-valor" placeholder="Ex: -100123...">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-salvar-telegram-id" class="modern-button">Salvar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="status-telegram" class="small" style="font-weight:bold;"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="config-card card-emails">
Â  Â  Â  Â  Â  Â  <h2>Gerenciar E-mails de Alerta</h2>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="email-valor" placeholder="novo.email@provedor.com">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-add-email" class="modern-button">Adicionar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="status-email" class="small" style="font-weight:bold; margin-bottom: 15px;"></div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <h3 style="margin-bottom: 10px; color: #555;">E-mails Salvos:</h3>
Â  Â  Â  Â  Â  Â  <ul id="lista-emails">
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </div>

Â  Â  </div>
</div>

<script>
// --- CONSTANTES DO FIREBASE ---
const DB_URL = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/";
const URL_NIVEL_ATUAL = `${DB_URL}/nivel_atual.json`;Â  Â  Â  Â 
const URL_NIVEL_LEGADO_PP7 = `${DB_URL}/PP7/nivel_pct.json`;Â 
const URL_HISTORICO_NOVO = `${DB_URL}/PP7_historico`;Â 
const URL_HISTORICO_ANTIGO = `${DB_URL}/leituras.json`;Â 
const URL_CONFIG_NIVEL = `${DB_URL}/config/nivel_minimo.json`;Â 
const URL_CONFIG_TELEGRAM = `${DB_URL}/config/telegram.json`;
const URL_CONFIG_EMAILS = `${DB_URL}/config/emails.json`;

// --- VARIÃVEIS GLOBAIS ---
let chartLinha, chartVela;
let historicoNiveis = [], historicoLabels = [];
let dadosVela = [], labelsVela = [];
let ultimoRegistroHistorico = 0;
let currentView = 'diario';
let nivelAtual = 1;
let nivelAlertaConfigurado = 30;
let authErrorNotified = false;Â 
let fetchRetryCount = 0;
const MAX_FETCH_FAILURES = 5;
let loopIntervalo;

// --- CONFIGURAÃ‡ÃƒO DE HISTÃ“RICO ---
const INTERVALO_SALVAMENTO = 5 * 60 * 1000; // 5 minutos

// --- FLAG PARA MIT APP INVENTOR ---
let isMitAppInventor = false;

// --- DETECTAR SE ESTÃ NO MIT APP INVENTOR ---
function detectarAmbiente() {
Â  Â  // Verifica se estÃ¡ em um WebView (MIT App Inventor)
Â  Â  if (window.navigator.userAgent.includes('WebView') ||Â 
Â  Â  Â  Â  window.navigator.userAgent.includes('AppInventor') ||
Â  Â  Â  Â  !window.chrome) {
Â  Â  Â  Â  isMitAppInventor = true;
Â  Â  Â  Â  console.log("ğŸš€ Ambiente detectado: MIT App Inventor WebView");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Aplicar correÃ§Ãµes especÃ­ficas para MIT App Inventor
Â  Â  Â  Â  aplicarCorrecoesMitAppInventor();
Â  Â  }
}

// --- CORREÃ‡Ã•ES ESPECÃFICAS PARA MIT APP INVENTOR ---
function aplicarCorrecoesMitAppInventor() {
Â  Â  console.log("ğŸ”§ Aplicando correÃ§Ãµes para MIT App Inventor...");
Â  Â Â 
Â  Â  // ForÃ§ar redimensionamento inicial
Â  Â  setTimeout(() => {
Â  Â  Â  Â  if (chartLinha) chartLinha.resize();
Â  Â  Â  Â  if (chartVela) chartVela.resize();
Â  Â  }, 1000);
Â  Â Â 
Â  Â  // Adicionar mais listeners para garantir funcionamento
Â  Â  document.addEventListener('visibilitychange', function() {
Â  Â  Â  Â  setTimeout(redimensionarGraficos, 300);
Â  Â  });
Â  Â Â 
Â  Â  // ForÃ§ar atualizaÃ§Ã£o periÃ³dica dos grÃ¡ficos
Â  Â  setInterval(() => {
Â  Â  Â  Â  if (document.getElementById('grafico-container').style.display !== 'none') {
Â  Â  Â  Â  Â  Â  redimensionarGraficos();
Â  Â  Â  Â  }
Â  Â  }, 5000);
}

// --- FUNÃ‡Ã•ES DE HISTÃ“RICO ---
function obterTimestampAtual() {
Â  Â  return Date.now();
}

function formatarHoraParaHistorico(timestamp) {
Â  Â  const date = new Date(timestamp);
Â  Â  return date.toLocaleTimeString('pt-BR', {Â 
Â  Â  Â  Â  hour: '2-digit',Â 
Â  Â  Â  Â  minute: '2-digit',
Â  Â  Â  Â  hour12: false
Â  Â  });
}

function formatarDataParaHistorico(timestamp) {
Â  Â  const date = new Date(timestamp);
Â  Â  return date.toISOString().split('T')[0];
}

function salvarHistoricoLocal(nivel) {
Â  Â  try {
Â  Â  Â  Â  const timestamp = obterTimestampAtual();
Â  Â  Â  Â  const data = formatarDataParaHistorico(timestamp);
Â  Â  Â  Â  const hora = formatarHoraParaHistorico(timestamp);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const historicoLocal = JSON.parse(localStorage.getItem('historicoCaixaAgua') || '{}');
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!historicoLocal[data]) {
Â  Â  Â  Â  Â  Â  historicoLocal[data] = {};
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  historicoLocal[data][hora] = {
Â  Â  Â  Â  Â  Â  nivel: nivel,
Â  Â  Â  Â  Â  Â  timestamp: timestamp
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const datas = Object.keys(historicoLocal).sort();
Â  Â  Â  Â  if (datas.length > 90) {
Â  Â  Â  Â  Â  Â  const datasParaRemover = datas.slice(0, datas.length - 90);
Â  Â  Â  Â  Â  Â  datasParaRemover.forEach(dataParaRemover => {
Â  Â  Â  Â  Â  Â  Â  Â  delete historicoLocal[dataParaRemover];
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  Object.keys(historicoLocal).forEach(dataKey => {
Â  Â  Â  Â  Â  Â  const registrosDoDia = historicoLocal[dataKey];
Â  Â  Â  Â  Â  Â  const horas = Object.keys(registrosDoDia).sort();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (horas.length > 288) {
Â  Â  Â  Â  Â  Â  Â  Â  const horasParaRemover = horas.slice(0, horas.length - 288);
Â  Â  Â  Â  Â  Â  Â  Â  horasParaRemover.forEach(horaParaRemover => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete registrosDoDia[horaParaRemover];
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  localStorage.setItem('historicoCaixaAgua', JSON.stringify(historicoLocal));
Â  Â  Â  Â  console.log(`âœ… HistÃ³rico salvo: ${data} ${hora} - ${nivel}%`);
Â  Â  Â  Â Â 
Â  Â  Â  Â  return true;
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('âŒ Erro ao salvar histÃ³rico local:', e);
Â  Â  Â  Â  return false;
Â  Â  }
}

function carregarHistoricoLocal(dataFiltro = null) {
Â  Â  try {
Â  Â  Â  Â  const historicoLocal = JSON.parse(localStorage.getItem('historicoCaixaAgua') || '{}');
Â  Â  Â  Â  const registros = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  Object.keys(historicoLocal).forEach(data => {
Â  Â  Â  Â  Â  Â  Object.keys(historicoLocal[data]).forEach(hora => {
Â  Â  Â  Â  Â  Â  Â  Â  const registro = historicoLocal[data][hora];
Â  Â  Â  Â  Â  Â  Â  Â  registros.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: data,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hora: hora,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nivel: registro.nivel,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: registro.timestamp
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  registros.sort((a, b) => a.timestamp - b.timestamp);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const registrosFiltrados = dataFiltroÂ 
Â  Â  Â  Â  Â  Â  ? registros.filter(r => r.data === dataFiltro)
Â  Â  Â  Â  Â  Â  : registros;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const labels = registrosFiltrados.map(r =>Â 
Â  Â  Â  Â  Â  Â  dataFiltro ? r.hora : `${r.data} ${r.hora}`
Â  Â  Â  Â  );
Â  Â  Â  Â  const niveis = registrosFiltrados.map(r => r.nivel);
Â  Â  Â  Â Â 
Â  Â  Â  Â  return { labels, niveis };
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('Erro ao carregar histÃ³rico local:', e);
Â  Â  Â  Â  return { labels: [], niveis: [] };
Â  Â  }
}

function deveSalvarHistorico() {
Â  Â  const agora = obterTimestampAtual();
Â  Â  return (agora - ultimoRegistroHistorico) >= INTERVALO_SALVAMENTO;
}

// --- FUNÃ‡Ã•ES DO GRÃFICO - OTIMIZADAS PARA WEBVIEW ---
function criarGraficos() {
Â  Â  console.log("ğŸ“Š Inicializando grÃ¡ficos...");
Â  Â Â 
Â  Â  // Destruir grÃ¡ficos existentes se houver
Â  Â  if (chartLinha) {
Â  Â  Â  Â  chartLinha.destroy();
Â  Â  }
Â  Â  if (chartVela) {
Â  Â  Â  Â  chartVela.destroy();
Â  Â  }

Â  Â  const ctxL = document.getElementById('chartLinha').getContext('2d');
Â  Â  const grad = ctxL.createLinearGradient(0, 0, 0, 300);
Â  Â  grad.addColorStop(0, 'rgba(6,182,212,0.28)');
Â  Â  grad.addColorStop(1, 'rgba(6,182,212,0.03)');
Â  Â Â 
Â  Â  chartLinha = new Chart(ctxL, {
Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  data: {Â 
Â  Â  Â  Â  Â  Â  labels: [],Â 
Â  Â  Â  Â  Â  Â  datasets: [{Â 
Â  Â  Â  Â  Â  Â  Â  Â  label: 'NÃ­vel (%)',Â 
Â  Â  Â  Â  Â  Â  Â  Â  data: [],Â 
Â  Â  Â  Â  Â  Â  Â  Â  fill: true,Â 
Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: grad,Â 
Â  Â  Â  Â  Â  Â  Â  Â  borderColor: 'rgba(6,182,212,0.95)',Â 
Â  Â  Â  Â  Â  Â  Â  Â  tension: 0.25,Â 
Â  Â  Â  Â  Â  Â  Â  Â  pointRadius: isMitAppInventor ? 3 : 2,
Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 2,
Â  Â  Â  Â  Â  Â  Â  Â  pointBackgroundColor: 'rgba(6,182,212,1)',
Â  Â  Â  Â  Â  Â  Â  Â  pointBorderColor: '#ffffff',
Â  Â  Â  Â  Â  Â  Â  Â  pointBorderWidth: 1,
Â  Â  Â  Â  Â  Â  Â  Â  pointHoverRadius: 4
Â  Â  Â  Â  Â  Â  }]Â 
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {Â 
Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  resizeDelay: isMitAppInventor ? 300 : 200,
Â  Â  Â  Â  Â  Â  animation: {
Â  Â  Â  Â  Â  Â  Â  Â  duration: isMitAppInventor ? 500 : 0,
Â  Â  Â  Â  Â  Â  Â  Â  onComplete: function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Callback para garantir que o grÃ¡fico foi renderizado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMitAppInventor) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(redimensionarGraficos, 200);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  plugins: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  legend: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: '#666',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  family: 'Arial, Helvetica, sans-serif',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: window.innerWidth < 480 ? 10 : 12
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'index',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  intersect: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(0,0,0,0.7)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleFont: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: window.innerWidth < 480 ? 10 : 12
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bodyFont: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: window.innerWidth < 480 ? 10 : 12
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },Â 
Â  Â  Â  Â  Â  Â  scales: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  x: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: '#666',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maxRotation: 45,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  minRotation: 45,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: window.innerWidth < 480 ? 8 : 10
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: 'rgba(0,0,0,0.05)'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },Â 
Â  Â  Â  Â  Â  Â  Â  Â  y: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: '#666',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: window.innerWidth < 480 ? 8 : 10
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  min: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  max: 100,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: 'rgba(0,0,0,0.05)'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  interaction: {
Â  Â  Â  Â  Â  Â  Â  Â  mode: 'nearest',
Â  Â  Â  Â  Â  Â  Â  Â  axis: 'x',
Â  Â  Â  Â  Â  Â  Â  Â  intersect: false
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  elements: {
Â  Â  Â  Â  Â  Â  Â  Â  point: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radius: window.innerWidth < 480 ? 2 : 3
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });

Â  Â  const ctxV = document.getElementById('chartVela').getContext('2d');
Â  Â Â 
Â  Â  chartVela = new Chart(ctxV, {
Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  labels: [],
Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  label: 'NÃ­vel (%)',
Â  Â  Â  Â  Â  Â  Â  Â  data: [],
Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(6, 182, 212, 0.8)',
Â  Â  Â  Â  Â  Â  Â  Â  borderColor: 'rgba(6, 182, 212, 1)',
Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1,
Â  Â  Â  Â  Â  Â  Â  Â  borderRadius: 4,
Â  Â  Â  Â  Â  Â  Â  Â  borderSkipped: false,
Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  resizeDelay: isMitAppInventor ? 300 : 200,
Â  Â  Â  Â  Â  Â  animation: {
Â  Â  Â  Â  Â  Â  Â  Â  duration: isMitAppInventor ? 500 : 0,
Â  Â  Â  Â  Â  Â  Â  Â  onComplete: function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMitAppInventor) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(redimensionarGraficos, 200);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'top',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: '#666',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  family: 'Arial, Helvetica, sans-serif',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: window.innerWidth < 480 ? 10 : 12
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(0,0,0,0.7)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleFont: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: window.innerWidth < 480 ? 10 : 12
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bodyFont: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: window.innerWidth < 480 ? 10 : 12
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  callbacks: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: function(context) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `NÃ­vel: ${context.parsed.y}%`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  x: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: '#666',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: window.innerWidth < 480 ? 8 : 10
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: 'rgba(0,0,0,0.05)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: false
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: '#666',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: window.innerWidth < 480 ? 8 : 10
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  min: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  max: 100,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { color: 'rgba(0,0,0,0.05)' }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
Â  Â Â 
Â  Â  console.log("âœ… GrÃ¡ficos inicializados com sucesso");
}

// --- FUNÃ‡ÃƒO PARA REDIMENSIONAR GRÃFICOS ---
function redimensionarGraficos() {
Â  Â  if (isMitAppInventor) {
Â  Â  Â  Â  console.log("ğŸ”„ Redimensionando grÃ¡ficos para MIT App Inventor...");
Â  Â  }
Â  Â Â 
Â  Â  // ForÃ§ar um recÃ¡lculo do layout
Â  Â  if (chartLinha && chartLinha.canvas) {
Â  Â  Â  Â  const canvasLinha = chartLinha.canvas;
Â  Â  Â  Â  const containerLinha = canvasLinha.parentElement;
Â  Â  Â  Â  if (containerLinha) {
Â  Â  Â  Â  Â  Â  containerLinha.style.height = containerLinha.offsetHeight + 'px';
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  chartLinha.resize();
Â  Â  Â  Â  Â  Â  Â  Â  chartLinha.update('none');
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Erro ao redimensionar grÃ¡fico de linha:", e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  if (chartVela && chartVela.canvas) {
Â  Â  Â  Â  const canvasVela = chartVela.canvas;
Â  Â  Â  Â  const containerVela = canvasVela.parentElement;
Â  Â  Â  Â  if (containerVela) {
Â  Â  Â  Â  Â  Â  containerVela.style.height = containerVela.offsetHeight + 'px';
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  chartVela.resize();
Â  Â  Â  Â  Â  Â  Â  Â  chartVela.update('none');
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Erro ao redimensionar grÃ¡fico de barras:", e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
}

function agruparPorDias(dados) {
Â  Â  const diasAgrupados = {};
Â  Â Â 
Â  Â  dados.forEach(registro => {
Â  Â  Â  Â  if (!diasAgrupados[registro.data]) {
Â  Â  Â  Â  Â  Â  diasAgrupados[registro.data] = [];
Â  Â  Â  Â  }
Â  Â  Â  Â  diasAgrupados[registro.data].push(registro.nivel);
Â  Â  });
Â  Â Â 
Â  Â  const resultado = {};
Â  Â  Object.keys(diasAgrupados).forEach(dia => {
Â  Â  Â  Â  const niveis = diasAgrupados[dia];
Â  Â  Â  Â  resultado[dia] = niveis.reduce((a, b) => a + b, 0) / niveis.length;
Â  Â  });
Â  Â Â 
Â  Â  return resultado;
}

function agruparPorSemanas(dados) {
Â  Â  const semanas = {};
Â  Â Â 
Â  Â  dados.forEach(registro => {
Â  Â  Â  Â  const date = new Date(registro.data + 'T00:00:00');
Â  Â  Â  Â  const semanaAno = getWeekNumber(date);
Â  Â  Â  Â  const chaveSemana = `Semana ${semanaAno.semana}/${semanaAno.ano}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!semanas[chaveSemana]) {
Â  Â  Â  Â  Â  Â  semanas[chaveSemana] = [];
Â  Â  Â  Â  }
Â  Â  Â  Â  semanas[chaveSemana].push(registro.nivel);
Â  Â  });
Â  Â Â 
Â  Â  const resultado = {};
Â  Â  Object.keys(semanas).forEach(semana => {
Â  Â  Â  Â  const niveis = semanas[semana];
Â  Â  Â  Â  resultado[semana] = niveis.reduce((a, b) => a + b, 0) / niveis.length;
Â  Â  });
Â  Â Â 
Â  Â  return resultado;
}

function agruparPorMeses(dados) {
Â  Â  const meses = {};
Â  Â Â 
Â  Â  dados.forEach(registro => {
Â  Â  Â  Â  const [ano, mes] = registro.data.split('-');
Â  Â  Â  Â  const chaveMes = `${mes}/${ano}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!meses[chaveMes]) {
Â  Â  Â  Â  Â  Â  meses[chaveMes] = [];
Â  Â  Â  Â  }
Â  Â  Â  Â  meses[chaveMes].push(registro.nivel);
Â  Â  });
Â  Â Â 
Â  Â  const resultado = {};
Â  Â  Object.keys(meses).forEach(mes => {
Â  Â  Â  Â  const niveis = meses[mes];
Â  Â  Â  Â  resultado[mes] = niveis.reduce((a, b) => a + b, 0) / niveis.length;
Â  Â  });
Â  Â Â 
Â  Â  return resultado;
}

function getWeekNumber(date) {
Â  Â  const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
Â  Â  const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
Â  Â  return {
Â  Â  Â  Â  semana: Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7),
Â  Â  Â  Â  ano: date.getFullYear()
Â  Â  };
}

// --- FUNÃ‡ÃƒO PRINCIPAL DE CARREGAMENTO DE HISTÃ“RICO ---
async function carregarHistorico() {
Â  Â  const infoLinha = document.getElementById('info-linha');
Â  Â  const infoVela = document.getElementById('info-vela');
Â  Â  let dataInicio, dataFim;
Â  Â  let dataEscolhida;

Â  Â  if (currentView === 'diario') {
Â  Â  Â  Â  dataEscolhida = document.getElementById('dataEscolhida').value;
Â  Â  Â  Â  if (!dataEscolhida) return;
Â  Â  Â  Â  dataInicio = `${dataEscolhida}T00:00:00`;
Â  Â  Â  Â  dataFim = `${dataEscolhida}T23:59:59`;
Â  Â  Â  Â  infoLinha.textContent = `Exibe o histÃ³rico de nÃ­vel ao longo do dia ${dataEscolhida}.`;
Â  Â  Â  Â  infoVela.textContent = `Mostra o nÃ­vel por hora no dia ${dataEscolhida}.`;
Â  Â  } else if (currentView === 'mensal') {
Â  Â  Â  Â  const mesAno = document.getElementById('mesEscolhido').value;
Â  Â  Â  Â  if (!mesAno) return;
Â  Â  Â  Â  const [ano, mes] = mesAno.split('-');
Â  Â  Â  Â  dataInicio = `${mesAno}-01T00:00:00`;
Â  Â  Â  Â  const ultimoDia = new Date(ano, mes, 0).getDate();
Â  Â  Â  Â  dataFim = `${mesAno}-${ultimoDia}T23:59:59`;
Â  Â  Â  Â  infoLinha.textContent = `Exibe o histÃ³rico de nÃ­vel por semanas do mÃªs ${mes}/${ano}.`;
Â  Â  Â  Â  infoVela.textContent = `Mostra o nÃ­vel por dia no mÃªs ${mes}/${ano}.`;
Â  Â  } else {
Â  Â  Â  Â  const mesInicio = document.getElementById('mesInicio').value;
Â  Â  Â  Â  const mesFim = document.getElementById('mesFim').value;
Â  Â  Â  Â  if (!mesInicio || !mesFim) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const [anoInicio, mesInicioNum] = mesInicio.split('-');
Â  Â  Â  Â  const [anoFim, mesFimNum] = mesFim.split('-');
Â  Â  Â  Â Â 
Â  Â  Â  Â  dataInicio = `${mesInicio}-01T00:00:00`;
Â  Â  Â  Â  const ultimoDiaFim = new Date(anoFim, mesFimNum, 0).getDate();
Â  Â  Â  Â  dataFim = `${mesFim}-${ultimoDiaFim}T23:59:59`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  infoLinha.textContent = `Exibe o histÃ³rico de nÃ­vel por meses de ${mesInicioNum}/${anoInicio} a ${mesFimNum}/${anoFim}.`;
Â  Â  Â  Â  infoVela.textContent = `Mostra o nÃ­vel por mÃªs de ${mesInicioNum}/${anoInicio} a ${mesFimNum}/${anoFim}.`;
Â  Â  }

Â  Â  console.log("ğŸ“Š Carregando histÃ³rico do localStorage...");
Â  Â Â 
Â  Â  let registrosFiltrados = [];
Â  Â Â 
Â  Â  if (currentView === 'diario') {
Â  Â  Â  Â  const { labels: labelsDoDia, niveis: niveisDoDia } = carregarHistoricoLocal(dataEscolhida);
Â  Â  Â  Â Â 
Â  Â  Â  Â  for (let i = 0; i < labelsDoDia.length; i++) {
Â  Â  Â  Â  Â  Â  registrosFiltrados.push({
Â  Â  Â  Â  Â  Â  Â  Â  label: labelsDoDia[i],
Â  Â  Â  Â  Â  Â  Â  Â  nivel: niveisDoDia[i]
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  const { labels: todasLabels, niveis: todosNiveis } = carregarHistoricoLocal();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const dataInicioObj = new Date(dataInicio);
Â  Â  Â  Â  const dataFimObj = new Date(dataFim);
Â  Â  Â  Â Â 
Â  Â  Â  Â  for (let i = 0; i < todasLabels.length; i++) {
Â  Â  Â  Â  Â  Â  const labelParts = todasLabels[i].split(' ');
Â  Â  Â  Â  Â  Â  const registroData = new Date(labelParts[0] + 'T00:00:00');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (registroData >= dataInicioObj && registroData <= dataFimObj) {
Â  Â  Â  Â  Â  Â  Â  Â  registrosFiltrados.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: todasLabels[i],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nivel: todosNiveis[i]
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (currentView === 'diario') {
Â  Â  Â  Â  historicoLabels = registrosFiltrados.map(r => r.label);
Â  Â  Â  Â  historicoNiveis = registrosFiltrados.map(r => r.nivel);
Â  Â  Â  Â Â 
Â  Â  Â  Â  labelsVela = historicoLabels;
Â  Â  Â  Â  dadosVela = historicoNiveis;
Â  Â  Â  Â Â 
Â  Â  } else if (currentView === 'mensal') {
Â  Â  Â  Â  const registrosComData = registrosFiltrados.map(r => ({
Â  Â  Â  Â  Â  Â  data: r.label.split(' ')[0],
Â  Â  Â  Â  Â  Â  nivel: r.nivel
Â  Â  Â  Â  }));
Â  Â  Â  Â Â 
Â  Â  Â  Â  const semanas = agruparPorSemanas(registrosComData);
Â  Â  Â  Â  historicoLabels = Object.keys(semanas);
Â  Â  Â  Â  historicoNiveis = Object.values(semanas);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const dias = agruparPorDias(registrosComData);
Â  Â  Â  Â  labelsVela = Object.keys(dias);
Â  Â  Â  Â  dadosVela = Object.values(dias);
Â  Â  Â  Â Â 
Â  Â  } else {
Â  Â  Â  Â  const registrosComData = registrosFiltrados.map(r => ({
Â  Â  Â  Â  Â  Â  data: r.label.split(' ')[0],
Â  Â  Â  Â  Â  Â  nivel: r.nivel
Â  Â  Â  Â  }));
Â  Â  Â  Â Â 
Â  Â  Â  Â  const meses = agruparPorMeses(registrosComData);
Â  Â  Â  Â  historicoLabels = Object.keys(meses);
Â  Â  Â  Â  historicoNiveis = Object.values(meses);
Â  Â  Â  Â Â 
Â  Â  Â  Â  labelsVela = historicoLabels;
Â  Â  Â  Â  dadosVela = historicoNiveis;
Â  Â  }

Â  Â  console.log(`ğŸ“ˆ Carregados ${historicoLabels.length} registros para o grÃ¡fico`);
Â  Â Â 
Â  Â  if (chartLinha && chartVela) {
Â  Â  Â  Â  chartLinha.data.labels = historicoLabels;
Â  Â  Â  Â  chartLinha.data.datasets[0].data = historicoNiveis;
Â  Â  Â  Â Â 
Â  Â  Â  Â  chartVela.data.labels = labelsVela;
Â  Â  Â  Â  chartVela.data.datasets[0].data = dadosVela;
Â  Â  Â  Â Â 
Â  Â  Â  Â  chartLinha.update('none');
Â  Â  Â  Â  chartVela.update('none');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // CORREÃ‡ÃƒO: Redimensionar apÃ³s atualizaÃ§Ã£o
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  redimensionarGraficos();
Â  Â  Â  Â  Â  Â  if (isMitAppInventor) {
Â  Â  Â  Â  Â  Â  Â  Â  // Tentativas extras para MIT App Inventor
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(redimensionarGraficos, 500);
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(redimensionarGraficos, 1000);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 100);
Â  Â  }
}

// --- FUNÃ‡Ã•ES DE ATUALIZAÃ‡ÃƒO ---
function atualizarCaixaDOM(nivel) {
Â  Â  const aguaDiv = document.getElementById('agua');
Â  Â  aguaDiv.style.height = nivel + '%';
Â  Â  aguaDiv.innerText = nivel + '%';

Â  Â  const nivelAlerta = nivelAlertaConfigurado || 30;

Â  Â  if (nivel > 60) aguaDiv.style.background = 'linear-gradient(to top, #00ffcc, #1e90ff)';
Â  Â  else if (nivel > nivelAlerta) aguaDiv.style.background = 'linear-gradient(to top, #ffff66, #ffcc00)';
Â  Â  else aguaDiv.style.background = 'linear-gradient(to top, #ff3333, #990000)';

Â  Â  const ledVermelho = document.getElementById('led-vermelho');
Â  Â  const ledAmarelo = document.getElementById('led-amarelo');
Â  Â  const ledVerde = document.getElementById('led-verde');
Â  Â  ledVermelho.classList.remove('aceso');
Â  Â  ledAmarelo.classList.remove('aceso');
Â  Â  ledVerde.classList.remove('aceso');

Â  Â  if (nivel > 60) ledVerde.classList.add('aceso');
Â  Â  else if (nivel > nivelAlerta) ledAmarelo.classList.add('aceso');
Â  Â  else ledVermelho.classList.add('aceso');

Â  Â  atualizarLeituraAtual(nivel);

Â  Â  const statusDiv = document.getElementById('status-alerta-caixa');
Â  Â  statusDiv.innerText = '';
}

function atualizarLeituraAtual(nivel) {
Â  Â  const leituraValor = document.getElementById('leitura-valor');
Â  Â  const leituraHora = document.getElementById('leitura-hora');
Â  Â Â 
Â  Â  leituraValor.textContent = nivel + '%';
Â  Â  leituraHora.textContent = new Date().toLocaleTimeString('pt-BR', {Â 
Â  Â  Â  Â  hour: '2-digit',Â 
Â  Â  Â  Â  minute: '2-digit',
Â  Â  Â  Â  second: '2-digit'
Â  Â  });

Â  Â  if (nivel > 60) {
Â  Â  Â  Â  leituraValor.style.color = '#33ff33';
Â  Â  } else if (nivel > nivelAlertaConfigurado) {
Â  Â  Â  Â  leituraValor.style.color = '#ffff33';
Â  Â  } else {
Â  Â  Â  Â  leituraValor.style.color = '#ff3333';
Â  Â  }
}

// --- FUNÃ‡ÃƒO PRINCIPAL DE ATUALIZAÃ‡ÃƒO ---
async function loopDeAtualizacao() {
Â  Â Â 
Â  Â  if (fetchRetryCount >= MAX_FETCH_FAILURES) {
Â  Â  Â  Â  if (loopIntervalo) clearInterval(loopIntervalo);
Â  Â  Â  Â  console.error("Muitas falhas de conexÃ£o com o Firebase. Loop interrompido.");
Â  Â  Â  Â  const statusDiv = document.getElementById('status-alerta-caixa');
Â  Â  Â  Â  statusDiv.style.color = '#ef4444';
Â  Â  Â  Â  statusDiv.innerText = 'ERRO DE CONEXÃƒO. Verifique as Regras do Firebase ou a rede.';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  let configNivelOk = false;
Â  Â  try {
Â  Â  Â  Â  const rConfig = await fetch(URL_CONFIG_NIVEL);
Â  Â  Â  Â  if (!rConfig.ok) throw new Error(`Falha ao buscar config: ${rConfig.status}`);
Â  Â  Â  Â  const config = await rConfig.json();
Â  Â  Â  Â  if (config !== null) {
Â  Â  Â  Â  Â  Â  nivelAlertaConfigurado = parseInt(config) || 30;
Â  Â  Â  Â  }
Â  Â  Â  Â  configNivelOk = true;
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erro ao buscar nÃ­vel de alerta:", e);
Â  Â  Â  Â  fetchRetryCount++;
Â  Â  }
Â  Â Â 
Â  Â  let nivelEncontrado = null;Â 
Â  Â  let nivelOk = false;
Â  Â  try {
Â  Â  Â  Â  const rNivel = await fetch(URL_NIVEL_ATUAL);
Â  Â  Â  Â  if (!rNivel.ok) throw new Error(`Falha ao buscar /nivel_atual: ${rNivel.status}`);
Â  Â  Â  Â  const nivelNovo = await rNivel.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (nivelNovo !== null) {
Â  Â  Â  Â  Â  Â  nivelEncontrado = Number(nivelNovo);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const rNivelLegado = await fetch(URL_NIVEL_LEGADO_PP7);
Â  Â  Â  Â  Â  Â  if (!rNivelLegado.ok) throw new Error(`Falha ao buscar /PP7/nivel_pct: ${rNivelLegado.status}`);
Â  Â  Â  Â  Â  Â  const nivelLegado = await rNivelLegado.json();
Â  Â  Â  Â  Â  Â  if (nivelLegado !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  nivelEncontrado = Number(nivelLegado);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (nivelEncontrado !== null && nivelEncontrado > 0) {
Â  Â  Â  Â  Â  Â  nivelAtual = nivelEncontrado;
Â  Â  Â  Â  Â  Â  console.log(`ğŸ”„ NÃ­vel atualizado: ${nivelAtual}%`);
Â  Â  Â  Â  } else if (nivelEncontrado === 0 || nivelEncontrado === null) {
Â  Â  Â  Â  Â  Â  if (nivelAtual > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`âš¡ NÃ­vel lido: ${nivelEncontrado}% - Mantendo Ãºltimo valor vÃ¡lido: ${nivelAtual}%`);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  nivelAtual = 1;
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`âš¡ NÃ­vel lido: ${nivelEncontrado}% - Usando fallback: ${nivelAtual}%`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  nivelOk = true;
Â  Â  Â  Â Â 
Â  Â  } catch(e) {
Â  Â  Â  Â  console.error("Falha ao ler nÃ­vel:", e.message);
Â  Â  Â  Â  fetchRetryCount++;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (nivelAtual <= 0) {
Â  Â  Â  Â  Â  Â  nivelAtual = 1;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const statusDiv = document.getElementById('status-alerta-caixa');
Â  Â  Â  Â  statusDiv.style.color = '#ef4444';
Â  Â  Â  Â  statusDiv.innerText = 'Falha ao carregar nÃ­vel (Sem conexÃ£o).';
Â  Â  }

Â  Â  if (nivelAtual <= 0) {
Â  Â  Â  Â  nivelAtual = 1;
Â  Â  }

Â  Â  atualizarCaixaDOM(nivelAtual);Â 
Â  Â Â 
Â  Â  if (deveSalvarHistorico()) {
Â  Â  Â  Â  const sucesso = salvarHistoricoLocal(nivelAtual);
Â  Â  Â  Â  if (sucesso) {
Â  Â  Â  Â  Â  Â  ultimoRegistroHistorico = obterTimestampAtual();
Â  Â  Â  Â  Â  Â  console.log(`ğŸ’¾ Registro salvo no histÃ³rico: ${nivelAtual}%`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Chama a atualizaÃ§Ã£o do grÃ¡fico imediatamente apÃ³s salvar o novo ponto
Â  Â  Â  Â  Â  Â  if (document.getElementById('grafico-container').style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  await carregarHistorico();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  if (configNivelOk && nivelOk) {
Â  Â  Â  Â  fetchRetryCount = 0;
Â  Â  }
}

// --- INICIALIZAÃ‡ÃƒO ---
window.onload = function() {
Â  Â  // Detectar ambiente primeiro
Â  Â  detectarAmbiente();
Â  Â Â 
Â  Â  const views = {
Â  Â  Â  Â  caixa: document.getElementById('caixa-view'),
Â  Â  Â  Â  grafico: document.getElementById('grafico-container'),
Â  Â  Â  Â  config: document.getElementById('config-view')
Â  Â  };
Â  Â  const btns = {
Â  Â  Â  Â  caixa: document.getElementById('btn-view-caixa'),
Â  Â  Â  Â  grafico: document.getElementById('btn-view-grafico'),
Â  Â  Â  Â  config: document.getElementById('btn-view-config')
Â  Â  };

Â  Â  function switchView(viewName) {
Â  Â  Â  Â  for (const key in views) {
Â  Â  Â  Â  Â  Â  views[key].style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â  if (views[viewName]) {
Â  Â  Â  Â  Â  Â  views[viewName].style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  document.querySelectorAll('.main-header .nav-button').forEach(btn => btn.classList.remove('active'));
Â  Â  Â  Â  if (btns[viewName]) {
Â  Â  Â  Â  Â  Â  btns[viewName].classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  if (viewName === 'grafico') {
Â  Â  Â  Â  Â  Â  // ForÃ§ar um redesenho do layout
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  carregarHistorico();
Â  Â  Â  Â  Â  Â  Â  Â  // MÃºltiplas tentativas de redimensionamento (CorreÃ§Ã£o para WebView)
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  redimensionarGraficos();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(redimensionarGraficos, 300);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMitAppInventor) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(redimensionarGraficos, 600);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(redimensionarGraficos, 900);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 200);
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  } else if (viewName === 'config') {
Â  Â  Â  Â  Â  Â  carregarConfiguracoes();Â 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  btns.caixa.addEventListener('click', () => switchView('caixa'));
Â  Â  btns.grafico.addEventListener('click', () => switchView('grafico'));
Â  Â  btns.config.addEventListener('click', () => switchView('config'));
Â  Â Â 
Â  Â  document.getElementById('btn-salvar-nivel-alerta').addEventListener('click', salvarNivelAlerta);
Â  Â  document.getElementById('btn-salvar-telegram-id').addEventListener('click', salvarTelegramId);
Â  Â  document.getElementById('btn-add-email').addEventListener('click', adicionarEmail);
Â  Â  document.getElementById('lista-emails').addEventListener('click', (e) => {
Â  Â  Â  Â  if (e.target.tagName === 'BUTTON' && e.target.dataset.email) {
Â  Â  Â  Â  Â  Â  const emailParaRemover = e.target.dataset.email;
Â  Â  Â  Â  Â  Â  removerEmail(emailParaRemover);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  criarGraficos();
Â  Â  const hoje = new Date();
Â  Â  const dataFimPadrao = hoje.toISOString().split('T')[0];
Â  Â  const mesFimPadrao = hoje.toISOString().substring(0, 7);
Â  Â Â 
Â  Â  const mesInicio = new Date();
Â  Â  mesInicio.setMonth(mesInicio.getMonth() - 3);
Â  Â  const mesInicioPadrao = mesInicio.toISOString().substring(0, 7);
Â  Â Â 
Â  Â  document.getElementById('dataEscolhida').value = dataFimPadrao;
Â  Â  document.getElementById('mesEscolhido').value = mesFimPadrao;
Â  Â  document.getElementById('mesInicio').value = mesInicioPadrao;
Â  Â  document.getElementById('mesFim').value = mesFimPadrao;
Â  Â Â 
Â  Â  switchView('caixa');
Â  Â Â 
Â  Â  nivelAtual = 1;
Â  Â Â 
Â  Â  console.log("ğŸš€ Inicializando sistema de monitoramento...");
Â  Â  carregarHistorico().then(() => {
Â  Â  Â  Â  console.log("âœ… HistÃ³rico carregado do localStorage");
Â  Â  Â  Â  loopDeAtualizacao();
Â  Â  Â  Â  loopIntervalo = setInterval(loopDeAtualizacao, 2000);
Â  Â  });

Â  Â  document.getElementById('btnAtualizar').onclick = carregarHistorico;
Â  Â Â 
Â  Â  document.querySelectorAll('.view-selector .view-btn').forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  const parent = e.target.parentElement;
Â  Â  Â  Â  Â  Â  parent.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  Â  Â  e.target.classList.add('active');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (e.target.dataset.view) {
Â  Â  Â  Â  Â  Â  Â  Â  currentView = e.target.dataset.view;
Â  Â  Â  Â  Â  Â  Â  Â  const pickers = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  diario: document.getElementById('diario-picker'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensal: document.getElementById('mensal-picker'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  intervalo: document.getElementById('intervalo-picker')
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  for(const key in pickers) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pickers[key].style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (pickers[currentView]) pickers[currentView].style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  carregarHistorico();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  });

Â  Â  // Adicionar listener para redimensionamento da tela
Â  Â  window.addEventListener('resize', function() {
Â  Â  Â  Â  if (document.getElementById('grafico-container').style.display !== 'none') {
Â  Â  Â  Â  Â  Â  setTimeout(redimensionarGraficos, 150);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // Tratar mudanÃ§a de orientaÃ§Ã£o em dispositivos mÃ³veis
Â  Â  window.addEventListener('orientationchange', function() {
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  if (document.getElementById('grafico-container').style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  redimensionarGraficos();
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(redimensionarGraficos, 500);
Â  Â  Â  Â  Â  Â  Â  Â  if (isMitAppInventor) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(redimensionarGraficos, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 300);
Â  Â  });

Â  Â  // ForÃ§ar redimensionamento inicial quando a pÃ¡gina carrega
Â  Â  window.addEventListener('load', function() {
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  if (document.getElementById('grafico-container').style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  redimensionarGraficos();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 1000);
Â  Â  });
};

// --- FUNÃ‡Ã•ES DE CONFIGURAÃ‡ÃƒO ---
function setStatus(elementId, message, color = 'green', timeout = 3000) {
Â  Â  const statusDiv = document.getElementById(elementId);
Â  Â  if (statusDiv) {
Â  Â  Â  Â  statusDiv.style.color = color;
Â  Â  Â  Â  statusDiv.innerText = message;
Â  Â  Â  Â  if (timeout > 0) {
Â  Â  Â  Â  Â  Â  setTimeout(() => { statusDiv.innerText = ''; }, timeout);
Â  Â  Â  Â  }
Â  Â  }
}

async function carregarConfiguracoes() {
Â  Â  try {
Â  Â  Â  Â  const r = await fetch(URL_CONFIG_NIVEL);
Â  Â  Â  Â  if (!r.ok) throw new Error(`Status: ${r.status}`);
Â  Â  Â  Â  const nivel = await r.json();
Â  Â  Â  Â  if (nivel !== null) {
Â  Â  Â  Â  Â  Â  document.getElementById('nivel-alerta-valor').value = nivel;
Â  Â  Â  Â  Â  Â  nivelAlertaConfigurado = parseInt(nivel);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.getElementById('nivel-alerta-valor').value = nivelAlertaConfigurado;
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erro ao carregar nÃ­vel de alerta:", e);
Â  Â  Â  Â  setStatus('status-alerta', 'Erro ao carregar nÃ­vel.', '#ef4444');
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  const r = await fetch(URL_CONFIG_TELEGRAM);
Â  Â  Â  Â  if (!r.ok) throw new Error(`Status: ${r.status}`);
Â  Â  Â  Â  const id = await r.json();
Â  Â  Â  Â  if (id !== null) {
Â  Â  Â  Â  Â  Â  document.getElementById('telegram-id-valor').value = id;
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erro ao carregar ID Telegram:", e);
Â  Â  Â  Â  setStatus('status-telegram', 'Erro ao carregar ID.', '#ef4444');
Â  Â  }

Â  Â  await carregarListaEmails();
}

async function salvarNivelAlerta() {
Â  Â  const nivel = document.getElementById('nivel-alerta-valor').value;
Â  Â  const statusDiv = document.getElementById('status-alerta');
Â  Â Â 
Â  Â  if (!nivel || nivel < 1 || nivel > 99) {
Â  Â  Â  Â  setStatus('status-alerta', 'Valor invÃ¡lido (1-99).', '#ef4444');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  setStatus('status-alerta', 'Salvando...', '#eab308', 0);
Â  Â  try {
Â  Â  Â  Â  const r = await fetch(URL_CONFIG_NIVEL, {
Â  Â  Â  Â  Â  Â  method: 'PUT',
Â  Â  Â  Â  Â  Â  body: JSON.stringify(parseInt(nivel))
Â  Â  Â  Â  });
Â  Â  Â  Â  if (!r.ok) throw new Error(`Status: ${r.status}`);
Â  Â  Â  Â  nivelAlertaConfigurado = parseInt(nivel);
Â  Â  Â  Â  setStatus('status-alerta', 'NÃ­vel de alerta salvo!');
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erro ao salvar nÃ­vel:", e);
Â  Â  Â  Â  setStatus('status-alerta', 'Erro ao salvar (Verifique Regras do Firebase).', '#ef4444');
Â  Â  }
}

async function salvarTelegramId() {
Â  Â  const id = document.getElementById('telegram-id-valor').value;
Â  Â  if (!id) {
Â  Â  Â  Â  setStatus('status-telegram', 'ID nÃ£o pode ser vazio.', '#ef4444');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  setStatus('status-telegram', 'Salvando...', '#eab308', 0);
Â  Â  try {
Â  Â  Â  Â  const r = await fetch(URL_CONFIG_TELEGRAM, {
Â  Â  Â  Â  Â  Â  method: 'PUT',
Â  Â  Â  Â  Â  Â  body: JSON.stringify(id)
Â  Â  Â  Â  });
Â  Â  Â  Â  if (!r.ok) throw new Error(`Status: ${r.status}`);
Â  Â  Â  Â  setStatus('status-telegram', 'ID do Telegram salvo!');
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erro ao salvar ID Telegram:", e);
Â  Â  Â  Â  setStatus('status-telegram', 'Erro ao salvar (Verifique Regras do Firebase).', '#ef4444');
Â  Â  }
}

async function carregarListaEmails() {
Â  Â  const listaUL = document.getElementById('lista-emails');
Â  Â  listaUL.innerHTML = '<li>Carregando...</li>';
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const r = await fetch(URL_CONFIG_EMAILS);
Â  Â  Â  Â  if (!r.ok) throw new Error(`Status: ${r.status}`);
Â  Â  Â  Â  const emails = await r.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  listaUL.innerHTML = '';
Â  Â  Â  Â  if (emails && Array.isArray(emails)) {
Â  Â  Â  Â  Â  Â  emails.forEach((email, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (email) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.className = 'email-item';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${email}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-email="${email}">Remover</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaUL.appendChild(li);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  if (listaUL.innerHTML === '') {
Â  Â  Â  Â  Â  Â  listaUL.innerHTML = '<li class="small" style="text-align:center;">Nenhum e-mail salvo.</li>';
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erro ao carregar e-mails:", e);
Â  Â  Â  Â  listaUL.innerHTML = '<li class="small" style="text-align:center; color:red;">Erro ao carregar e-mails (Verifique Regras do Firebase).</li>';
Â  Â  }
}

async function adicionarEmail() {
Â  Â  const input = document.getElementById('email-valor');
Â  Â  const email = input.value;
Â  Â Â 
Â  Â  if (!email || !email.includes('@')) {
Â  Â  Â  Â  setStatus('status-email', 'Por favor, insira um e-mail vÃ¡lido.', '#ef4444');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  setStatus('status-email', 'Adicionando...', '#eab308', 0);

Â  Â  let listaAtual = [];
Â  Â  try {
Â  Â  Â  Â  const r = await fetch(URL_CONFIG_EMAILS);
Â  Â  Â  Â  if (r.ok) {Â 
Â  Â  Â  Â  Â  Â  const emails = await r.json();
Â  Â  Â  Â  Â  Â  if (emails && Array.isArray(emails)) {
Â  Â  Â  Â  Â  Â  Â  Â  listaAtual = emails.filter(Boolean);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.warn("Erro ao buscar lista de emails (pode ser o primeiro email):", e);
Â  Â  }

Â  Â  if (listaAtual.includes(email)) {
Â  Â  Â  Â  setStatus('status-email', 'E-mail jÃ¡ estÃ¡ na lista.', '#eab308');
Â  Â  Â  Â  input.value = '';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  listaAtual.push(email);
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const r = await fetch(URL_CONFIG_EMAILS, {
Â  Â  Â  Â  Â  Â  method: 'PUT',
Â  Â  Â  Â  Â  Â  body: JSON.stringify(listaAtual)
Â  Â  Â  Â  });
Â  Â  Â  Â  if (!r.ok) throw new Error(`Status: ${r.status}`);
Â  Â  Â  Â  setStatus('status-email', 'E-mail adicionado!');
Â  Â  Â  Â  input.value = '';
Â  Â  Â  Â  await carregarListaEmails();
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erro ao adicionar e-mail:", e);
Â  Â  Â  Â  setStatus('status-email', 'Erro ao salvar (Verifique Regras do Firebase).', '#ef4444');
Â  Â  }
}

async function removerEmail(emailParaRemover) {
Â  Â  setStatus('status-email', 'Removendo...', '#eab308', 0);

Â  Â  let listaAtual = [];
Â  Â  try {
Â  Â  Â  Â  const r = await fetch(URL_CONFIG_EMAILS);
Â  Â  Â  Â  if (!r.ok) throw new Error(`Status: ${r.status}`);
Â  Â  Â  Â  const emails = await r.json();
Â  Â  Â  Â  if (emails && Array.isArray(emails)) {
Â  Â  Â  Â  Â  Â  listaAtual = emails.filter(Boolean);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  setStatus('status-email', 'Lista de e-mails nÃ£o encontrada.', '#ef4444');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  Â setStatus('status-email', 'Erro ao carregar lista para remoÃ§Ã£o.', '#ef4444');
Â  Â  Â  Â  Â return;
Â  Â  }

Â  Â  const novaLista = listaAtual.filter(email => email !== emailParaRemover);

Â  Â  try {
Â  Â  Â  Â  const r = await fetch(URL_CONFIG_EMAILS, {
Â  Â  Â  Â  Â  Â  method: 'PUT',
Â  Â  Â  Â  Â  Â  body: JSON.stringify(novaLista)
Â  Â  Â  Â  });
Â  Â  Â  Â  if (!r.ok) throw new Error(`Status: ${r.status}`);
Â  Â  Â  Â  setStatus('status-email', 'E-mail removido!');
Â  Â  Â  Â  await carregarListaEmails();
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erro ao remover e-mail:", e);
Â  Â  Â  Â  setStatus('status-email', 'Erro ao salvar (Verifique Regras do Firebase).', '#ef4444');
Â  Â  }
}

</script>
</body>
</html>
