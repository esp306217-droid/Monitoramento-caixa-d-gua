<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Monitoramento PP7 - Histórico por Data</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto;
  background:linear-gradient(180deg,#071024 0%,#07142a 60%);
  color:#e6eef8; display:flex; flex-direction:column; align-items:center;
  gap:20px; padding:20px; min-height:100vh;
}
header{
  width:100%; max-width:1200px; display:flex; flex-wrap:wrap;
  justify-content:space-between; align-items:center; gap:12px;
}
header h1{margin:0; font-size:1.2rem;}
.controls{display:flex; gap:10px; align-items:center;}
input[type="date"]{
  background:#101b2e; color:#e6eef8; border:1px solid #1e2b40;
  border-radius:6px; padding:6px 10px;
}
button{
  background:var(--accent); border:none; color:#011017; font-weight:600;
  padding:8px 12px; border-radius:8px; cursor:pointer;
}
button:hover{filter:brightness(.95)}
.board{
  width:100%; max-width:1200px;
  background:rgba(255,255,255,0.02); border-radius:12px;
  padding:18px; box-shadow:0 8px 30px rgba(2,6,23,0.6);
  border:1px solid rgba(255,255,255,0.03);
}
.charts{display:grid; grid-template-columns:1fr; gap:22px;}
.chart-card{
  background:rgba(255,255,255,0.03); padding:14px; border-radius:10px;
  border:1px solid rgba(255,255,255,0.05);
}
canvas{width:100%!important; height:340px!important; display:block;}
.small{font-size:.9rem; color:var(--muted); margin-top:4px;}
@media(min-width:900px){.charts{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>
<header>
  <h1>Monitoramento Caixa d’Água PP7 - Histórico</h1>
  <div class="controls">
    <input type="date" id="dataEscolhida">
    <button id="btnAtualizar">Carregar</button>
  </div>
</header>

<div class="board">
  <div class="charts">
    <div class="chart-card">
      <strong>Gráfico de Linha — Nível (%)</strong>
      <canvas id="chartLinha"></canvas>
      <div class="small">Exibe o histórico de nível ao longo do dia selecionado.</div>
    </div>
    <div class="chart-card">
      <strong>Gráfico em Blocos — Subida / Queda</strong>
      <canvas id="chartBlocos"></canvas>
      <div class="small">Barras verdes indicam aumento, vermelhas indicam queda.</div>
    </div>
  </div>
</div>

<script>
const MAX_PONTOS = 50;
let chartLinha, chartBlocos;
let historicoNiveis = [], historicoLabels = [];

function criarGraficos(){
  const ctxL = document.getElementById('chartLinha').getContext('2d');
  const grad = ctxL.createLinearGradient(0,0,0,300);
  grad.addColorStop(0,'rgba(6,182,212,0.28)');
  grad.addColorStop(1,'rgba(6,182,212,0.03)');
  chartLinha = new Chart(ctxL,{
    type:'line',
    data:{labels:[],datasets:[{
      label:'Nível (%)',data:[],fill:true,backgroundColor:grad,
      borderColor:'rgba(6,182,212,0.95)',tension:0.25,
      pointRadius:3,borderWidth:2
    }]},
    options:{animation:false,plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:'#9fb6c8'}},y:{ticks:{color:'#9fb6c8'},min:0,max:100}}}
  });

  const ctxB = document.getElementById('chartBlocos').getContext('2d');
  chartBlocos = new Chart(ctxB,{
    type:'bar',
    data:{labels:[],datasets:[{data:[],backgroundColor:[],borderRadius:6}]},
    options:{animation:false,plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:'#9fb6c8'}},y:{ticks:{color:'#9fb6c8'},min:0,max:100}}}
  });
}

function atualizarGraficos(){
  chartLinha.data.labels = historicoLabels;
  chartLinha.data.datasets[0].data = historicoNiveis;
  chartLinha.update();

  const cores = historicoNiveis.map((v,i)=>
    i===0 ? 'rgba(99,102,241,0.85)' :
    v>=historicoNiveis[i-1] ? 'rgba(34,197,94,0.85)' : 'rgba(239,68,68,0.85)');
  chartBlocos.data.labels = historicoLabels;
  chartBlocos.data.datasets[0].data = historicoNiveis;
  chartBlocos.data.datasets[0].backgroundColor = cores;
  chartBlocos.update();
}

async function carregarHistorico(data){
  try{
    const url = `https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7_historico/${data}.json`;
    const r = await fetch(url);
    const dados = await r.json();
    if(!dados){alert("Nenhum dado encontrado para esta data.");return;}

    const labels = Object.keys(dados).sort();
    const niveis = labels.map(h=>dados[h].nivel_pct ?? dados[h].nivel ?? 0);

    historicoLabels = labels;
    historicoNiveis = niveis;
    atualizarGraficos();
  }catch(e){console.error(e);}
}

async function atualizarAtual(){
  try{
    const r = await fetch('https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com/PP7.json');
    const j = await r.json();
    const nivel = j.nivel_pct ?? j.nivel ?? 0;

    if(historicoNiveis.length>=MAX_PONTOS){
      historicoNiveis.shift(); historicoLabels.shift();
    }
    historicoNiveis.push(Number(nivel));
    historicoLabels.push(new Date().toLocaleTimeString());
    atualizarGraficos();
  }catch(e){console.error(e);}
}

window.onload = ()=>{
  criarGraficos();
  const hoje = new Date().toISOString().split('T')[0];
  document.getElementById('dataEscolhida').value = hoje;
  carregarHistorico(hoje);

  document.getElementById('btnAtualizar').onclick = ()=>{
    const d = document.getElementById('dataEscolhida').value;
    carregarHistorico(d);
  };

  setInterval(()=>{
    const dSel = document.getElementById('dataEscolhida').value;
    const hoje = new Date().toISOString().split('T')[0];
    if(dSel === hoje) atualizarAtual(); // só atualiza em tempo real no dia de hoje
  },2000);
};
</script>
</body>
</html>
