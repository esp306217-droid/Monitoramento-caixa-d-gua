<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<title>Monitoramento Via Cristais - Central</title>

<!-- Fontes e Ícones -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* --- ESTILO GERAL DO DASHBOARD --- */
:root {
    --bg-body: #f0f2f5;
    --text-main: #1e293b;
    --text-sec: #64748b;
    --card-bg: rgba(255, 255, 255, 0.95);
    --card-border: rgba(226, 232, 240, 0.8);
    --accent: #06b6d4; 
    --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    
    --level-ok: #10b981;
    --level-warn: #f59e0b;
    --level-danger: #ef4444;
    --level-offline: #94a3b8;
}

[data-theme="dark"] {
    --bg-body: #0f172a;
    --text-main: #f1f5f9;
    --text-sec: #94a3b8;
    --card-bg: rgba(30, 41, 59, 0.85);
    --card-border: rgba(255, 255, 255, 0.1);
    --accent: #22d3ee;
    --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-body);
    background-image: radial-gradient(at 0% 0%, hsla(192,70%,80%,0.05) 0, transparent 50%), radial-gradient(at 100% 100%, hsla(200,80%,80%,0.05) 0, transparent 50%);
    color: var(--text-main);
    margin: 0; padding: 20px;
    transition: background-color 0.3s ease;
}

/* Header */
.header { text-align: center; margin-bottom: 40px; position: relative; }
.logo { width: 160px; mix-blend-mode: multiply; margin-bottom: 10px; }
[data-theme="dark"] .logo { filter: invert(1) hue-rotate(180deg) brightness(2) contrast(1.2); mix-blend-mode: screen; }
h1 { font-size: 1.2rem; color: var(--text-sec); margin: 0; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

/* Botão Tema Dashboard */
.theme-toggle {
    position: absolute; top: 0; right: 0;
    background: var(--card-bg); border: 1px solid var(--card-border);
    color: var(--text-main); width: 40px; height: 40px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
    cursor: pointer; box-shadow: var(--shadow-card);
}

/* Grid */
.section-title {
    font-size: 1.1rem; font-weight: 700; color: var(--text-main);
    margin: 30px 0 15px 5px; border-left: 5px solid var(--accent); padding-left: 10px;
}
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    max-width: 1200px; margin: 0 auto;
}

/* Card */
.card {
    background: var(--card-bg); border: 1px solid var(--card-border);
    border-radius: 16px; padding: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: var(--shadow-card); cursor: pointer;
    text-decoration: none; position: relative; overflow: hidden;
    transition: transform 0.2s; min-height: 150px;
}
.card:active { transform: scale(0.96); }
.card.inactive { opacity: 0.6; filter: grayscale(1); cursor: default; pointer-events: none; }

/* Fundo Animado de Água */
.card-water-bg {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
    background: linear-gradient(to top, rgba(6,182,212,0.2), rgba(6,182,212,0.5));
    transition: height 0.5s ease-out; z-index: 0;
}

/* Conteúdo do Card */
.card-content {
    position: relative; z-index: 1; padding: 20px 15px;
    width: 100%; display: flex; flex-direction: column; align-items: center;
}

/* Barra Lateral Status */
.card::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
    background: var(--level-offline); transition: background 0.3s; z-index: 2;
}
.card[data-status="ok"]::before { background: var(--level-ok); }
.card[data-status="warn"]::before { background: var(--level-warn); }
.card[data-status="danger"]::before { background: var(--level-danger); }
.card[data-status="simulated"]::before { background: #d97706; } /* Cor Laranja Escuro para Estimado */

/* Ícone e Texto */
.card-icon { font-size: 2rem; color: var(--text-sec); margin-bottom: 10px; }
.card-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 5px; }
.card-level { font-size: 1.5rem; font-weight: 800; color: var(--text-sec); }
.card-status { font-size: 0.75rem; color: var(--text-sec); margin-top: 5px; }

/* Indicador de Leitura Estimada no Card */
.simulated-badge {
    position: absolute; top: 10px; left: 10px; 
    background: #d97706; color: white; border-radius: 50%; width: 22px; height: 22px;
    font-size: 14px; display: none; align-items: center; justify-content: center; font-weight: bold; z-index: 2;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.card[data-status="simulated"] .simulated-badge { display: flex; }

/* Animação Online */
.live-dot {
    position: absolute; top: 10px; right: 10px; width: 10px; height: 10px;
    background: var(--level-ok); border-radius: 50%; box-shadow: 0 0 5px var(--level-ok);
    display: none; animation: pulse 2s infinite; z-index: 2;
}
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

/* --- IFRAME FULLSCREEN --- */
#app-overlay {
    display: none;
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 9999;
}
#app-overlay.active { display: block; }
#app-frame { width: 100%; height: 100%; border: none; }

/* --- ESTILO ADICIONADO: POPUP DE MANUTENÇÃO --- */
#maintenance-popup {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center; z-index: 30000;
}
.m-box {
    background: var(--card-bg); border: 4px solid #d4af37; border-radius: 24px;
    padding: 40px 30px; max-width: 500px; width: 90%; text-align: center;
    box-shadow: 0 0 30px rgba(212, 175, 55, 0.4); animation: m-fade-in 0.5s ease;
}
@keyframes m-fade-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.m-icon-anim {
    font-size: 4rem; color: #d4af37; margin-bottom: 20px;
    display: inline-block; animation: m-gear 3s infinite linear;
}
@keyframes m-gear { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.m-title { font-weight: 700; font-size: 1.5rem; margin-bottom: 15px; color: var(--text-main); }
.m-desc { color: var(--text-sec); line-height: 1.6; margin-bottom: 20px; font-size: 1.05rem; }
.m-warning { color: var(--text-main); font-size: 0.95rem; border-top: 1px solid rgba(212, 175, 55, 0.3); padding-top: 15px; }
.m-btn {
    margin-top: 25px; background: #d4af37; color: #fff; border: none;
    padding: 12px 40px; border-radius: 50px; font-weight: 700; cursor: pointer;
    transition: all 0.3s; font-family: 'Poppins', sans-serif;
}
.m-btn:hover { background: #b8952e; transform: translateY(-2px); }
</style>
</head>
<body>

<!-- POP-UP DE MANUTENÇÃO -->
<div id="maintenance-popup">
    <div class="m-box">
        <div class="m-icon-anim"><i class="fas fa-cog"></i></div>
        <div class="m-title">Aplicativo em manutenção</div>
        <p class="m-desc">Estamos implantando as demais caixas d'água para melhorar nosso monitoramento.</p>
        <div class="m-warning">
            <strong>FAVOR DESCONSIDERAR POSSÍVEIS ALARMES E ENVIOS DE EMAILS COM 0%.</strong>
        </div>
        <button class="m-btn" onclick="document.getElementById('maintenance-popup').style.display='none'">Entendido</button>
    </div>
</div>

<!-- DASHBOARD VISÍVEL INICIALMENTE -->
<div id="dashboard-container">
    <div class="header">
        <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
        <img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
        <h1>Central de Monitoramento</h1>
    </div>

    <div class="section-title">Praças de Pedágio</div>
    <div class="grid" id="grid-pp"></div>

    <div class="section-title">Bases SAU</div>
    <div class="grid" id="grid-sau"></div>
</div>

<!-- OVERLAY PARA EXIBIR OS APPS ORIGINAIS -->
<div id="app-overlay">
    <iframe id="app-frame" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
</div>

<!-- ========================================================================= -->
<!-- TEMPLATE UNIVERSAL ÚNICO (Para TODAS as Caixas)                            -->
<!-- ========================================================================= -->
<textarea id="app-template" style="display:none;">
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<title>__APP_TITLE__</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js">
/* ===============================
   AJUSTES GLOBAIS – SINCRONIZAÇÃO REAL x EMERGÊNCIA
   Aplicado a TODOS os cards
   =============================== */

const FIREBASE_BASE = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";

async function salvarEstadoAtual(cardId, nivel, tipo) {
    const payload = {
        nivel_pct: nivel,
        tipo: tipo,
        timestamp: Date.now()
    };

    try {
        await fetch(`${FIREBASE_BASE}/${cardId}.json`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            },
            body: JSON.stringify(payload)
        });
    } catch(e) {
        console.warn("Falha ao salvar estado:", e);
    }
}

const isWebView = /wv|Android/i.test(navigator.userAgent);

async function atualizarImediato(cardId) {
    await loopDeAtualizacao(cardId);
}

function iniciarLoop(cardId) {
    atualizarImediato(cardId);
    setInterval(() => loopDeAtualizacao(cardId), isWebView ? 1200 : 2500);
}

</script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js">
/* ===============================
   AJUSTES GLOBAIS – SINCRONIZAÇÃO REAL x EMERGÊNCIA
   Aplicado a TODOS os cards
   =============================== */

const FIREBASE_BASE = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";

async function salvarEstadoAtual(cardId, nivel, tipo) {
    const payload = {
        nivel_pct: nivel,
        tipo: tipo,
        timestamp: Date.now()
    };

    try {
        await fetch(`${FIREBASE_BASE}/${cardId}.json`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            },
            body: JSON.stringify(payload)
        });
    } catch(e) {
        console.warn("Falha ao salvar estado:", e);
    }
}

const isWebView = /wv|Android/i.test(navigator.userAgent);

async function atualizarImediato(cardId) {
    await loopDeAtualizacao(cardId);
}

function iniciarLoop(cardId) {
    atualizarImediato(cardId);
    setInterval(() => loopDeAtualizacao(cardId), isWebView ? 1200 : 2500);
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js">
/* ===============================
   AJUSTES GLOBAIS – SINCRONIZAÇÃO REAL x EMERGÊNCIA
   Aplicado a TODOS os cards
   =============================== */

const FIREBASE_BASE = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";

async function salvarEstadoAtual(cardId, nivel, tipo) {
    const payload = {
        nivel_pct: nivel,
        tipo: tipo,
        timestamp: Date.now()
    };

    try {
        await fetch(`${FIREBASE_BASE}/${cardId}.json`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            },
            body: JSON.stringify(payload)
        });
    } catch(e) {
        console.warn("Falha ao salvar estado:", e);
    }
}

const isWebView = /wv|Android/i.test(navigator.userAgent);

async function atualizarImediato(cardId) {
    await loopDeAtualizacao(cardId);
}

function iniciarLoop(cardId) {
    atualizarImediato(cardId);
    setInterval(() => loopDeAtualizacao(cardId), isWebView ? 1200 : 2500);
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js">
/* ===============================
   AJUSTES GLOBAIS – SINCRONIZAÇÃO REAL x EMERGÊNCIA
   Aplicado a TODOS os cards
   =============================== */

const FIREBASE_BASE = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";

async function salvarEstadoAtual(cardId, nivel, tipo) {
    const payload = {
        nivel_pct: nivel,
        tipo: tipo,
        timestamp: Date.now()
    };

    try {
        await fetch(`${FIREBASE_BASE}/${cardId}.json`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            },
            body: JSON.stringify(payload)
        });
    } catch(e) {
        console.warn("Falha ao salvar estado:", e);
    }
}

const isWebView = /wv|Android/i.test(navigator.userAgent);

async function atualizarImediato(cardId) {
    await loopDeAtualizacao(cardId);
}

function iniciarLoop(cardId) {
    atualizarImediato(cardId);
    setInterval(() => loopDeAtualizacao(cardId), isWebView ? 1200 : 2500);
}

</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js">
/* ===============================
   AJUSTES GLOBAIS – SINCRONIZAÇÃO REAL x EMERGÊNCIA
   Aplicado a TODOS os cards
   =============================== */

const FIREBASE_BASE = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";

async function salvarEstadoAtual(cardId, nivel, tipo) {
    const payload = {
        nivel_pct: nivel,
        tipo: tipo,
        timestamp: Date.now()
    };

    try {
        await fetch(`${FIREBASE_BASE}/${cardId}.json`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            },
            body: JSON.stringify(payload)
        });
    } catch(e) {
        console.warn("Falha ao salvar estado:", e);
    }
}

const isWebView = /wv|Android/i.test(navigator.userAgent);

async function atualizarImediato(cardId) {
    await loopDeAtualizacao(cardId);
}

function iniciarLoop(cardId) {
    atualizarImediato(cardId);
    setInterval(() => loopDeAtualizacao(cardId), isWebView ? 1200 : 2500);
}

</script>
<style>
:root { --bg-body: #f0f2f5; --text-main: #1e293b; --text-sec: #64748b; --card-bg: rgba(255, 255, 255, 0.95); --card-border: rgba(226, 232, 240, 0.8); --header-bg: rgba(255, 255, 255, 0.98); --accent: #06b6d4; --accent-hover: #0891b2; --input-bg: #f8fafc; --input-border: #cbd5e1; --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); --level-ok: #10b981; --level-warn: #f59e0b; --level-danger: #ef4444; }
[data-theme="dark"] { --bg-body: #0f172a; --text-main: #f1f5f9; --text-sec: #94a3b8; --card-bg: rgba(30, 41, 59, 0.85); --card-border: rgba(255, 255, 255, 0.1); --header-bg: rgba(15, 23, 42, 0.95); --accent: #22d3ee; --accent-hover: #67e8f9; --input-bg: #1e293b; --input-border: #334155; --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; margin: 0; padding: 0; }
body { font-family: 'Poppins', sans-serif; text-align: center; background: var(--bg-body); background-image: radial-gradient(at 0% 0%, hsla(192,70%,80%,0.05) 0, transparent 50%), radial-gradient(at 100% 100%, hsla(200,80%,80%,0.05) 0, transparent 50%); color: var(--text-main); overflow-x: hidden; padding-bottom: 0; transition: background-color 0.3s ease, color 0.3s ease; }
::-webkit-scrollbar { display: none; }
* { -ms-overflow-style: none; scrollbar-width: none; }
.glass-panel { background: var(--card-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid var(--card-border); box-shadow: var(--shadow-card); border-radius: 16px; }
.nav-button-icon-only { width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--card-border); background: var(--card-bg); color: var(--text-sec); cursor: pointer; transition: all 0.2s; box-shadow: none; }
.nav-button-icon-only:active { background: var(--accent); color: white; transform: translateY(2px); }
.main-header { width: 100%; padding: 10px 5px; background-color: var(--header-bg); backdrop-filter: blur(10px); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); display: flex; justify-content: center; align-items: center; position: sticky; top: 0; z-index: 1000; transition: background-color 0.3s ease; flex-wrap: wrap; gap: 8px; padding-left: 0; margin-top: 0; } 
.nav-group { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 0; justify-content: center; align-items: center; }
.status-indicator-box { position: absolute; top: 10px; right: 10px; }
.live-indicator { width: 10px; height: 10px; border-radius: 50%; background-color: #64748b; transition: background-color 0.3s; display: inline-block; }
.live-indicator.online { background-color: var(--level-ok); box-shadow: 0 0 8px var(--level-ok); animation: pulse-green 2s infinite; }
.live-indicator.offline { background-color: var(--level-danger); }
@keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { transform: scale(1.0); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
#caixa-view, #grafico-container, #config-view, #abastecimento-view, #consumo-view { width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 0.5rem; overflow-y: auto; min-height: calc(100vh - 70px); }
.logo { width: 140px; margin-bottom: 5px; opacity: 0.95; display: block; margin-left: auto; margin-right: auto; mix-blend-mode: multiply; transition: all 0.3s ease; }
[data-theme="dark"] .logo { filter: invert(1) hue-rotate(180deg) brightness(2) contrast(1.2); mix-blend-mode: screen; opacity: 1; margin-bottom: 10px; }
#emergency-badge { position: fixed; top: 80px; right: 20px; width: 50px; height: 50px; background-color: var(--level-danger); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.6); z-index: 1500; animation: pulse-red 1.5s infinite; cursor: help; }
@keyframes pulse-red { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
#status-display { width: 100%; max-width: 360px; padding: 15px; margin: 0 auto 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; position: relative; z-index: 10; margin-top: 10px; }
.status-item { display: flex; flex-direction: column; text-align: center; }
.status-item.item-time { grid-column: 1 / 3; border-top: 1px solid rgba(150,150,150,0.2); padding-top: 5px; margin-top: 2px; }
.status-label { font-size: 0.7rem; font-weight: 600; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1px; }
.status-value { font-size: 1.8rem; font-weight: 700; line-height: 1.1; color: var(--accent); transition: color 0.3s ease; }
#status-litros { font-size: 1.5rem; display: flex; justify-content: center; align-items: baseline; gap: 5px; }
#status-litros small { font-size: 0.85rem; font-weight: 400; color: var(--text-sec); }
#status-time { font-size: 1rem; color: var(--text-main); }
.reservatorio-wrapper { width: 280px; height: 460px; position: relative; margin: -40px auto 0 auto; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1)); transform-origin: top center; transform: scale(0.9); }
.modern-button { background: var(--accent); border: none; color: #fff; font-weight: 600; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.95rem; box-shadow: 0 4px 10px rgba(6,182,212,0.2); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
.modern-button:hover { background: var(--accent-hover); transform: translateY(-2px); }
.modern-button:active { transform: translateY(0); }
.modern-button.btn-success { background-color: var(--level-ok) !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); pointer-events: none; }
input, select { background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-main); padding: 12px; border-radius: 8px; font-family: 'Poppins', sans-serif; outline: none; width: 100%; text-align: center; }
input:focus, select:focus { border-color: var(--accent); }
header h1 { margin: 0; font-size: 1.5rem; color: var(--text-main); font-weight: 700; display: flex; align-items: center; gap: 10px;}
.nav-button { padding: 10px 15px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; font-family: 'Poppins', sans-serif; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; border-radius: 10px; display: flex; align-items: center; gap: 6px; box-shadow: none; }
.nav-button.active { background: var(--accent); color: #fff; box-shadow: 0 4px 12px rgba(6,182,212,0.2); }
.nav-button:hover:not(.active) { background: rgba(150,150,150,0.1); color: var(--text-main); }
.header-right { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; justify-content: center; width: 100%; }
.view-selector { display: flex; gap: 5px; background: var(--input-bg); padding: 4px; border-radius: 10px; }
.view-btn { padding: 8px 16px; border: none; border-radius: 8px; background: transparent; color: var(--text-sec); font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; display: flex; align-items: center; justify-content: center; }
.view-btn.active { background: var(--card-bg); color: var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.board { width: 100%; padding: 0; background: transparent; box-shadow: none; border: none; }
.charts { display: grid; grid-template-columns: 1fr; gap: 25px; }
.chart-card { padding: 20px; }
.chart-card strong { color: var(--text-main); display: block; margin-bottom: 15px; }
canvas { width: 100%!important; height: 320px!important; }
ul { list-style: none; padding: 0; }
li { background: var(--input-bg); padding: 12px 15px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--input-border); color: var(--text-main); }
.delete-abastecimento-btn { background: #fee2e2; color: #ef4444; border: none; width: 32px; height: 32px; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.delete-abastecimento-btn:hover { background: #ef4444; color: white; }
#alert-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.modal-content { background: var(--card-bg); padding: 0; border-radius: 20px; width: 90%; max-width: 400px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid var(--card-border); }
.modal-header { background: var(--level-danger); color: white; padding: 20px; font-weight: 700; font-size: 1.2rem; }
.modal-body { padding: 25px; color: var(--text-main); font-size: 1rem; }
.modal-footer { padding: 15px 20px; background: rgba(0,0,0,0.05); text-align: right; }
.config-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; width: 100%; max-width: 900px; padding: 0 5px; }
.config-card, #abastecimento-form { text-align: center; display: flex; flex-direction: column; align-items: center; padding: 15px; } 
.config-card h2, #abastecimento-form h2 { width: 100%; font-size: 1rem; margin: 0 0 10px 0; }
.config-card .form-group, #abastecimento-form .form-group { display: flex; flex-direction: column; gap: 10px; align-items: center; justify-content: center; width: 100%; }
.config-card .form-group input, .config-card .form-group select, #abastecimento-form .form-group input { width: 100%; min-width: 0; text-align: center; padding: 8px; font-size: 0.95rem; }
.config-card .form-group button, #abastecimento-form .form-group button { width: 100%; padding: 8px; min-width: 0; margin-top: 0; font-size: 0.9rem; }
.config-card:last-child { grid-column: 1 / -1; }
@media (max-width: 800px) { .main-header { overflow-x: hidden; justify-content: center; padding-left: 0; } .nav-group { width: 100%; justify-content: center; overflow-x: auto; } .nav-button span { display: none; } .nav-button i { font-size: 1.3rem; } .nav-button { padding: 10px 15px; } .reservatorio-wrapper { transform: scale(0.8); margin: -50px auto 0 auto; transform-origin: top center; } canvas { height: 260px !important; } }
@media (max-height: 700px) { .reservatorio-wrapper { transform: scale(0.7); margin-top: -60px; } }
#reservatorio-svg .estrutura-solida { fill: url(#grad-metal); stroke: #475569; stroke-width: 2.5; opacity: 0.8; }
#reservatorio-svg .base-concreto { fill: #cbd5e1; stroke: #475569; stroke-width: 2; opacity: 0.9; }
#reservatorio-svg .suportes-base { fill: #94a3b8; stroke: #475569; stroke-width: 2; opacity: 0.9; }
#reservatorio-svg .faixa-metalica { stroke: #475569; stroke-width: 2; opacity: 0.4; fill: none; }
#reservatorio-svg .taca-solida { fill: url(#grad-metal); stroke: #1e293b; stroke-width: 2.5; opacity: 0.3; }
#reservatorio-svg .guarda-corpo { fill: none; stroke: #1e293b; stroke-width: 2.5; opacity: 0.5; }
@keyframes pisca { 0% { opacity: 1; filter: drop-shadow(0 0 8px currentColor); } 50% { opacity: 0.4; filter: drop-shadow(0 0 2px currentColor); } 100% { opacity: 1; filter: drop-shadow(0 0 8px currentColor); } }
.led-base { stroke: #222; stroke-width: 1; transition: all 0.3s ease; fill: #333; }
.led-base.aceso.vermelho { fill: #ff0000; color: #ff0000; animation: pisca 0.8s infinite; }
.led-base.aceso.amarelo { fill: #ffdd00; color: #ffdd00; animation: pisca 0.8s infinite; }
.led-base.aceso.verde { fill: #00ff00; color: #00ff00; animation: pisca 0.8s infinite; }
.agua-wrapper { width: 100%; height: 100%; position: relative; overflow: hidden; }
.agua { position: absolute; bottom: 0; width: 100%; height: 0%; background: linear-gradient(to top, #06b6d4, #3b82f6); transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1); overflow: visible; color: white; font-weight: 800; text-align: center; font-size: 1.3rem; display: flex; align-items: center; justify-content: center; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.agua::before, .agua::after { content: ""; position: absolute; width: 200%; height: 20px; top: -15px; left: 0; background-repeat: repeat-x; border-radius: 45%; background: rgba(255,255,255,0.3); }
.agua::before { transform: translateX(-50%); animation: onda1 4s linear infinite; }
.agua::after { top: -12px; transform: translateX(-50%); background: rgba(255,255,255,0.15); animation: onda2 6s linear infinite; }
@keyframes onda1 { 0% { transform: translateX(0) translateY(0) scaleY(1); } 50% { transform: translateX(-25%) translateY(2px) scaleY(0.9); } 100% { transform: translateX(-50%) translateY(0) scaleY(1); } }
@keyframes onda2 { 0% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-25%) translateY(2px); } 100% { transform: translateX(0) translateY(0); } }
</style>
</head>
<body>
<div id="emergency-badge" title="Sem Sinal">!</div>

<div class="main-header glass-panel" style="border-radius: 0 0 20px 20px; border-top: none;">
<div class="nav-group">
<button class="nav-button-icon-only" onclick="window.parent.fecharApp()" title="Voltar"><i class="fas fa-arrow-left"></i></button>
<button class="nav-button-icon-only" onclick="window.toggleTheme()" title="Alternar Tema"><i class="fas fa-moon"></i></button>
<button class="nav-button-icon-only" onclick="window.location.reload(true)" title="Atualizar"><i class="fas fa-sync-alt"></i></button>
<button id="btn-view-caixa" class="nav-button active"><i class="fas fa-water"></i> <span>Caixa D'água</span></button>
<button id="btn-view-grafico" class="nav-button"><i class="fas fa-chart-line"></i> <span>Histórico</span></button>
<button id="btn-view-abastecimento" class="nav-button"><i class="fas fa-truck-droplet"></i> <span>Abastecimento</span></button>
<button id="btn-view-consumo" class="nav-button"><i class="fas fa-chart-bar"></i> <span>Consumo</span></button>
<button id="btn-view-config" class="nav-button"><i class="fas fa-cog"></i> <span>Config</span></button>
</div>
</div>

<div id="caixa-view">
<img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
<h2 style="font-size: 1rem; color: var(--text-sec); margin: 5px 0 10px 0; font-weight: 600; text-align: center;">__APP_TITLE__</h2>

<div id="status-display" class="glass-panel">
<div class="status-indicator-box"><div id="live-indicator" class="live-indicator offline" title="Status Conexão"></div></div>
<div class="status-item item-level">
<span class="status-label">Nível Atual</span>
<div style="display:flex; justify-content:center; align-items:center;">
<span class="status-value" id="status-level">--%</span>
<span id="simulated-indicator" style="display:none; background:#f59e0b; color:white; border-radius:50%; width:20px; height:20px; font-size:12px; align-items:center; justify-content:center; margin-left:8px; vertical-align:middle; cursor:help; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.2);" title="Leitura Estimada (Sem Sinal)">?</span>
</div>
</div>
<div class="status-item item-litros">
<span class="status-label">Volume</span>
<span class="status-value" id="status-litros">---- <small>L</small></span>
</div>
<div class="status-item item-time">
<span class="status-label">Hora</span>
<span class="status-value" id="status-time" style="font-size: 1.2rem;">--:--</span>
</div>
</div>

<div class="reservatorio-wrapper" id="caixa-container">
<svg id="reservatorio-svg" viewBox="0 0 400 1000" preserveAspectRatio="xMidYMin meet">
<defs>
<linearGradient id="grad-metal" x1="0%" y1="0%" x2="100%" y2="0%">
<stop offset="0%" stop-color="#e2e8f0"/><stop offset="50%" stop-color="#f1f5f9"/><stop offset="100%" stop-color="#cbd5e1"/>
</linearGradient>
<clipPath id="mascara-agua"><path d="M 105 220 L 295 220 L 295 440 L 265 500 L 135 500 L 105 440 Z"/></clipPath>
</defs>
<foreignObject x="105" y="220" width="190" height="280" clip-path="url(#mascara-agua)">
<div xmlns="http://www.w3.org/1999/xhtml" class="agua-wrapper"><div class="agua" id="agua">0%</div></div>
</foreignObject>
<g id="estrutura-reservatorio">
<g id="base"><path class="base-concreto" d="M 80 950 L 320 950 L 310 930 L 90 930 Z"/><path class="suportes-base" d="M 130 930 L 120 940 L 140 940 Z M 170 930 L 160 940 L 180 940 Z M 210 930 L 200 940 L 220 940 Z M 250 930 L 240 940 L 260 940 Z M 290 930 L 280 940 L 300 940 Z"/></g>
<g id="coluna"><path class="estrutura-solida" d="M 135 930 L 135 500 L 265 500 L 265 930 Z"/><path class="faixa-metalica" d="M 135 620 L 265 620 M 135 770 L 265 770"/></g>
<g id="taca-solida"><path class="taca-solida" d="M 100 440 L 100 220 L 300 220 L 300 440 L 265 500 L 135 500 Z"/><path class="guarda-corpo" d="M 100 220 A 100 25 0 0 1 300 220"/></g>
<g id="leds-base"><circle id="led-verde" class="led-base verde" cx="160" cy="975" r="12" /><circle id="led-amarelo" class="led-base amarelo" cx="200" cy="975" r="12" /><circle id="led-vermelho" class="led-base vermelho" cx="240" cy="975" r="12" /></g>
</g>
</svg>
</div>
</div>

<div id="grafico-container" style="display:none;">
<img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
<header><h1><i class="fas fa-chart-line" style="color: var(--accent);"></i> Histórico de Nível</h1></header>
<div class="controls" style="display:flex; align-items: center; justify-content:center; gap:10px; margin-bottom: 15px;">
<div id="diario-picker"><input type="date" id="dataEscolhida"></div>
<div id="mensal-picker" style="display:none;"><input type="month" id="mesEscolhido"></div>
<div id="intervalo-picker" style="display:none;"><input type="date" id="dataInicio"><span>até</span><input type="date" id="dataFim"></div>
<button id="btnAtualizar" class="modern-button" style="padding:10px 15px;"><i class="fas fa-sync-alt"></i></button>
</div>
<div class="board"><div class="charts">
<div class="chart-card glass-panel"><strong>Variação de Nível (%)</strong><canvas id="chartLinha"></canvas></div>
<div class="chart-card glass-panel"><strong>Nível Médio por Hora (%)</strong><canvas id="chartBlocos"></canvas></div>
</div></div>
</div>

<div id="abastecimento-view" style="display:none;">
<img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
<header><h1><i class="fas fa-truck-droplet" style="color: var(--accent);"></i> Abastecimento</h1></header>
<div class="board" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
<div id="abastecimento-form" class="config-card glass-panel" style="margin: 0; width: 100%; max-width: 500px;">
<h2>Registrar Entrada</h2>
<div class="form-group">
<input type="number" id="litros-abastecidos" placeholder="Qtd. Litros (ex: 5000)" min="1">
<button id="btn-salvar-abastecimento" class="modern-button"><i class="fas fa-save"></i> Salvar</button>
</div>
<div id="status-abastecimento" class="small" style="font-weight:bold; margin: -10px 0 0 0;"></div>
</div>
<div id="abastecimento-historico-card" class="glass-panel" style="width: 100%; max-width: 500px; padding: 20px;">
<h3 style="margin: 0 0 15px 0; color: var(--text-main); font-size: 1.1rem; text-align: left; border-bottom: 1px solid var(--text-sec); padding-bottom: 8px;">Histórico Recente</h3>
<ul id="lista-abastecimentos"></ul>
</div>
<div class="controls" style="display:flex; align-items: center; justify-content:center; gap:10px; margin-bottom: 5px; flex-wrap:wrap;">
<input type="month" id="mesAbastecimento">
<select id="filtroSemana" style="padding: 10px; border-radius: 8px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-main); font-family: 'Poppins', sans-serif;">
<option value="todas">Visão Mensal</option>
<option value="1">Semana 1 (1-7)</option>
<option value="2">Semana 2 (8-14)</option>
<option value="3">Semana 3 (15-21)</option>
<option value="4">Semana 4 (22+)</option>
</select>
<button id="btnAtualizarAbastecimento" class="modern-button" style="padding:10px 15px;"><i class="fas fa-sync-alt"></i></button>
</div>
<div class="chart-card glass-panel" style="width: 100%; max-width: 600px;">
<strong id="tituloGraficoAbastecimento">Comparativo Semanal (Litros)</strong>
<canvas id="chartAbastecimento"></canvas>
</div>
</div>
</div>

<div id="consumo-view" style="display:none;">
<img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
<header><h1><i class="fas fa-chart-bar" style="color: var(--accent);"></i> Consumo</h1></header>
<div class="controls" style="display:flex; align-items: center; justify-content:center; gap:10px; margin-bottom: 15px;">
<input type="date" id="dataEscolhidaConsumo" onchange="document.getElementById('dataEscolhida').value=this.value; document.getElementById('btnAtualizar').click();">
<button onclick="document.getElementById('btnAtualizar').click()" class="modern-button" style="padding:10px 15px;"><i class="fas fa-sync-alt"></i></button>
</div>
<div class="board"><div class="charts">
<div class="chart-card glass-panel" id="consumo-chart-card-bloco">
<strong>Consumo Estimado (Litros)</strong>
<canvas id="chartConsumoBloco"></canvas>
<div id="consumo-info-texto" style="margin-top: 15px; font-weight: 700; color: var(--accent); font-size: 1.1rem;"></div>
</div>
<div class="chart-card glass-panel" id="consumo-chart-card-linha">
<strong>Curva de Consumo</strong>
<canvas id="chartConsumoLinha"></canvas>
</div>
</div></div>
</div>

<div id="config-view" style="display:none;">
<img class="logo" src="https://viacristais.com.br/wp-content/uploads/2025/01/ViaCristais_compact_RGB-800x600.jpg" alt="Logo Via Cristais">
<h1><i class="fas fa-cog" style="color: var(--accent);"></i> Configurações</h1>
<div class="config-board">
<div class="config-card glass-panel"><h2>Capacidade (L)</h2><div class="form-group"><input type="number" id="capacidade-total-valor" placeholder="Ex: 8000" min="1000"><button id="btn-salvar-capacidade" class="modern-button"><i class="fas fa-check"></i></button></div><div id="status-capacidade" class="small" style="font-weight:bold;"></div></div>
<div class="config-card glass-panel"><h2>Altura (cm)</h2><div class="form-group"><input type="number" id="altura-caixa-valor" placeholder="Ex: 200" min="1"><button id="btn-salvar-altura" class="modern-button"><i class="fas fa-check"></i></button></div><div id="status-altura" class="small" style="font-weight:bold;"></div></div>
<div class="config-card glass-panel"><h2>Novo Contato</h2><div class="form-group"><input type="text" id="contato-valor" placeholder="Email ou Telegram"><select id="contato-tipo"><option value="email">Email</option><option value="telegram">Telegram</option></select><button id="btn-add-contato" class="modern-button"><i class="fas fa-plus"></i></button></div><div id="status-contato" class="small" style="font-weight:bold; margin-top: 10px;"></div></div>
<div class="config-card glass-panel"><h2>Nível Alerta (%)</h2><div class="form-group"><input type="number" id="nivel-alerta-valor" placeholder="Ex: 30" min="1" max="99"><button id="btn-salvar-nivel-alerta" class="modern-button"><i class="fas fa-check"></i></button></div><div id="status-alerta" class="small" style="font-weight:bold;"></div></div>
<div class="config-card glass-panel" style="grid-column: 1 / -1;"><h2>Contatos Cadastrados</h2><ul id="lista-contatos"></ul><div id="status-lista-contatos" class="small" style="font-weight:bold; margin-top: 10px;"></div></div>
</div>
</div>

<div id="alert-modal"><div class="modal-content"><div class="modal-header"><i class="fas fa-exclamation-triangle"></i> ALERTA DE NÍVEL BAIXO</div><div class="modal-body">Atenção: Solicitar abastecimento ao CCO. (Nível Crítico)</div><div class="modal-footer"><button id="modal-close-btn" class="modern-button">Entendido</button></div></div></div>

<div class="header-right" id="date-controls" style="display: none;">
<div class="view-selector">
<button id="btn-view-diario" class="view-btn active" data-view="diario">Hoje</button>
<button id="btn-view-semanal" class="view-btn" data-view="semanal" style="display:none;">Semanal</button>
<button id="btn-view-mensal" class="view-btn" data-view="mensal">Mês</button>
<button id="btn-view-intervalo" class="view-btn" data-view="intervalo">Período</button>
</div>
</div>

<script>
const DATABASE_URL = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";

// VARIAVEIS INJETADAS PELO DASHBOARD
const PATH_TEMPO_REAL = `${DATABASE_URL}__FIREBASE_DATA_PATH__`;
const PATH_CONFIG_BASE = `${DATABASE_URL}__FIREBASE_CONFIG_PATH__`;
const PATH_HISTORICO = `${DATABASE_URL}__FIREBASE_HIST_PATH__`;
const PATH_ABASTECIMENTO = `${PATH_CONFIG_BASE}/abastecimentos.json`;
const PATH_EMERGENCIA = `${PATH_CONFIG_BASE}/emergencia.json`;
const FORCE_LEVEL = __FORCE_LEVEL__; // -1 quando não usado

// CONTAS DE EMAIL ROTATIVAS
const CONTAS_EMAIL = [
  { id: 0, service: "service_lubx0i8", template: "template_ll79qy1", key: "I1HnvhgWehPP7EXxX", quota_inicial: 0, dia_reinicio: 18, mes_reinicio: 11 },
  { id: 1, service: "service_n365um4", template: "template_fjhnurn", key: "ivGT9BYMpO_IMpcJI", quota_inicial: 75, dia_reinicio: 25, mes_reinicio: 11 },
  { id: 2, service: "service_txwft9l", template: "template_c5l1j8r", key: "xwk898VhH0VS-PSg9", quota_inicial: 6, dia_reinicio: 30, mes_reinicio: 11 }
];

let isDarkMode = false;
window.toggleTheme = function(e) { if(e) { e.preventDefault(); e.stopPropagation(); } isDarkMode = !isDarkMode; applyTheme(); };

function checkAutoTheme() {
    try {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            isDarkMode = (savedTheme === 'dark');
            applyTheme();
            return;
        }
    } catch (e) {}
    const hora = new Date().getHours();
    isDarkMode = (hora >= 18 || hora < 6);
    applyTheme();
}

function applyTheme() {
    const body = document.body;
    const icon = document.querySelector('.nav-button-icon-only[title="Alternar Tema"] i');
    if (isDarkMode) {
        body.setAttribute('data-theme', 'dark');
        if(icon) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
        try { localStorage.setItem('theme', 'dark'); } catch(e){}
    } else {
        body.removeAttribute('data-theme');
        body.style.display='none'; body.offsetHeight; body.style.display='';
        if(icon) { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); }
        try { localStorage.setItem('theme', 'light'); } catch(e){}
    }
    criarGraficos();
    if(activeTab === 'grafico' || activeTab === 'consumo') carregarHistoricoEConsumo();
    if(activeTab === 'abastecimento') carregarHistoricoAbastecimento();
}

try {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') { isDarkMode = true; document.body.setAttribute('data-theme', 'dark'); }
} catch (e) {}

let chartLinha, chartBlocos, chartConsumoBloco, chartConsumoLinha, chartAbastecimento;
let currentView = 'diario';
let activeTab = 'caixa';
let nivelAtual = 0;
let nivelAlertaConfigurado = 30;
let capacidadeTotal = 8000;
let alturaCaixa = 0;
let alertaModalMostrado = false;
let emailEnviadoNessaSessao = false;
let alertaConfirmadoPeloUsuario = false;
let ultimoHorarioSalvo = -1;
let ultimoTempoSalvo = 0;
let audioContext, oscillator, gainNode, lfo, lfoGain;
let isAlarmPlaying = false;
let snoozeCount = 0, snoozeUntil = 0;
const SNOOZE_DURATION_MINUTES = 10;
const AUTO_SNOOZE_SECONDS = 30;
let lastUpdateTimestamp = 0;
let contadorZerosConsecutivos = 0;
let ultimasLeiturasValidas = []; // [{nivel,timestamp}] - sempre 3 últimas
let ultimaLeituraPersistidaTs = 0;

function calcularVolumeLitros(nivelPercentual) {
    if (nivelPercentual <= 0) return 0;
    if (nivelPercentual > 100) nivelPercentual = 100;
    return Math.floor((nivelPercentual / 100) * capacidadeTotal);
}

function getLocalISODate(dateObj) {
    const d = dateObj || new Date();
    const offset = d.getTimezoneOffset() * 60000;
    const localDate = new Date(d.getTime() - offset);
    return localDate.toISOString().split('T')[0];
}

function getNoCacheUrl(url) {
    const separator = url.includes('?') ? '&' : '?';
    return `${url}${separator}nocache=${Date.now()}_${Math.floor(Math.random() * 99999)}`;
}

async function safeFetch(url, options = {}) {
    const finalOptions = { ...options, cache: 'no-store' };
    try {
        const response = await fetch(getNoCacheUrl(url), finalOptions);
        if (!response.ok) throw new Error(response.statusText);
        return response;
    } catch(e) {
        console.warn("Fetch falhou:", url);
        return null;
    }
}

// ============================
// EMERGÊNCIA: 3 ÚLTIMAS LEITURAS + ESTIMATIVA
// ============================
function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

function calcularNivelEstimado(nivelBase, tsBase, agoraTs) {
    // Regra solicitada:
    // - acima de 30%: desce 5% a cada 6 horas até 30%
    // - de 30% até 20%: desce 5% a cada 4 horas
    // - abaixo de 20%: desce 1% a cada 2 horas até 1%
    if (!nivelBase || nivelBase <= 0 || !tsBase || !agoraTs) return null;

    let nivel = nivelBase;
    let t = tsBase;

    const step = (pctDrop, hours) => {
        const stepMs = hours * 60 * 60 * 1000;
        const elapsed = agoraTs - t;
        if (elapsed <= 0) return 0;
        const k = Math.floor(elapsed / stepMs);
        if (k <= 0) return 0;
        nivel -= k * pctDrop;
        t += k * stepMs;
        return k;
    };

    // Faixa 1: até 30
    if (nivel > 30) {
        // quantos steps de 5/6h cabem sem cruzar muito? vamos aplicar e depois "travar" em >=30.
        step(5, 6);
        if (nivel < 30) nivel = 30;
    }

    // Faixa 2: 30..20
    if (nivel > 20) {
        step(5, 4);
        if (nivel < 20) nivel = 20;
    }

    // Faixa 3: <20..1
    if (nivel > 1) {
        step(1, 2);
        if (nivel < 1) nivel = 1;
    }

    nivel = clamp(Math.round(nivel), 1, 100);
    return nivel;
}

async function carregarUltimasLeiturasValidas() {
    const r = await safeFetch(PATH_EMERGENCIA);
    if (!r) return;
    const data = await r.json();
    if (!data) return;
    if (Array.isArray(data.ultimas_validas)) {
        ultimasLeiturasValidas = data.ultimas_validas
            .filter(x => x && typeof x.nivel === 'number' && typeof x.timestamp === 'number')
            .sort((a,b) => a.timestamp - b.timestamp)
            .slice(-3);
    }
}

async function salvarUltimasLeiturasValidasFirebase() {
    try {
        const payload = {
            ultimas_validas: ultimasLeiturasValidas.slice(-3),
            updated_at: Date.now()
        };
        await fetch(PATH_EMERGENCIA, { method: 'PATCH', body: JSON.stringify(payload) });
    } catch (e) {}
}

async function registrarLeituraValida(nivel, ts) {
    if (!(typeof nivel === 'number') || nivel <= 0) return;
    if (!(typeof ts === 'number')) ts = Date.now();

    // evita escrita excessiva: só persiste se timestamp novo e pelo menos 30s da última persistência
    if (ts <= ultimaLeituraPersistidaTs) return;

    ultimasLeiturasValidas.push({ nivel: Math.round(nivel), timestamp: ts });
    ultimasLeiturasValidas = ultimasLeiturasValidas
        .filter(x => x && typeof x.nivel === 'number' && x.nivel > 0 && typeof x.timestamp === 'number')
        .sort((a,b) => a.timestamp - b.timestamp)
        .slice(-3);

    ultimaLeituraPersistidaTs = ts;
    // persistir (sempre mantendo 3)
    await salvarUltimasLeiturasValidasFirebase();
}

function obterBaseValida() {
    if (!ultimasLeiturasValidas || ultimasLeiturasValidas.length === 0) return null;
    const last = ultimasLeiturasValidas[ultimasLeiturasValidas.length - 1];
    if (!last || typeof last.nivel !== 'number' || typeof last.timestamp !== 'number') return null;
    return last;
}

// ============================
// EMAIL ALERTA (mantido)
// ============================
async function enviarEmailAlerta(nivel) {
    const urlTimestamp = `${PATH_CONFIG_BASE}/controle_email/ultimo_disparo_timestamp.json`;
    if (emailEnviadoNessaSessao) return false;

    try {
        const rTime = await safeFetch(urlTimestamp);
        if (rTime) {
            const ultimoDisparo = await rTime.json();
            const agora = Date.now();
            if (ultimoDisparo) {
                const diferenca = agora - ultimoDisparo;
                const horas12 = 12 * 60 * 60 * 1000;
                if (diferenca < horas12) return false;
            }
        }
    } catch (e) {}

    let contatos = {};
    try {
        const r = await safeFetch(`${PATH_CONFIG_BASE}/contatos.json`);
        if (r) contatos = await r.json();
        if (!contatos) return false;
    } catch (e) { return false; }

    const emailsParaEnviar = Object.values(contatos)
        .filter(c => c.tipo === 'email' && c.valor)
        .map(c => c.valor);

    if (emailsParaEnviar.length === 0) return false;

    let credenciais = null;
    const hoje = new Date();

    for (let conta of CONTAS_EMAIL) {
        let dataReinicio = new Date(hoje.getFullYear(), conta.mes_reinicio, conta.dia_reinicio);
        if (hoje >= dataReinicio && conta.quota_inicial < 200) {
            conta.quota_inicial = 200;
        }
        if (conta.quota_inicial >= emailsParaEnviar.length) {
            credenciais = conta;
            break;
        }
    }

    if (!credenciais) return false;

    let todosEnviadosComSucesso = true;

    for (const email of emailsParaEnviar) {
        const templateParams = { "%": nivel, "email": email };
        try {
            await emailjs.send(credenciais.service, credenciais.template, templateParams, credenciais.key);
        } catch (err) {
            todosEnviadosComSucesso = false;
        }
    }

    if (todosEnviadosComSucesso) {
        emailEnviadoNessaSessao = true;
        const agoraMs = Date.now();
        try { await fetch(urlTimestamp, { method: 'PUT', body: JSON.stringify(agoraMs) }); } catch(e) {}
    }

    return todosEnviadosComSucesso;
}

function mostrarAlertaModal() { document.getElementById('alert-modal').style.display = 'flex'; }
function fecharAlertaModal() { document.getElementById('alert-modal').style.display = 'none'; }
function confirmarAlerta() { fecharAlertaModal(); controlarAlarme(false); alertaModalMostrado = false; alertaConfirmadoPeloUsuario = true; }
function iniciarSoneca() { fecharAlertaModal(); controlarAlarme(false); alertaModalMostrado = false; snoozeCount++; if (snoozeCount < 3) { const snoozeMs = SNOOZE_DURATION_MINUTES * 60 * 1000; snoozeUntil = Date.now() + snoozeMs; } }

function setupAudio() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        oscillator = audioContext.createOscillator();
        gainNode = audioContext.createGain();
        lfo = audioContext.createOscillator();
        lfoGain = audioContext.createGain();
        lfo.type = 'sine';
        lfo.frequency.setValueAtTime(2, audioContext.currentTime);
        lfoGain.gain.setValueAtTime(400, audioContext.currentTime);
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        lfo.connect(lfoGain);
        lfoGain.connect(oscillator.frequency);
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        lfo.start();
        oscillator.start();
    } catch (e) {}
}

function controlarAlarme(play) {
    if (!audioContext) return;
    if (audioContext.state === 'suspended') audioContext.resume();
    if (play && !isAlarmPlaying) {
        gainNode.gain.setValueAtTime(0.25, audioContext.currentTime);
        isAlarmPlaying = true;
    } else if (!play && isAlarmPlaying) {
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        isAlarmPlaying = false;
    }
}

function atualizarCaixaDOM(nivel, simulated=false) {
    const aguaDiv = document.getElementById('agua');
    if(aguaDiv) {
        aguaDiv.style.height = nivel + '%';
        aguaDiv.innerText = nivel + '%';

        if (nivel > 60) aguaDiv.style.background = 'linear-gradient(to top, #00ffcc, #1e90ff)';
        else if (nivel > nivelAlertaConfigurado) aguaDiv.style.background = 'linear-gradient(to top, #ffff66, #ffcc00)';
        else aguaDiv.style.background = 'linear-gradient(to top, #ff3333, #990000)';
    }

    const ledVermelho = document.getElementById('led-vermelho');
    const ledAmarelo = document.getElementById('led-amarelo');
    const ledVerde = document.getElementById('led-verde');
    if(ledVermelho && ledAmarelo && ledVerde) {
        ledVermelho.classList.remove('aceso');
        ledAmarelo.classList.remove('aceso');
        ledVerde.classList.remove('aceso');

        if (nivel > 60) ledVerde.classList.add('aceso');
        else if (nivel > nivelAlertaConfigurado) ledAmarelo.classList.add('aceso');
        else ledVermelho.classList.add('aceso');
    }

    const txtNivel = document.getElementById('status-level');
    if(txtNivel) {
        txtNivel.innerText = nivel + '%';
        if (nivel > 60) txtNivel.style.color = 'var(--level-ok)';
        else if (nivel > nivelAlertaConfigurado) txtNivel.style.color = 'var(--level-warn)';
        else txtNivel.style.color = 'var(--level-danger)';
    }

    const simIndicator = document.getElementById('simulated-indicator');
    if(simIndicator) simIndicator.style.display = simulated ? 'inline-flex' : 'none';

    if(document.getElementById('status-litros'))
        document.getElementById('status-litros').innerHTML = `${calcularVolumeLitros(nivel)} <small>L</small>`;

    if(document.getElementById('status-time'))
        document.getElementById('status-time').innerText = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

function interpolacaoLinear(arr) {
    let filled = [...arr];
    let indices = [];
    for(let i = 0; i < filled.length; i++) if(filled[i] !== null) indices.push(i);
    if(indices.length === 0) return filled;

    for(let k = 0; k < indices.length - 1; k++) {
        let startIdx = indices[k];
        let endIdx = indices[k+1];
        let startVal = filled[startIdx];
        let endVal = filled[endIdx];
        let steps = endIdx - startIdx;

        if (endVal > startVal + 30) {
            for(let j = 1; j < steps; j++) filled[startIdx + j] = startVal;
        } else {
            for(let j = 1; j < steps; j++) {
                let val = startVal + (endVal - startVal) * (j / steps);
                filled[startIdx + j] = Math.round(val);
            }
        }
    }

    if(filled[0] === null) {
        let firstVal = filled[indices[0]];
        for(let i = 0; i < indices[0]; i++) filled[i] = firstVal;
    }

    return filled;
}

function criarGraficos() {
    Chart.register(ChartDataLabels);

    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';
    const textColor = isDark ? '#94a3b8' : '#64748b';

    const zoomOptions = {
        pan: { enabled: true, mode: 'x' },
        zoom: { wheel: { enabled: true, speed: 0.02 }, pinch: { enabled: true, sensitivity: 0.1 }, mode: 'x' }
    };

    const xAxisConfig = {
        ticks: { autoSkip: true, maxRotation: 0, minRotation: 0, maxTicksLimit: 6, color: textColor },
        grid: { display: true, color: gridColor }
    };

    if(document.getElementById('chartLinha')) {
        const ctxL = document.getElementById('chartLinha').getContext('2d');
        const gradL = ctxL.createLinearGradient(0, 0, 0, 300);
        gradL.addColorStop(0, isDark ? 'rgba(34, 211, 238, 0.4)' : 'rgba(6,182,212,0.4)');
        gradL.addColorStop(1, isDark ? 'rgba(34, 211, 238, 0.0)' : 'rgba(6,182,212,0.0)');
        if(chartLinha) chartLinha.destroy();
        chartLinha = new Chart(ctxL, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Nível (%)', data: [], fill: true, backgroundColor: gradL, borderColor: isDark ? '#22d3ee' : '#0891b2', tension: 0.3, pointRadius: 3, borderWidth: 3, spanGaps: true }] },
            options: { animation: false, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false }, zoom: zoomOptions }, scales: { x: xAxisConfig, y: { ticks: { color: textColor }, min: 0, max: 100, grid: { color: gridColor } } }, layout: { padding: { left: 10, right: 10, top: 10, bottom: 10 } } }
        });
    }

    if(document.getElementById('chartBlocos')) {
        const ctxB = document.getElementById('chartBlocos').getContext('2d');
        if(chartBlocos) chartBlocos.destroy();
        chartBlocos = new Chart(ctxB, {
            type: 'bar',
            data: { labels: [], datasets: [{ data: [], borderRadius: 4 }] },
            options: { animation: false, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false }, zoom: zoomOptions }, scales: { x: xAxisConfig, y: { ticks: { color: textColor }, min: 0, max: 100, grid: { color: gridColor } } }, layout: { padding: { left: 10, right: 10, top: 10, bottom: 10 } } }
        });
    }

    if(document.getElementById('chartConsumoBloco')) {
        const ctxCB = document.getElementById('chartConsumoBloco').getContext('2d');
        if(chartConsumoBloco) chartConsumoBloco.destroy();
        chartConsumoBloco = new Chart(ctxCB, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Litros', data: [], borderRadius: 6 }] },
            options: { animation: false, maintainAspectRatio: false, plugins: { legend: { display: false }, zoom: zoomOptions, datalabels: { color: textColor, anchor: 'end', align: 'top', formatter: Math.round, font: { size: 10 } } }, scales: { x: xAxisConfig, y: { ticks: { color: textColor }, min: 0, suggestedMax: 2000, grid: { color: gridColor } } }, layout: { padding: { top: 20 } } }
        });
    }

    if(document.getElementById('chartConsumoLinha')) {
        const ctxCL = document.getElementById('chartConsumoLinha').getContext('2d');
        if(chartConsumoLinha) chartConsumoLinha.destroy();
        chartConsumoLinha = new Chart(ctxCL, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Litros', data: [], fill: true, backgroundColor: isDark ? 'rgba(34, 211, 238, 0.2)' : 'rgba(6,182,212,0.2)', borderColor: isDark ? '#22d3ee' : '#0891b2', tension: 0.3, pointRadius: 3, borderWidth: 2 }] },
            options: { animation: false, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false }, zoom: zoomOptions }, scales: { x: xAxisConfig, y: { ticks: { color: textColor }, min: 0, suggestedMax: 3000, grid: { color: gridColor } } }, layout: { padding: { left: 10, right: 10, top: 10, bottom: 10 } } }
        });
    }

    if(document.getElementById('chartAbastecimento')) {
        const ctxA = document.getElementById('chartAbastecimento').getContext('2d');
        if(chartAbastecimento) chartAbastecimento.destroy();
        chartAbastecimento = new Chart(ctxA, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Entrada (L)', data: [], borderRadius: 4, backgroundColor: isDark ? 'rgba(34, 211, 238, 0.7)' : 'rgba(6,182,212,0.7)' }] },
            options: { animation: false, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: textColor, anchor: 'end', align: 'top' } }, scales: { x: { ticks: { color: textColor }, grid: { display: false } }, y: { ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true } } }
        });
    }
}

async function salvarLeituraNoFirebase(nivel, timestamp, tipo = 'real') {
    if (nivel === null || nivel === undefined) return;
    if (tipo === 'real' && nivel <= 0) return;

    const d = new Date(timestamp);
    const localDate = getLocalISODate(d);
    const horaKey = String(d.getHours()).padStart(2, '0');

    const url = `${PATH_HISTORICO}/${localDate}/${horaKey}.json`;
    const dados = { nivel_pct: nivel, timestamp: timestamp, tipo: tipo };

    try { await fetch(url, { method: 'PUT', body: JSON.stringify(dados) }); } catch (e) {}
}

function atualizarGraficosHistorico(result) {
    if (!chartLinha || !chartBlocos) return;
    if (!result || !result.labels) return;

    chartLinha.data.labels = result.labels;
    chartLinha.data.datasets[0].data = result.niveis;
    chartLinha.update();

    chartBlocos.data.labels = result.labels;
    chartBlocos.data.datasets[0].data = result.niveis;
    chartBlocos.data.datasets[0].backgroundColor = 'rgba(6, 182, 212, 0.85)';
    chartBlocos.update();
}

function atualizarGraficosConsumo(result) {
    if (!chartConsumoBloco || !chartConsumoLinha) return;
    if (!result || !result.consumo) return;

    const consumoData = result.consumo || [];
    const consumoLabels = result.labels || [];

    const infoTexto = document.getElementById('consumo-info-texto');
    if (infoTexto) {
        let totalConsumo = consumoData.reduce((a, b) => a + (b || 0), 0);
        let statusTexto = "Normal";
        let corStatus = "var(--accent)";
        if (totalConsumo > 3000) { statusTexto = "Alto"; corStatus = "var(--level-danger)"; }
        else if (totalConsumo < 500) { statusTexto = "Baixo"; corStatus = "var(--level-ok)"; }

        if (currentView === 'diario') infoTexto.innerHTML = `Consumo Atual: ${totalConsumo.toFixed(0)} L (<span style="color:${corStatus}">${statusTexto}</span>)`;
        else infoTexto.innerText = `Total no Período: ${totalConsumo.toFixed(0)} L`;
    }

    chartConsumoBloco.data.labels = consumoLabels;
    chartConsumoBloco.data.datasets[0].data = consumoData;
    chartConsumoBloco.update();

    chartConsumoLinha.data.labels = consumoLabels;
    chartConsumoLinha.data.datasets[0].data = consumoData;
    chartConsumoLinha.update();
}

// ============================
// CONSUMO: usa leituras + abastecimentos
// Regra: consumo (L) no intervalo = max(0, (Vprev + Entradas) - Vcurr)
// onde Entradas é a soma dos litros em abastecimentos com timestamp dentro do intervalo.
// ============================
async function carregarAbastecimentos() {
    const r = await safeFetch(PATH_ABASTECIMENTO);
    if (!r) return [];
    const dados = await r.json();
    if (!dados) return [];
    return Object.values(dados)
        .filter(x => x && typeof x.timestamp === 'number' && typeof x.litros === 'number')
        .map(x => ({ timestamp: x.timestamp, litros: x.litros }))
        .sort((a,b) => a.timestamp - b.timestamp);
}

function somarEntradasNoIntervalo(abastecimentos, t0, t1) {
    if (!Array.isArray(abastecimentos) || abastecimentos.length === 0) return 0;
    if (!t0 || !t1) return 0;
    const a = Math.min(t0, t1);
    const b = Math.max(t0, t1);
    let soma = 0;
    for (const ev of abastecimentos) {
        if (ev.timestamp > a && ev.timestamp <= b) soma += (ev.litros || 0);
        if (ev.timestamp > b) break;
    }
    return soma;
}

async function carregarHistoricoEConsumo() {
    if (currentView === 'semanal') return;

    let url = '';
    let processData;
    let result = { labels: [], niveis: [], consumo: [] };

    if (currentView === 'diario') {
        const dataEl = document.getElementById('dataEscolhida');
        if(!dataEl) return result;
        const data = dataEl.value;
        if (!data) return result;

        const dataParts = data.split('-');
        const dateObj = new Date(dataParts[0], dataParts[1] - 1, dataParts[2]);
        dateObj.setDate(dateObj.getDate() - 59);
        const dataIni = getLocalISODate(dateObj);

        url = `${PATH_HISTORICO}.json?orderBy=\"$key\"&startAt=\"${dataIni}\"&endAt=\"${data}\"`;

        processData = (historico, abastecimentos) => {
            const labels = [];
            const niveis = [];
            const consumo = [];
            const horasMap = {};
            const horasTs = {};

            if (historico) {
                for (const diaKey in historico) {
                    const dia = historico[diaKey];
                    if (!dia) continue;
                    for (const horaKey in dia) {
                        const leitura = dia[horaKey];
                        if (!leitura) continue;
                        const horaLabel = `${diaKey} ${horaKey}:00`;
                        horasMap[horaLabel] = leitura;

                        // timestamp de referência do ponto (preferência: leitura.timestamp)
                        let ts = (leitura && typeof leitura.timestamp === 'number') ? leitura.timestamp : null;
                        if (!ts) {
                            // fallback: monta um Date local a partir do dia/hora
                            const y = parseInt(diaKey.slice(0,4),10);
                            const m = parseInt(diaKey.slice(5,7),10)-1;
                            const d = parseInt(diaKey.slice(8,10),10);
                            const h = parseInt(horaKey,10);
                            ts = new Date(y,m,d,h,0,0,0).getTime();
                        }
                        horasTs[horaLabel] = ts;
                    }
                }
            }

            const horasOrdenadas = Object.keys(horasMap).sort();
            let lastNivel = null;
            let lastTs = null;

            horasOrdenadas.forEach((horaLabel) => {
                const leitura = horasMap[horaLabel];
                const nivel = (leitura && typeof leitura.nivel_pct === 'number') ? Math.round(leitura.nivel_pct) : null;
                const tsPonto = horasTs[horaLabel] || null;

                labels.push(horaLabel.substring(5, 16));

                // Série do histórico (nível)
                niveis.push(nivel);

                // Série de consumo: calcula em litros com entradas (abastecimento)
                if (nivel === null || lastNivel === null || !tsPonto || !lastTs) {
                    consumo.push(0);
                } else {
                    const vPrev = (lastNivel/100) * capacidadeTotal;
                    const vCurr = (nivel/100) * capacidadeTotal;
                    const entradas = somarEntradasNoIntervalo(abastecimentos, lastTs, tsPonto);
                    let c = (vPrev + entradas) - vCurr;
                    if (c < 0) c = 0;
                    consumo.push(Math.round(c));
                }

                if (nivel !== null) {
                    lastNivel = nivel;
                    lastTs = tsPonto;
                } else {
                    // mantém lastNivel/lastTs para não "zerar" consumo por buraco
                }
            });

            // Para o histórico, mantemos interpolação visual. Para consumo NÃO interpolamos (evita distorcer).
            result.labels = labels;
            result.niveis = interpolacaoLinear(niveis);
            result.consumo = consumo.map(x => (typeof x === 'number' && isFinite(x)) ? x : 0);
            return result;
        };

    } else if (currentView === 'mensal') {
        const mesEl = document.getElementById('mesEscolhido');
        if(!mesEl) return result;
        const mes = mesEl.value;
        if (!mes) return result;

        const startAt = `${mes}-01`;
        const endAt = `${mes}-31`;
        url = `${PATH_HISTORICO}.json?orderBy=\"$key\"&startAt=\"${startAt}\"&endAt=\"${endAt}\"`;

        processData = (historico, abastecimentos) => {
            const labels = [];
            const niveis = [];
            const consumo = [];
            const dias = Object.keys(historico || {}).sort();

            // Para cada dia, usa a última leitura do dia como nível do dia.
            const pontos = [];
            dias.forEach((diaKey) => {
                const dia = historico[diaKey];
                if (!dia) return;
                const horas = Object.keys(dia).sort();
                const ultimaHora = horas[horas.length - 1];
                const leitura = dia[ultimaHora];
                const nivel = (leitura && typeof leitura.nivel_pct === 'number') ? Math.round(leitura.nivel_pct) : null;

                let ts = (leitura && typeof leitura.timestamp === 'number') ? leitura.timestamp : null;
                if (!ts) {
                    const y = parseInt(diaKey.slice(0,4),10);
                    const m = parseInt(diaKey.slice(5,7),10)-1;
                    const d = parseInt(diaKey.slice(8,10),10);
                    const h = parseInt(ultimaHora,10);
                    ts = new Date(y,m,d,h,0,0,0).getTime();
                }

                pontos.push({ diaKey, nivel, ts });
            });

            pontos.sort((a,b) => (a.ts||0) - (b.ts||0));

            let last = null;
            for (const p of pontos) {
                labels.push(p.diaKey.substring(8, 10));
                niveis.push(p.nivel);

                if (!last || p.nivel === null || last.nivel === null || !p.ts || !last.ts) {
                    consumo.push(0);
                } else {
                    const vPrev = (last.nivel/100) * capacidadeTotal;
                    const vCurr = (p.nivel/100) * capacidadeTotal;
                    const entradas = somarEntradasNoIntervalo(abastecimentos, last.ts, p.ts);
                    let c = (vPrev + entradas) - vCurr;
                    if (c < 0) c = 0;
                    consumo.push(Math.round(c));
                }

                if (p.nivel !== null) last = p;
            }

            result.labels = labels;
            result.niveis = interpolacaoLinear(niveis);
            result.consumo = consumo.map(x => (typeof x === 'number' && isFinite(x)) ? x : 0);
            return result;
        };

    } else if (currentView === 'intervalo') {
        const iniEl = document.getElementById('dataInicio');
        const fimEl = document.getElementById('dataFim');
        if(!iniEl || !fimEl) return result;
        const startAt = iniEl.value;
        const endAt = fimEl.value;
        if(!startAt || !endAt) return result;

        url = `${PATH_HISTORICO}.json?orderBy=\"$key\"&startAt=\"${startAt}\"&endAt=\"${endAt}\"`;

        processData = (historico) => {
            const labels = [];
            const niveis = [];
            const consumo = [];

            const dias = Object.keys(historico || {}).sort();
            dias.forEach((diaKey) => {
                const dia = historico[diaKey];
                if (!dia) return;
                const horas = Object.keys(dia).sort();
                const ultimaHora = horas[horas.length - 1];
                const leitura = dia[ultimaHora];
                const nivel = (leitura && typeof leitura.nivel_pct === 'number') ? Math.round(leitura.nivel_pct) : null;
                labels.push(diaKey.substring(8, 10));
                niveis.push(nivel);
            });

            for(let i=0;i<niveis.length;i++) {
                if(i===0 || niveis[i]===null || niveis[i-1]===null) consumo.push(0);
                else {
                    let diff = niveis[i-1] - niveis[i];
                    if(diff<0) diff=0;
                    consumo.push(Math.round((diff/100) * capacidadeTotal));
                }
            }

            result.labels = labels;
            result.niveis = interpolacaoLinear(niveis);
            result.consumo = interpolacaoLinear(consumo);
            return result;
        };
    }

    const r = await safeFetch(url);
    if (!r) return result;
    const historico = await r.json();
    if (!historico) return result;

    // Abastecimentos entram no cálculo do consumo
    const abastecimentos = await carregarAbastecimentos();

    const processed = processData(historico, abastecimentos);
    atualizarGraficosHistorico(processed);
    atualizarGraficosConsumo(processed);
    return processed;
}

async function carregarConfiguracoesGerais() {
    try {
        const r = await safeFetch(`${PATH_CONFIG_BASE}/config.json`);
        if (!r) return;
        const cfg = await r.json();
        if (!cfg) return;
        if (typeof cfg.nivel_alerta === 'number') nivelAlertaConfigurado = cfg.nivel_alerta;
        if (typeof cfg.capacidade_total === 'number') capacidadeTotal = cfg.capacidade_total;
        if (typeof cfg.altura_caixa === 'number') alturaCaixa = cfg.altura_caixa;

        const elNivel = document.getElementById('nivel-alerta-valor');
        const elCap = document.getElementById('capacidade-total-valor');
        const elAlt = document.getElementById('altura-caixa-valor');
        if (elNivel) elNivel.value = nivelAlertaConfigurado;
        if (elCap) elCap.value = capacidadeTotal;
        if (elAlt) elAlt.value = alturaCaixa;
    } catch(e) {}
}

async function carregarListaContatos() {
    const ul = document.getElementById('lista-contatos');
    if(!ul) return;
    ul.innerHTML = '';

    try {
        const r = await safeFetch(`${PATH_CONFIG_BASE}/contatos.json`);
        if (!r) return;
        const contatos = await r.json();
        if (!contatos) return;

        Object.entries(contatos).forEach(([key, c]) => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${c.valor} <small>(${c.tipo})</small></span><button class="delete-abastecimento-btn" title="Excluir">×</button>`;
            li.querySelector('button').onclick = async () => {
                try { await fetch(`${PATH_CONFIG_BASE}/contatos/${key}.json`, { method: 'DELETE' }); carregarListaContatos(); } catch(e){}
            };
            ul.appendChild(li);
        });
    } catch(e){}
}

async function salvarConfigCampo(campo, valor) {
    const statusEl = { capacidade_total: document.getElementById('status-capacidade'), altura_caixa: document.getElementById('status-altura'), nivel_alerta: document.getElementById('status-alerta') }[campo];
    if(statusEl) statusEl.textContent = '';

    try {
        const body = {}; body[campo] = valor;
        await fetch(`${PATH_CONFIG_BASE}/config.json`, { method: 'PATCH', body: JSON.stringify(body) });
        if(statusEl) statusEl.textContent = 'Salvo!';
        setTimeout(() => { if(statusEl) statusEl.textContent = ''; }, 2000);
    } catch(e) {
        if(statusEl) statusEl.textContent = 'Erro ao salvar';
    }
}

async function adicionarContato(tipo, valor) {
    const statusEl = document.getElementById('status-contato');
    if(statusEl) statusEl.textContent = '';

    try {
        const novo = { tipo, valor };
        await fetch(`${PATH_CONFIG_BASE}/contatos.json`, { method: 'POST', body: JSON.stringify(novo) });
        if(statusEl) statusEl.textContent = 'Adicionado!';
        setTimeout(() => { if(statusEl) statusEl.textContent = ''; }, 2000);
        carregarListaContatos();
    } catch(e) {
        if(statusEl) statusEl.textContent = 'Erro ao adicionar';
    }
}

async function carregarHistoricoAbastecimento() {
    const ul = document.getElementById('lista-abastecimentos');
    if(!ul) return;
    ul.innerHTML = '';

    try {
        const r = await safeFetch(`${PATH_ABASTECIMENTO}`);
        if (!r) return;
        const dados = await r.json();
        if (!dados) return;

        const itens = Object.entries(dados)
            .map(([k,v]) => ({ key: k, ...v }))
            .sort((a,b) => (b.timestamp||0) - (a.timestamp||0))
            .slice(0, 20);

        itens.forEach(item => {
            const dt = item.timestamp ? new Date(item.timestamp).toLocaleString('pt-BR') : '';
            const li = document.createElement('li');
            li.innerHTML = `<span>${item.litros} L <small>${dt}</small></span><button class="delete-abastecimento-btn" title="Excluir">×</button>`;
            li.querySelector('button').onclick = async () => {
                try { await fetch(`${PATH_CONFIG_BASE}/abastecimentos/${item.key}.json`, { method: 'DELETE' }); carregarHistoricoAbastecimento(); } catch(e){}
            };
            ul.appendChild(li);
        });
    } catch(e) {}
}

async function salvarAbastecimento(litros) {
    const statusEl = document.getElementById('status-abastecimento');
    if(statusEl) statusEl.textContent = '';

    try {
        const entrada = { litros, timestamp: Date.now() };
        await fetch(`${PATH_CONFIG_BASE}/abastecimentos.json`, { method: 'POST', body: JSON.stringify(entrada) });
        if(statusEl) statusEl.textContent = 'Salvo!';
        setTimeout(() => { if(statusEl) statusEl.textContent = ''; }, 2000);
        carregarHistoricoAbastecimento();
    } catch(e) {
        if(statusEl) statusEl.textContent = 'Erro ao salvar';
    }
}

function switchView(view) {
    activeTab = view;
    document.getElementById('caixa-view').style.display = (view === 'caixa') ? 'block' : 'none';
    document.getElementById('grafico-container').style.display = (view === 'grafico') ? 'block' : 'none';
    document.getElementById('abastecimento-view').style.display = (view === 'abastecimento') ? 'block' : 'none';
    document.getElementById('consumo-view').style.display = (view === 'consumo') ? 'block' : 'none';
    document.getElementById('config-view').style.display = (view === 'config') ? 'block' : 'none';

    document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
    const map = { caixa: 'btn-view-caixa', grafico: 'btn-view-grafico', abastecimento: 'btn-view-abastecimento', consumo: 'btn-view-consumo', config: 'btn-view-config' };
    const btn = document.getElementById(map[view]);
    if(btn) btn.classList.add('active');

    document.getElementById('date-controls').style.display = (view === 'grafico' || view === 'consumo') ? 'flex' : 'none';

    if(view === 'abastecimento') { carregarHistoricoAbastecimento(); carregarGraficoAbastecimento(); }
    if(view === 'config') { carregarListaContatos(); }
    if(view === 'grafico' || view === 'consumo') {
        // Recria/ajusta gráficos APÓS a view ficar visível (Chart.js não renderiza bem quando o canvas está display:none)
        criarGraficos();
        setTimeout(() => {
            if(chartLinha) chartLinha.resize();
            if(chartBlocos) chartBlocos.resize();
            if(chartConsumoBloco) chartConsumoBloco.resize();
            if(chartConsumoLinha) chartConsumoLinha.resize();
            carregarHistoricoEConsumo();
        }, 80);
    }
}

async function loopDeAtualizacao() {
    lastUpdateTimestamp = Date.now();

    // MODO FIXO (PP07) - solicitado: fixar 20% no desenho
    if (typeof FORCE_LEVEL === 'number' && FORCE_LEVEL >= 0) {
        const fixed = Math.round(FORCE_LEVEL);
        const li = document.getElementById('live-indicator');
        if(li) { li.classList.remove('online'); li.classList.add('offline'); }
        atualizarCaixaDOM(fixed, true);
        // também salva histórico como estimado, para alimentar gráfico
        const ts = Date.now();
        const hora = new Date(ts).getHours();
        if(hora !== ultimoHorarioSalvo || (Date.now() - ultimoTempoSalvo) > 30*60*1000) {
            ultimoHorarioSalvo = hora;
            ultimoTempoSalvo = Date.now();
            salvarLeituraNoFirebase(fixed, ts, 'estimado');
        }
        return;
    }

    const r = await safeFetch(PATH_TEMPO_REAL);
    if(!r) {
        contadorZerosConsecutivos++;
        const li = document.getElementById('live-indicator');
        if(li) { li.classList.remove('online'); li.classList.add('offline'); }
        return;
    }

    const data = await r.json();
    if(!data) return;

    let nivelSensor = (typeof data.nivel_pct === 'number') ? Math.round(data.nivel_pct) : 0;
    let ts = (typeof data.timestamp === 'number') ? data.timestamp : Date.now();

    if(nivelSensor === 0) contadorZerosConsecutivos++;
    else contadorZerosConsecutivos = 0;

    // sempre registrar leituras válidas (>0)
    if(nivelSensor > 0) {
        await registrarLeituraValida(nivelSensor, ts);
    }

    let nivelExibido = nivelSensor;
    let simulated = false;

    // emergência se zeros consecutivos
    if(contadorZerosConsecutivos >= 3) {
        document.getElementById('emergency-badge').style.display = 'flex';
        const base = obterBaseValida();
        if(base) {
            const estimado = calcularNivelEstimado(base.nivel, base.timestamp, Date.now());
            if(typeof estimado === 'number') {
                nivelExibido = estimado;
                simulated = true;
            }
        }
    } else {
        document.getElementById('emergency-badge').style.display = 'none';
    }

    // online/offline indicator
    const li = document.getElementById('live-indicator');
    if(li) {
        if(contadorZerosConsecutivos >= 3) { li.classList.remove('online'); li.classList.add('offline'); }
        else { li.classList.remove('offline'); li.classList.add('online'); }
    }

    atualizarCaixaDOM(nivelExibido, simulated);

    // alerta
    if (nivelExibido > 0 && nivelExibido <= nivelAlertaConfigurado) {
        if (!alertaModalMostrado && !alertaConfirmadoPeloUsuario) {
            if (Date.now() < snoozeUntil) {
            } else {
                alertaModalMostrado = true;
                mostrarAlertaModal();
                controlarAlarme(true);
                setTimeout(() => { if (alertaModalMostrado) iniciarSoneca(); }, AUTO_SNOOZE_SECONDS * 1000);
                enviarEmailAlerta(nivelExibido);
            }
        }
    } else {
        alertaConfirmadoPeloUsuario = false;
    }

    // salvar histórico por hora (real ou estimado)
    const hora = new Date(ts).getHours();
    if(hora !== ultimoHorarioSalvo || (Date.now() - ultimoTempoSalvo) > 30*60*1000) {
        ultimoHorarioSalvo = hora;
        ultimoTempoSalvo = Date.now();
        const tipo = simulated ? 'estimado' : 'real';
        salvarLeituraNoFirebase(nivelExibido, ts, tipo);
    }
}

window.onload = async () => {
    setupAudio();
    checkAutoTheme();
    criarGraficos();

    // carregar buffer de emergência (3 últimas)
    await carregarUltimasLeiturasValidas();

    document.getElementById('btn-view-caixa').onclick = () => switchView('caixa');
    document.getElementById('btn-view-grafico').onclick = () => switchView('grafico');
    document.getElementById('btn-view-abastecimento').onclick = () => switchView('abastecimento');
    document.getElementById('btn-view-consumo').onclick = () => switchView('consumo');
    document.getElementById('btn-view-config').onclick = () => switchView('config');

    document.getElementById('modal-close-btn').onclick = confirmarAlerta;

    const hoje = new Date();
    const dataFim = getLocalISODate(hoje);
    const mesFim = dataFim.substring(0, 7);
    const dIni = new Date(hoje.getTime());
    dIni.setDate(dIni.getDate() - 59);
    const dataIni = getLocalISODate(dIni);

    document.getElementById('dataEscolhida').value = dataFim;
    document.getElementById('dataEscolhidaConsumo').value = dataFim;
    document.getElementById('mesEscolhido').value = mesFim;
    document.getElementById('dataInicio').value = dataIni;
    document.getElementById('dataFim').value = dataFim;

    const mesAb = document.getElementById('mesAbastecimento');
    if(mesAb) mesAb.value = mesFim;

    const btnAt = document.getElementById('btnAtualizar');
    btnAt.onclick = () => {
        if (activeTab === 'grafico' || activeTab === 'consumo') carregarHistoricoEConsumo();
    };

    document.getElementById('btn-salvar-capacidade').onclick = () => {
        const v = parseInt(document.getElementById('capacidade-total-valor').value, 10);
        if(!isNaN(v)) { capacidadeTotal = v; salvarConfigCampo('capacidade_total', v); }
    };

    document.getElementById('btn-salvar-altura').onclick = () => {
        const v = parseInt(document.getElementById('altura-caixa-valor').value, 10);
        if(!isNaN(v)) { alturaCaixa = v; salvarConfigCampo('altura_caixa', v); }
    };

    document.getElementById('btn-salvar-nivel-alerta').onclick = () => {
        const v = parseInt(document.getElementById('nivel-alerta-valor').value, 10);
        if(!isNaN(v)) { nivelAlertaConfigurado = v; salvarConfigCampo('nivel_alerta', v); }
    };

    document.getElementById('btn-add-contato').onclick = () => {
        const val = document.getElementById('contato-valor').value.trim();
        const tipo = document.getElementById('contato-tipo').value;
        if(val) adicionarContato(tipo, val);
        document.getElementById('contato-valor').value = '';
    };

    document.getElementById('btn-salvar-abastecimento').onclick = () => {
        const v = parseInt(document.getElementById('litros-abastecidos').value, 10);
        if(!isNaN(v) && v>0) salvarAbastecimento(v);
        document.getElementById('litros-abastecidos').value = '';
    };

    document.getElementById('btnAtualizarAbastecimento').onclick = () => carregarGraficoAbastecimento();

    // view selector
    document.querySelectorAll('.view-selector .view-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const parent = e.target.parentElement;
            parent.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');

            if (e.target.dataset.view) {
                currentView = e.target.dataset.view;
                const pickers = { diario: 'diario-picker', mensal: 'mensal-picker', intervalo: 'intervalo-picker' };
                for(const k in pickers) document.getElementById(pickers[k]).style.display = 'none';
                if (pickers[currentView]) document.getElementById(pickers[currentView]).style.display = 'flex';
                btnAt.click();
            }
        });
    });

    await carregarConfiguracoesGerais();
    await carregarHistoricoEConsumo();

    // loop
    loopDeAtualizacao();
    setInterval(loopDeAtualizacao, 2500);

    setInterval(() => {
        const now = Date.now();
        if (now - lastUpdateTimestamp > 10000) loopDeAtualizacao();
    }, 5000);

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') {
            loopDeAtualizacao();
            carregarHistoricoEConsumo();
        }
    });
};

async function carregarGraficoAbastecimento() {
    const mesInput = document.getElementById('mesAbastecimento');
    const filtroSemana = document.getElementById('filtroSemana');
    if(!mesInput || !filtroSemana) return;
    const mes = mesInput.value;
    if(!mes) return;
    const semana = filtroSemana.value;

    const r = await safeFetch(`${PATH_CONFIG_BASE}/abastecimentos.json`);
    if(!r) return;
    const dados = await r.json();
    if(!dados) return;

    const itens = Object.values(dados)
        .filter(x => x && x.timestamp)
        .map(x => ({ litros: x.litros || 0, timestamp: x.timestamp }))
        .filter(x => new Date(x.timestamp).toISOString().slice(0,7) === mes)
        .sort((a,b) => a.timestamp - b.timestamp);

    let labels = [];
    let valores = [];

    if(semana === 'todas') {
        const semanas = [0,0,0,0];
        itens.forEach(it => {
            const dia = new Date(it.timestamp).getDate();
            const idx = dia <= 7 ? 0 : dia <= 14 ? 1 : dia <= 21 ? 2 : 3;
            semanas[idx] += it.litros;
        });
        labels = ['Semana 1','Semana 2','Semana 3','Semana 4'];
        valores = semanas;
        const titulo = document.getElementById('tituloGraficoAbastecimento');
        if(titulo) titulo.innerText = 'Comparativo Semanal (Litros)';
    } else {
        const idx = parseInt(semana,10);
        const ini = idx===1?1:idx===2?8:idx===3?15:22;
        const fim = idx===1?7:idx===2?14:idx===3?21:31;
        const porDia = {};
        for(let d=ini; d<=fim; d++) porDia[d]=0;
        itens.forEach(it => {
            const dia = new Date(it.timestamp).getDate();
            if(dia>=ini && dia<=fim) porDia[dia] += it.litros;
        });
        labels = Object.keys(porDia).map(x => String(x).padStart(2,'0'));
        valores = Object.values(porDia);
        const titulo = document.getElementById('tituloGraficoAbastecimento');
        if(titulo) titulo.innerText = `Semana ${idx} (Litros por dia)`;
    }

    if(chartAbastecimento) {
        chartAbastecimento.data.labels = labels;
        chartAbastecimento.data.datasets[0].data = valores;
        chartAbastecimento.update();
    }
}

/* ===============================
   AJUSTES GLOBAIS – SINCRONIZAÇÃO REAL x EMERGÊNCIA
   Aplicado a TODOS os cards
   =============================== */

const FIREBASE_BASE = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";

async function salvarEstadoAtual(cardId, nivel, tipo) {
    const payload = {
        nivel_pct: nivel,
        tipo: tipo,
        timestamp: Date.now()
    };

    try {
        await fetch(`${FIREBASE_BASE}/${cardId}.json`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            },
            body: JSON.stringify(payload)
        });
    } catch(e) {
        console.warn("Falha ao salvar estado:", e);
    }
}

const isWebView = /wv|Android/i.test(navigator.userAgent);

async function atualizarImediato(cardId) {
    await loopDeAtualizacao(cardId);
}

function iniciarLoop(cardId) {
    atualizarImediato(cardId);
    setInterval(() => loopDeAtualizacao(cardId), isWebView ? 1200 : 2500);
}

</script>
</body>
</html>
</textarea>

<!-- ========================================================================= -->
<!-- SCRIPT DO DASHBOARD PRINCIPAL (E LÓGICA DE ABERTURA DOS APPS)             -->
<!-- ========================================================================= -->
<script>
const DB_BASE = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";

const listPP = [
    { id: 'pp1', name: 'PP 01', active: true, firebaseDataPath: '/PP1.json', firebaseConfigPath: '/PP1_config', firebaseHistPath: '/PP1_historico', title: 'Praça de Pedágio 01', forceLevel: -1 },
    { id: 'pp2', name: 'PP 02', active: true, firebaseDataPath: '/PP2.json', firebaseConfigPath: '/PP2_config', firebaseHistPath: '/PP2_historico', title: 'Praça de Pedágio 02', forceLevel: -1 },
    { id: 'pp3', name: 'PP 03', active: true, firebaseDataPath: '/PP3.json', firebaseConfigPath: '/PP3_config', firebaseHistPath: '/PP3_historico', title: 'Praça de Pedágio 03', forceLevel: -1 },
    { id: 'pp4', name: 'PP 04', active: true, firebaseDataPath: '/PP4.json', firebaseConfigPath: '/PP4_config', firebaseHistPath: '/PP4_historico', title: 'Praça de Pedágio 04', forceLevel: -1 },
    { id: 'pp5', name: 'PP 05', active: true, firebaseDataPath: '/PP5.json', firebaseConfigPath: '/PP5_config', firebaseHistPath: '/PP5_historico', title: 'Praça de Pedágio 05', forceLevel: -1 },
    { id: 'pp6', name: 'PP 06', active: true, firebaseDataPath: '/PP6.json', firebaseConfigPath: '/PP6_config', firebaseHistPath: '/PP6_historico', title: 'Praça de Pedágio 06', forceLevel: -1 },
    { id: 'pp7', name: 'PP 07', active: true, firebaseDataPath: '/PP7.json', firebaseConfigPath: '/PP7_config', firebaseHistPath: '/PP7_historico', title: 'Praça de Pedágio 07', forceLevel: 20 },
    { id: 'pp8', name: 'PP 08', active: true, firebaseDataPath: '/PP8.json', firebaseConfigPath: '/PP8_config', firebaseHistPath: '/PP8_historico', title: 'Praça de Pedágio 08', forceLevel: -1 },
    { id: 'pp9', name: 'PP 09', active: true, firebaseDataPath: '/PP9.json', firebaseConfigPath: '/PP9_config', firebaseHistPath: '/PP9_historico', title: 'Praça de Pedágio 09', forceLevel: -1 },
    { id: 'pp10', name: 'PP 10', active: true, firebaseDataPath: '/PP10.json', firebaseConfigPath: '/PP10_config', firebaseHistPath: '/PP10_historico', title: 'Praça de Pedágio 10', forceLevel: -1 },
];

const listSAU = [
    { id: 'sau1', name: 'SAU 01', active: true, firebaseDataPath: '/SAU1.json', firebaseConfigPath: '/SAU1_config', firebaseHistPath: '/SAU1_historico', title: 'Base SAU 01', forceLevel: -1 },
    { id: 'sau2', name: 'SAU 02', active: true, firebaseDataPath: '/SAU2.json', firebaseConfigPath: '/SAU2_config', firebaseHistPath: '/SAU2_historico', title: 'Base SAU 02', forceLevel: -1 },
    { id: 'sau3', name: 'SAU 03', active: true, firebaseDataPath: '/SAU3.json', firebaseConfigPath: '/SAU3_config', firebaseHistPath: '/SAU3_historico', title: 'Base SAU 03', forceLevel: -1 },
    { id: 'sau4', name: 'SAU 04', active: true, firebaseDataPath: '/SAU4.json', firebaseConfigPath: '/SAU4_config', firebaseHistPath: '/SAU4_historico', title: 'Base SAU 04', forceLevel: -1 },
    { id: 'sau5', name: 'SAU 05', active: true, firebaseDataPath: '/SAU5.json', firebaseConfigPath: '/SAU5_config', firebaseHistPath: '/SAU5_historico', title: 'Base SAU 05', forceLevel: -1 },
    { id: 'sau6', name: 'SAU 06', active: true, firebaseDataPath: '/SAU6.json', firebaseConfigPath: '/SAU6_config', firebaseHistPath: '/SAU6_historico', title: 'Base SAU 06', forceLevel: -1 },
    { id: 'sau7', name: 'SAU 07', active: true, firebaseDataPath: '/SAU7.json', firebaseConfigPath: '/SAU7_config', firebaseHistPath: '/SAU7_historico', title: 'Base SAU 07', forceLevel: -1 },
    { id: 'sau8', name: 'SAU 08', active: true, firebaseDataPath: '/SAU8.json', firebaseConfigPath: '/SAU8_config', firebaseHistPath: '/SAU8_historico', title: 'Base SAU 08', forceLevel: -1 },
    { id: 'sau9', name: 'SAU 09', active: true, firebaseDataPath: '/SAU9.json', firebaseConfigPath: '/SAU9_config', firebaseHistPath: '/SAU9_historico', title: 'Base SAU 09', forceLevel: -1 },
    { id: 'sau10', name: 'SAU 10', active: true, firebaseDataPath: '/SAU10.json', firebaseConfigPath: '/SAU10_config', firebaseHistPath: '/SAU10_historico', title: 'Base SAU 10', forceLevel: -1 },
    { id: 'sau11', name: 'SAU 11', active: true, firebaseDataPath: '/SAU11.json', firebaseConfigPath: '/SAU11_config', firebaseHistPath: '/SAU11_historico', title: 'Base SAU 11', forceLevel: -1 },
    { id: 'sau12', name: 'SAU 12', active: true, firebaseDataPath: '/SAU12.json', firebaseConfigPath: '/SAU12_config', firebaseHistPath: '/SAU12_historico', title: 'Base SAU 12', forceLevel: -1 },
    { id: 'sau13', name: 'SAU 13', active: true, firebaseDataPath: '/SAU13.json', firebaseConfigPath: '/SAU13_config', firebaseHistPath: '/SAU13_historico', title: 'Base SAU 13', forceLevel: -1 },
    { id: 'sau14', name: 'SAU 14', active: true, firebaseDataPath: '/SAU14.json', firebaseConfigPath: '/SAU14_config', firebaseHistPath: '/SAU14_historico', title: 'Base SAU 14', forceLevel: -1 },
    { id: 'sau15', name: 'SAU 15', active: true, firebaseDataPath: '/SAU15.json', firebaseConfigPath: '/SAU15_config', firebaseHistPath: '/SAU15_historico', title: 'Base SAU 15', forceLevel: -1 },
    { id: 'sau16', name: 'SAU 16', active: true, firebaseDataPath: '/SAU16.json', firebaseConfigPath: '/SAU16_config', firebaseHistPath: '/SAU16_historico', title: 'Base SAU 16', forceLevel: -1 },
    { id: 'sau17', name: 'SAU 17', active: true, firebaseDataPath: '/SAU17.json', firebaseConfigPath: '/SAU17_config', firebaseHistPath: '/SAU17_historico', title: 'Base SAU 17', forceLevel: -1 },
    { id: 'sau18', name: 'SAU 18', active: true, firebaseDataPath: '/SAU18.json', firebaseConfigPath: '/SAU18_config', firebaseHistPath: '/SAU18_historico', title: 'Base SAU 18', forceLevel: -1 },
    { id: 'sau19', name: 'SAU 19', active: true, firebaseDataPath: '/SAU19.json', firebaseConfigPath: '/SAU19_config', firebaseHistPath: '/SAU19_historico', title: 'Base SAU 19', forceLevel: -1 },
    { id: 'sau20', name: 'SAU 20', active: true, firebaseDataPath: '/SAU20.json', firebaseConfigPath: '/SAU20_config', firebaseHistPath: '/SAU20_historico', title: 'Base SAU 20', forceLevel: -1 }
];

function renderGrid(containerId, list, iconClass) {
    const grid = document.getElementById(containerId);
    if (!grid) return;
    grid.innerHTML = '';

    list.forEach(item => {
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'card' + (item.active ? '' : ' inactive');
        a.dataset.id = item.id;
        a.dataset.status = 'offline';

        a.innerHTML = `
            <div class="card-water-bg"></div>
            <div class="simulated-badge" title="Leitura Estimada">?</div>
            <div class="live-dot"></div>
            <div class="card-content">
                <div class="card-icon"><i class="${iconClass}"></i></div>
                <div class="card-title">${item.name}</div>
                <div class="card-level">--%</div>
                <div class="card-status">Aguardando...</div>
            </div>
        `;

        a.addEventListener('click', (e) => {
            e.preventDefault();
            if (!item.active) return;
            abrirApp(item);
        });

        grid.appendChild(a);
    });
}

async function fetchJson(url) {
    try {
        const r = await fetch(url + `?nocache=${Date.now()}_${Math.random()}`);
        if (!r.ok) return null;
        return await r.json();
    } catch (e) {
        return null;
    }
}

function setCardStatus(card, status, nivel, detalhe, isSimulated = false) {
    card.dataset.status = status;
    card.querySelector('.card-level').textContent = (nivel === null || nivel === undefined) ? '--%' : `${nivel}%`;
    card.querySelector('.card-status').textContent = detalhe || '';

    const water = card.querySelector('.card-water-bg');
    if (water && typeof nivel === 'number') {
        water.style.height = Math.max(0, Math.min(100, nivel)) + '%';
    }

    const dot = card.querySelector('.live-dot');
    if (dot) dot.style.display = (status === 'ok') ? 'block' : 'none';

    const badge = card.querySelector('.simulated-badge');
    if (badge) badge.style.display = isSimulated ? 'flex' : 'none';
}

async function updateDashboardData() {
    const allCards = document.querySelectorAll('.card');

    for (const card of allCards) {
        if (card.classList.contains('inactive')) continue;

        const id = card.dataset.id;
        const item = [...listPP, ...listSAU].find(x => x.id === id);
        if (!item) continue;

        // FIXO PP07 (20%) no dashboard
        if (typeof item.forceLevel === 'number' && item.forceLevel >= 0) {
            setCardStatus(card, 'simulated', item.forceLevel, 'Emergencial', true);
            continue;
        }

        const data = await fetchJson(DB_BASE + item.firebaseDataPath);
        if (!data) { setCardStatus(card, 'offline', null, 'Sem sinal'); continue; }

        let nivel = (typeof data.nivel_pct === 'number') ? Math.round(data.nivel_pct) : null;
        let tipo = data.tipo || 'real';
        let ts = data.timestamp || null;

        if (nivel === null) { setCardStatus(card, 'offline', null, 'Dados inválidos'); continue; }

        let status = 'ok';
        if (nivel <= 30) status = 'danger';
        else if (nivel <= 60) status = 'warn';

        const isSimulated = (tipo === 'estimado' || tipo === 'simulado');
        if (isSimulated) status = 'simulated';

        const detalhe = ts ? new Date(ts).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'Atualizado';
        setCardStatus(card, status, nivel, detalhe, isSimulated);
    }
}

function toggleTheme() {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    if (isDark) document.body.removeAttribute('data-theme');
    else document.body.setAttribute('data-theme', 'dark');
}

function abrirApp(item) {
    const overlay = document.getElementById('app-overlay');
    const frame = document.getElementById('app-frame');
    const template = document.getElementById('app-template').value;

    const html = template
        .replace(/__APP_TITLE__/g, item.title)
        .replace(/__FIREBASE_DATA_PATH__/g, item.firebaseDataPath)
        .replace(/__FIREBASE_CONFIG_PATH__/g, item.firebaseConfigPath)
        .replace(/__FIREBASE_HIST_PATH__/g, item.firebaseHistPath)
        .replace(/__FORCE_LEVEL__/g, String((typeof item.forceLevel === 'number') ? item.forceLevel : -1));

    overlay.classList.add('active');

    // Força recarregamento do srcdoc (evita manter a versão anterior em alguns browsers)
    frame.srcdoc = '';
    requestAnimationFrame(() => { frame.srcdoc = html; });
}

function fecharApp() {
    const overlay = document.getElementById('app-overlay');
    const frame = document.getElementById('app-frame');
    overlay.classList.remove('active');
    frame.srcdoc = '';
}

window.fecharApp = fecharApp;

renderGrid('grid-pp', listPP, 'fas fa-road');
renderGrid('grid-sau', listSAU, 'fas fa-warehouse');
updateDashboardData();
setInterval(updateDashboardData, 5000);

/* ===============================
   AJUSTES GLOBAIS – SINCRONIZAÇÃO REAL x EMERGÊNCIA
   Aplicado a TODOS os cards
   =============================== */

const FIREBASE_BASE = "https://monitoramento-caixa-d-agua-default-rtdb.firebaseio.com";

async function salvarEstadoAtual(cardId, nivel, tipo) {
    const payload = {
        nivel_pct: nivel,
        tipo: tipo,
        timestamp: Date.now()
    };

    try {
        await fetch(`${FIREBASE_BASE}/${cardId}.json`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            },
            body: JSON.stringify(payload)
        });
    } catch(e) {
        console.warn("Falha ao salvar estado:", e);
    }
}

const isWebView = /wv|Android/i.test(navigator.userAgent);

async function atualizarImediato(cardId) {
    await loopDeAtualizacao(cardId);
}

function iniciarLoop(cardId) {
    atualizarImediato(cardId);
    setInterval(() => loopDeAtualizacao(cardId), isWebView ? 1200 : 2500);
}

</script>
</body>
</html>
